<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="lair-include" content="lair.css">
    <meta name="capabilities" content="dex_swap">
    <meta name="aspect-ratio" content="3/4">
    <meta name="lair-icon" content="swap_calls">
    <meta name="lair-perms" content="network" />
    <title>Swap</title>
    <style>
        :root {
            --col-bg1: #101010;
            --col-bg2: #171717;
            --col-bg3: #222222;
            --col-txt1: white;
            --col-txt2: #aaa;
            --colors-accent: rgb(97, 121, 255);
            --col-good: #5be45b;
            --col-bad: #d44343;
            --siz-radius1: 0.5em;
            --siz-radius2: 0.375em;
            --font-size-small: 0.75em;
            --swap-pink: #ff007a;
            --swap-pink-hover: #ff3399;
        }

        html { height: 100%; }

        body {
            margin: 0;
            height: 100%;
            background: var(--col-bg1);
            color: var(--col-txt1);
            font-family: inherit;
            overflow-y: auto;
        }

        * { box-sizing: border-box; }

        .app {
            max-width: 420px;
            margin: 2rem auto;
            padding: 0 0.75em;
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75em;
        }

        .header h1 {
            font-size: 1.1em;
            font-weight: 600;
            margin: 0;
        }

        .settings-btn {
            background: none;
            border: none;
            color: var(--col-txt2);
            font-size: 1.2em;
            cursor: pointer;
            padding: 0.25em;
            border-radius: 50%;
            transition: color 0.2s, background 0.2s;
            line-height: 1;
        }

        .settings-btn:hover {
            color: var(--col-txt1);
            background: var(--col-bg3);
        }

        /* Settings Panel */
        .settings-panel {
            display: none;
            background: var(--col-bg2);
            border: 1px solid var(--col-bg3);
            border-radius: var(--siz-radius1);
            padding: 0.75em;
            margin-bottom: 0.5em;
        }

        .settings-panel.open { display: block; }

        .settings-label {
            font-size: var(--font-size-small);
            color: var(--col-txt2);
            margin-bottom: 0.4em;
            font-weight: 500;
        }

        .slippage-options {
            display: flex;
            gap: 0.35em;
        }

        .slippage-btn {
            flex: 1;
            padding: 0.4em 0.5em;
            border-radius: var(--siz-radius2);
            border: 1px solid var(--col-bg3);
            background: var(--col-bg3);
            color: var(--col-txt2);
            font-size: 0.8em;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }

        .slippage-btn.active {
            background: var(--colors-accent);
            border-color: var(--colors-accent);
            color: var(--col-txt1);
            font-weight: 600;
        }

        .slippage-btn:hover:not(.active) {
            border-color: var(--col-txt2);
            color: var(--col-txt1);
        }

        .custom-slip {
            width: 64px;
            padding: 0.4em 0.4em;
            border-radius: var(--siz-radius2);
            border: 1px solid var(--col-bg3);
            background: var(--col-bg3);
            color: var(--col-txt1);
            font-size: 0.8em;
            text-align: center;
            outline: none;
        }

        .custom-slip::placeholder { color: var(--col-txt2); }
        .custom-slip:focus { border-color: var(--colors-accent); }

        /* Swap Card */
        .swap-card {
            background: var(--col-bg2);
            border: 1px solid var(--col-bg3);
            border-radius: var(--siz-radius1);
            padding: 0;
            position: relative;
        }

        /* Token Input Field */
        .token-field {
            padding: 0.75em;
            position: relative;
        }

        .token-field-label {
            font-size: var(--font-size-small);
            color: var(--col-txt2);
            margin-bottom: 0.4em;
        }

        .token-row {
            display: flex;
            align-items: center;
            gap: 0.5em;
        }

        .amount-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--col-txt1);
            font-size: 1.6em;
            font-weight: 500;
            outline: none;
            min-width: 0;
            font-family: inherit;
        }

        .amount-input::placeholder { color: #444; }

        .amount-input.receive {
            color: var(--col-txt2);
        }

        .token-selector {
            display: flex;
            align-items: center;
            gap: 0.35em;
            padding: 0.35em 0.6em;
            background: var(--col-bg3);
            border: none;
            border-radius: 1em;
            color: var(--col-txt1);
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
            font-family: inherit;
        }

        .token-selector:hover { background: #333; }

        .token-icon {
            font-size: 1.1em;
            line-height: 1;
        }

        .token-arrow { font-size: 0.65em; color: var(--col-txt2); }

        .balance-row {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-small);
            color: var(--col-txt2);
            margin-top: 0.3em;
        }

        /* Swap direction button */
        .swap-direction {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid var(--col-bg1);
            background: var(--col-bg3);
            color: var(--col-txt1);
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, background 0.15s;
        }

        .swap-direction:hover {
            background: var(--col-bg2);
            transform: translate(-50%, -50%) rotate(180deg);
        }

        .swap-divider {
            position: relative;
            height: 1px;
            background: var(--col-bg3);
        }

        /* Rate Info */
        .rate-info {
            padding: 0.5em 0.75em;
            display: flex;
            flex-direction: column;
            gap: 0.25em;
        }

        .rate-row {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-small);
            color: var(--col-txt2);
        }

        .rate-row .value { color: var(--col-txt1); font-weight: 500; }
        .rate-row .value.good { color: var(--col-good); }
        .rate-row .value.warn { color: #f0a030; }
        .rate-row .value.bad { color: var(--col-bad); }

        /* Connect Button */
        .swap-btn {
            width: 100%;
            padding: 0.9em;
            margin-top: 0.5em;
            border: none;
            border-radius: var(--siz-radius1);
            background: var(--colors-accent);
            color: white;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s, opacity 0.15s;
            font-family: inherit;
        }

        .swap-btn:hover { filter: brightness(1.1); }

        .swap-btn.loading {
            opacity: 0.7;
            cursor: default;
        }

        .swap-btn.disabled {
            background: var(--col-bg3);
            color: var(--col-txt2);
            cursor: default;
        }

        /* Token Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            justify-content: center;
            align-items: flex-start;
            padding-top: 10vh;
        }

        .modal-overlay.open { display: flex; }

        .modal {
            background: var(--col-bg2);
            border: 1px solid var(--col-bg3);
            border-radius: var(--siz-radius1);
            width: 90%;
            max-width: 380px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            animation: modalIn 0.2s ease;
        }

        @keyframes modalIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75em;
            border-bottom: 1px solid var(--col-bg3);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1em;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--col-txt2);
            font-size: 1.2em;
            cursor: pointer;
            padding: 0.2em;
            line-height: 1;
        }

        .modal-close:hover { color: var(--col-txt1); }

        .modal-search {
            margin: 0.5em 0.75em;
            padding: 0.5em 0.75em;
            background: var(--col-bg3);
            border: 1px solid transparent;
            border-radius: var(--siz-radius1);
            color: var(--col-txt1);
            font-size: 0.85em;
            outline: none;
            font-family: inherit;
        }

        .modal-search::placeholder { color: var(--col-txt2); }
        .modal-search:focus { border-color: var(--colors-accent); }

        .token-list {
            overflow-y: auto;
            padding: 0.25em 0;
        }

        .token-item {
            display: flex;
            align-items: center;
            gap: 0.6em;
            padding: 0.6em 0.75em;
            cursor: pointer;
            transition: background 0.1s;
        }

        .token-item:hover { background: var(--col-bg3); }

        .token-item.disabled {
            opacity: 0.35;
            cursor: default;
        }

        .token-item .icon {
            font-size: 1.5em;
            width: 1.5em;
            text-align: center;
            line-height: 1;
        }

        .token-item-info {
            display: flex;
            flex-direction: column;
        }

        .token-item-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .token-item-full {
            font-size: var(--font-size-small);
            color: var(--col-txt2);
        }

        .token-item-price {
            margin-left: auto;
            font-size: 0.8em;
            color: var(--col-txt2);
        }

        /* Status dot */
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.3em;
        }

        .status-dot.live { background: var(--col-good); }
        .status-dot.error { background: var(--col-bad); }
        .status-dot.loading { background: #f0a030; }

        .status-text {
            font-size: var(--font-size-small);
            color: var(--col-txt2);
            display: flex;
            align-items: center;
        }

        /* Loading shimmer */
        @keyframes shimmer {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .loading-text {
            animation: shimmer 1.5s infinite;
            color: var(--col-txt2);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header">
            <h1>Swap</h1>
            <div style="display:flex;align-items:center;gap:0.5em;">
                <span class="status-text"><span class="status-dot loading" id="statusDot"></span><span id="statusLabel">Loading...</span></span>
                <button class="settings-btn" id="settingsToggle" title="Settings">âš™</button>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-label">Slippage Tolerance</div>
            <div class="slippage-options">
                <button class="slippage-btn" data-slip="0.1">0.1%</button>
                <button class="slippage-btn active" data-slip="0.5">0.5%</button>
                <button class="slippage-btn" data-slip="1">1%</button>
                <input type="text" class="custom-slip" id="customSlip" placeholder="Custom" maxlength="5">
            </div>
        </div>

        <!-- Swap Card -->
        <div class="swap-card">
            <!-- You Pay -->
            <div class="token-field" id="payField">
                <div class="token-field-label">You Pay</div>
                <div class="token-row">
                    <input type="text" class="amount-input" id="payAmount" placeholder="0" inputmode="decimal" autocomplete="off">
                    <button class="token-selector" id="paySelector">
                        <span class="token-icon" id="payIcon">Îž</span>
                        <span id="paySymbol">ETH</span>
                        <span class="token-arrow">â–¼</span>
                    </button>
                </div>
                <div class="balance-row">
                    <span id="payUsd"></span>
                    <span></span>
                </div>
            </div>

            <!-- Divider + Swap Button -->
            <div class="swap-divider">
                <button class="swap-direction" id="swapDir" title="Switch tokens">â†“</button>
            </div>

            <!-- You Receive -->
            <div class="token-field" id="receiveField">
                <div class="token-field-label">You Receive</div>
                <div class="token-row">
                    <input type="text" class="amount-input receive" id="receiveAmount" placeholder="0" readonly>
                    <button class="token-selector" id="receiveSelector">
                        <span class="token-icon" id="receiveIcon">â—ˆ</span>
                        <span id="receiveSymbol">USDC</span>
                        <span class="token-arrow">â–¼</span>
                    </button>
                </div>
                <div class="balance-row">
                    <span id="receiveUsd"></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Rate Info -->
        <div class="rate-info" id="rateInfo" style="display:none;">
            <div class="rate-row">
                <span>Rate</span>
                <span class="value" id="rateDisplay">â€”</span>
            </div>
            <div class="rate-row">
                <span>Price Impact</span>
                <span class="value" id="impactDisplay">â€”</span>
            </div>
            <div class="rate-row">
                <span>Est. Gas</span>
                <span class="value" id="gasDisplay">~$2.50</span>
            </div>
            <div class="rate-row">
                <span>Slippage</span>
                <span class="value" id="slipDisplay">0.5%</span>
            </div>
        </div>

        <!-- Action Button -->
        <button class="swap-btn" id="actionBtn">Connect Wallet</button>
    </div>

    <!-- Token Selector Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Select Token</h2>
                <button class="modal-close" id="modalClose">âœ•</button>
            </div>
            <input type="text" class="modal-search" id="modalSearch" placeholder="Search by name or symbol...">
            <div class="token-list" id="tokenList"></div>
        </div>
    </div>

    <script>
        const fetchFn = window.cfetch || fetch;
        // --- Token Config ---
        const TOKENS = [
            { symbol: 'ETH',  name: 'Ethereum',  icon: 'Îž',  cgId: 'ethereum' },
            { symbol: 'USDC', name: 'USD Coin',   icon: 'â—ˆ',  cgId: 'usd-coin' },
            { symbol: 'USDT', name: 'Tether',     icon: 'â‚®',  cgId: 'tether' },
            { symbol: 'DAI',  name: 'Dai',        icon: 'â—†',  cgId: 'dai' },
            { symbol: 'WBTC', name: 'Wrapped BTC',icon: 'â‚¿',  cgId: 'wrapped-bitcoin' },
            { symbol: 'LINK', name: 'Chainlink',  icon: 'â¬¡',  cgId: 'chainlink' },
            { symbol: 'UNI',  name: 'Uniswap',    icon: 'ðŸ¦„', cgId: 'uniswap' },
            { symbol: 'AAVE', name: 'Aave',       icon: 'ðŸ‘»', cgId: 'aave' },
            { symbol: 'MON',  name: 'Monad',      icon: 'â“‚',  cgId: 'monad' },
        ];

        // --- State ---
        let prices = {};
        let payToken = null;
        let receiveToken = null;
        let slippage = 0.5;
        let selectingFor = 'pay'; // 'pay' or 'receive'
        let priceStatus = 'loading'; // 'live', 'error', 'loading'

        // --- DOM refs ---
        const $payAmount = document.getElementById('payAmount');
        const $receiveAmount = document.getElementById('receiveAmount');
        const $payIcon = document.getElementById('payIcon');
        const $paySymbol = document.getElementById('paySymbol');
        const $receiveIcon = document.getElementById('receiveIcon');
        const $receiveSymbol = document.getElementById('receiveSymbol');
        const $payUsd = document.getElementById('payUsd');
        const $receiveUsd = document.getElementById('receiveUsd');
        const $rateInfo = document.getElementById('rateInfo');
        const $rateDisplay = document.getElementById('rateDisplay');
        const $impactDisplay = document.getElementById('impactDisplay');
        const $gasDisplay = document.getElementById('gasDisplay');
        const $slipDisplay = document.getElementById('slipDisplay');
        const $actionBtn = document.getElementById('actionBtn');
        const $statusDot = document.getElementById('statusDot');
        const $statusLabel = document.getElementById('statusLabel');
        const $modalOverlay = document.getElementById('modalOverlay');
        const $modalSearch = document.getElementById('modalSearch');
        const $tokenList = document.getElementById('tokenList');
        const $settingsPanel = document.getElementById('settingsPanel');
        const $customSlip = document.getElementById('customSlip');

        // --- Init ---
        function init() {
            loadSavedPair();
            updateTokenDisplay();
            fetchPrices();
            setInterval(fetchPrices, 30000);

            $payAmount.addEventListener('input', onPayInput);
            document.getElementById('paySelector').addEventListener('click', () => openModal('pay'));
            document.getElementById('receiveSelector').addEventListener('click', () => openModal('receive'));
            document.getElementById('swapDir').addEventListener('click', swapTokens);
            document.getElementById('settingsToggle').addEventListener('click', toggleSettings);
            document.getElementById('modalClose').addEventListener('click', closeModal);
            $modalOverlay.addEventListener('click', e => { if (e.target === $modalOverlay) closeModal(); });
            $modalSearch.addEventListener('input', renderTokenList);

            // Slippage buttons
            document.querySelectorAll('.slippage-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = parseFloat(btn.dataset.slip);
                    setSlippage(val);
                    $customSlip.value = '';
                });
            });

            $customSlip.addEventListener('input', () => {
                const val = parseFloat($customSlip.value);
                if (!isNaN(val) && val > 0 && val <= 50) {
                    setSlippage(val);
                    document.querySelectorAll('.slippage-btn').forEach(b => b.classList.remove('active'));
                }
            });

            // Only allow numbers and decimals in pay input
            $payAmount.addEventListener('keydown', e => {
                if (e.key.length === 1 && !/[\d.]/.test(e.key) && !e.metaKey && !e.ctrlKey) {
                    e.preventDefault();
                }
                if (e.key === '.' && $payAmount.value.includes('.')) {
                    e.preventDefault();
                }
            });
        }

        // --- Price Fetching ---
        async function fetchPrices() {
            setStatus('loading');
            const ids = TOKENS.map(t => t.cgId).filter(id => id !== 'monad').join(',');
            try {
                const resp = await fetchFn(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
                if (!resp.ok) throw new Error('API error');
                const data = await resp.json();
                for (const t of TOKENS) {
                    if (t.cgId === 'monad') {
                        // MON not on CoinGecko yet â€” estimate
                        prices[t.symbol] = 2.50;
                    } else if (data[t.cgId] && data[t.cgId].usd) {
                        prices[t.symbol] = data[t.cgId].usd;
                    }
                }
                setStatus('live');
            } catch (e) {
                // Fallback prices
                if (Object.keys(prices).length === 0) {
                    prices = {
                        ETH: 3450, USDC: 1, USDT: 1, DAI: 1,
                        WBTC: 97500, LINK: 18.50, UNI: 12.30,
                        AAVE: 285, MON: 2.50
                    };
                }
                setStatus('error');
            }
            recalculate();
        }

        function setStatus(s) {
            priceStatus = s;
            $statusDot.className = 'status-dot ' + s;
            if (s === 'live') $statusLabel.textContent = 'Live';
            else if (s === 'error') $statusLabel.textContent = 'Cached';
            else $statusLabel.textContent = 'Loading...';
        }

        // --- Pair persistence ---
        function loadSavedPair() {
            try {
                const saved = JSON.parse(localStorage.getItem('lair_swap_pair'));
                if (saved) {
                    payToken = TOKENS.find(t => t.symbol === saved.pay) || TOKENS[0];
                    receiveToken = TOKENS.find(t => t.symbol === saved.receive) || TOKENS[1];
                    if (payToken === receiveToken) receiveToken = TOKENS[payToken === TOKENS[0] ? 1 : 0];
                    return;
                }
            } catch(e) {}
            payToken = TOKENS[0];
            receiveToken = TOKENS[1];
        }

        function savePair() {
            try {
                localStorage.setItem('lair_swap_pair', JSON.stringify({
                    pay: payToken.symbol,
                    receive: receiveToken.symbol
                }));
            } catch(e) {}
        }

        // --- Token Display ---
        function updateTokenDisplay() {
            $payIcon.textContent = payToken.icon;
            $paySymbol.textContent = payToken.symbol;
            $receiveIcon.textContent = receiveToken.icon;
            $receiveSymbol.textContent = receiveToken.symbol;
        }

        // --- Calculation ---
        function recalculate() {
            const raw = $payAmount.value.trim();
            const payVal = parseFloat(raw);

            // USD value for pay field
            if (!isNaN(payVal) && payVal > 0 && prices[payToken.symbol]) {
                const payUsdVal = payVal * prices[payToken.symbol];
                $payUsd.textContent = '$' + formatUsd(payUsdVal);
            } else {
                $payUsd.textContent = '';
            }

            if (isNaN(payVal) || payVal <= 0 || !prices[payToken.symbol] || !prices[receiveToken.symbol]) {
                $receiveAmount.value = '';
                $receiveUsd.textContent = '';
                $rateInfo.style.display = 'none';
                updateActionBtn(payVal);
                return;
            }

            const payPrice = prices[payToken.symbol];
            const recPrice = prices[receiveToken.symbol];
            const rate = payPrice / recPrice;
            const receiveVal = payVal * rate;

            $receiveAmount.value = formatAmount(receiveVal, recPrice);

            const recUsdVal = receiveVal * recPrice;
            $receiveUsd.textContent = '$' + formatUsd(recUsdVal);

            // Rate display
            $rateDisplay.textContent = `1 ${payToken.symbol} = ${formatAmount(rate, recPrice)} ${receiveToken.symbol}`;

            // Simulated price impact based on size
            const usdSize = payVal * payPrice;
            let impact;
            if (usdSize < 10000) impact = 0.01;
            else if (usdSize < 100000) impact = 0.05 + Math.random() * 0.1;
            else if (usdSize < 1000000) impact = 0.3 + Math.random() * 0.5;
            else impact = 1.5 + Math.random() * 2;
            impact = Math.round(impact * 100) / 100;

            $impactDisplay.textContent = impact.toFixed(2) + '%';
            $impactDisplay.className = 'value' + (impact < 0.1 ? ' good' : impact < 1 ? ' warn' : ' bad');

            // Simulated gas
            const gas = (1.5 + Math.random() * 3).toFixed(2);
            $gasDisplay.textContent = '~$' + gas;

            $slipDisplay.textContent = slippage + '%';

            $rateInfo.style.display = 'flex';
            updateActionBtn(payVal);
        }

        function updateActionBtn(payVal) {
            if (!payVal || isNaN(payVal) || payVal <= 0) {
                $actionBtn.textContent = 'Enter Amount';
                $actionBtn.className = 'swap-btn disabled';
            } else {
                $actionBtn.textContent = 'Connect Wallet';
                $actionBtn.className = 'swap-btn';
            }
        }

        function formatAmount(val, unitPrice) {
            if (unitPrice >= 1000) return val.toFixed(6);
            if (unitPrice >= 1) return val.toFixed(4);
            if (unitPrice >= 0.01) return val.toFixed(2);
            return val.toFixed(8);
        }

        function formatUsd(val) {
            if (val >= 1e9) return (val / 1e9).toFixed(2) + 'B';
            if (val >= 1e6) return (val / 1e6).toFixed(2) + 'M';
            if (val >= 1000) return val.toLocaleString('en', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return val.toFixed(2);
        }

        // --- Input handling ---
        function onPayInput() {
            recalculate();
        }

        // --- Swap Direction ---
        function swapTokens() {
            const tmp = payToken;
            payToken = receiveToken;
            receiveToken = tmp;

            // Move receive amount to pay amount
            const recVal = $receiveAmount.value;
            $payAmount.value = recVal;
            $receiveAmount.value = '';

            updateTokenDisplay();
            savePair();
            recalculate();
        }

        // --- Token Modal ---
        function openModal(forField) {
            selectingFor = forField;
            $modalSearch.value = '';
            renderTokenList();
            $modalOverlay.classList.add('open');
            setTimeout(() => $modalSearch.focus(), 100);
        }

        function closeModal() {
            $modalOverlay.classList.remove('open');
        }

        function renderTokenList() {
            const q = $modalSearch.value.toLowerCase().trim();
            const otherToken = selectingFor === 'pay' ? receiveToken : payToken;
            const currentToken = selectingFor === 'pay' ? payToken : receiveToken;

            let html = '';
            for (const t of TOKENS) {
                const match = !q || t.symbol.toLowerCase().includes(q) || t.name.toLowerCase().includes(q);
                if (!match) continue;

                const isDisabled = t.symbol === otherToken.symbol;
                const isActive = t.symbol === currentToken.symbol;
                const price = prices[t.symbol];
                const priceStr = price ? '$' + (price >= 1 ? price.toLocaleString('en', { maximumFractionDigits: 2 }) : price.toFixed(4)) : '';

                html += `<div class="token-item${isDisabled ? ' disabled' : ''}" ${isDisabled ? '' : `onclick="selectToken('${t.symbol}')"`}>
                    <span class="icon">${t.icon}</span>
                    <div class="token-item-info">
                        <span class="token-item-name">${t.symbol}${isActive ? ' âœ“' : ''}</span>
                        <span class="token-item-full">${t.name}</span>
                    </div>
                    <span class="token-item-price">${priceStr}</span>
                </div>`;
            }

            if (!html) {
                html = '<div style="padding:1em;text-align:center;color:var(--col-txt2)">No tokens found</div>';
            }

            $tokenList.innerHTML = html;
        }

        function selectToken(symbol) {
            const token = TOKENS.find(t => t.symbol === symbol);
            if (!token) return;

            if (selectingFor === 'pay') {
                payToken = token;
            } else {
                receiveToken = token;
            }

            updateTokenDisplay();
            savePair();
            closeModal();
            recalculate();
        }

        // --- Settings ---
        function toggleSettings() {
            $settingsPanel.classList.toggle('open');
        }

        function setSlippage(val) {
            slippage = val;
            document.querySelectorAll('.slippage-btn').forEach(b => {
                b.classList.toggle('active', parseFloat(b.dataset.slip) === val);
            });
            $slipDisplay.textContent = val + '%';
        }

        // --- Boot ---
        init();
    </script>
</body>
</html>
