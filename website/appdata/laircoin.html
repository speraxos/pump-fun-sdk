<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Detail</title>
    <meta name="lair-icon" content="<svg width='232' height='232' viewBox='0 0 232 232' fill='none' xmlns='http://www.w3.org/2000/svg'><rect width='232' height='232' rx='40' fill='#f59e0b'/><circle cx='116' cy='116' r='70' fill='white' opacity='0.9'/><circle cx='116' cy='116' r='55' fill='#f59e0b'/><text x='116' y='132' text-anchor='middle' font-size='60' font-weight='bold' fill='white' font-family='sans-serif'>$</text><circle cx='60' cy='60' r='20' fill='white' opacity='0.3'/><circle cx='172' cy='172' r='16' fill='white' opacity='0.3'/></svg>">
    <meta name="lair-include" content="lair.css material-symbols-rounded">
    <meta name="permissions" content="appStorage, network">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            height:100vh; overflow-y:auto;
            background:var(--col-bg1,#101010);
            color:var(--col-txt1,#fff);
            font-family:'Poppins',-apple-system,BlinkMacSystemFont,sans-serif;
        }
        body::-webkit-scrollbar { width:5px; }
        body::-webkit-scrollbar-thumb { background:var(--col-bg3,#333); border-radius:3px; }

        .back-btn {
            display:inline-flex; align-items:center; gap:4px;
            padding:10px 16px; font-size:12px; color:var(--colors-accent,#6179ff);
            cursor:pointer; border:none; background:none; font-family:inherit;
        }
        .back-btn:hover { text-decoration:underline; }

        /* ‚îÄ‚îÄ Hero ‚îÄ‚îÄ */
        .coin-hero {
            text-align:center; padding:24px 20px;
            background:linear-gradient(135deg,rgba(124,58,237,0.2),rgba(59,130,246,0.15),rgba(6,182,212,0.1));
            border-bottom:1px solid var(--col-bg3,#262626);
        }
        .coin-hero-avatar {
            width:96px; height:96px; border-radius:50%;
            border:3px solid rgba(255,255,255,0.15);
            background:rgba(255,255,255,0.1);
            display:inline-flex; align-items:center; justify-content:center;
            font-size:38px; font-weight:700; color:#fff;
            margin-bottom:10px; overflow:hidden;
        }
        .coin-hero-avatar img { width:100%; height:100%; object-fit:cover; }
        .coin-hero h1 { font-size:24px; font-weight:700; margin-bottom:2px; }
        .coin-hero .ticker-text { font-size:14px; color:#888; }
        .coin-status {
            display:inline-block; margin-top:8px;
            padding:4px 12px; border-radius:20px; font-size:11px; font-weight:500;
        }
        .status-minting { background:rgba(234,179,8,0.15); color:#eab308; }
        .status-launched { background:rgba(34,197,94,0.15); color:#22c55e; }
        .status-failed { background:rgba(239,68,68,0.15); color:#ef4444; }

        /* ‚îÄ‚îÄ Stats grid ‚îÄ‚îÄ */
        .stats-grid {
            display:grid; grid-template-columns:repeat(4,1fr);
            gap:8px; padding:16px;
        }
        .stat-card {
            background:var(--col-bg2,#171717);
            border:1px solid var(--col-bg3,#262626);
            border-radius:10px; padding:12px; text-align:center;
        }
        .stat-val { font-size:20px; font-weight:700; }
        .stat-label { font-size:10px; color:#666; margin-top:2px; }

        /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
        .section {
            padding:16px; border-bottom:1px solid var(--col-bg3,#262626);
        }
        .section:last-child { border-bottom:none; }
        .section h2 {
            font-size:13px; font-weight:600; margin-bottom:10px;
            color:var(--colors-accent,#6179ff);
        }

        /* Progress */
        .progress-header {
            display:flex; justify-content:space-between;
            font-size:11px; color:#888; margin-bottom:4px;
        }
        .progress-track {
            height:8px; background:var(--col-bg3,#262626);
            border-radius:4px; overflow:hidden;
        }
        .progress-fill {
            height:100%;
            background:linear-gradient(90deg,#06B6D4,#3B82F6,#7C3AED);
            transition:width 0.5s ease;
        }

        /* Reactions */
        .reactions-wrap {
            display:flex; flex-wrap:wrap; gap:6px;
        }
        .reaction-chip {
            display:flex; align-items:center; gap:4px;
            background:var(--col-bg3,#262626); border-radius:20px;
            padding:4px 10px; font-size:13px;
        }
        .reaction-chip span { color:#888; font-weight:500; }

        /* Contract */
        .contract-row {
            display:flex; gap:8px; align-items:center;
        }
        .contract-addr {
            flex:1; padding:8px 10px; border-radius:8px;
            background:var(--col-bg3,#262626);
            font-size:11px; color:#aaa; font-family:monospace;
            word-break:break-all;
        }
        .contract-copy {
            padding:8px 14px; border:none; border-radius:8px;
            background:#7C3AED; color:#fff; font-size:11px;
            cursor:pointer; font-family:inherit; white-space:nowrap;
            transition:opacity 0.15s;
        }
        .contract-copy:hover { opacity:0.8; }
        .explorer-link {
            display:block; margin-top:8px;
            font-size:11px; color:var(--colors-accent,#6179ff);
        }
        .explorer-link:hover { text-decoration:underline; }

        /* Details grid */
        .details-grid {
            display:grid; grid-template-columns:1fr 1fr; gap:8px;
        }
        .detail-item { padding:8px; border-radius:6px; background:var(--col-bg2,#171717); }
        .detail-label { font-size:10px; color:#666; }
        .detail-val { font-size:12px; font-weight:500; margin-top:2px; }

        /* State messages */
        .state-msg { text-align:center; padding:60px 20px; }
        .state-msg .icon { font-size:48px; margin-bottom:8px; }
        .state-msg p { font-size:13px; color:#888; }
        .spinner {
            width:32px; height:32px; border:3px solid var(--col-bg3,#333);
            border-top-color:#7C3AED; border-radius:50%;
            animation:spin 0.8s linear infinite; margin:0 auto 12px;
        }
        @keyframes spin { to { transform:rotate(360deg); } }

        @media (max-width:500px) {
            .stats-grid { grid-template-columns:repeat(2,1fr); }
            .details-grid { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>

    <button class="back-btn" onclick="goBack()">
        <span class="material-symbols-rounded" style="font-size:16px">arrow_back</span>
        Back
    </button>

    <div id="loading" class="state-msg">
        <div class="spinner"></div>
        <p>Loading coin...</p>
    </div>
    <div id="error" class="state-msg" style="display:none">
        <div class="icon">üòï</div>
        <p id="error-text">Coin not found</p>
    </div>

    <div id="content" style="display:none">
        <!-- Hero -->
        <div class="coin-hero" id="hero-section"></div>

        <!-- Stats -->
        <div class="stats-grid" id="stats-section"></div>

        <!-- Progress -->
        <div class="section" id="progress-section"></div>

        <!-- Reactions -->
        <div class="section" id="reactions-section"></div>

        <!-- Contract -->
        <div class="section" id="contract-section" style="display:none"></div>

        <!-- Details -->
        <div class="section" id="details-section"></div>
    </div>

    <script>
        const LAIR_HOST = (window.location.ancestorOrigins?.[0] || '').replace(/\/$/, '') || location.origin;
        const API_URL = localStorage.getItem('lair_api_url') || LAIR_HOST;
        let coinId = null;

        // Get coin ID from URL params or parent
        function getCoinId() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('coinId')) return parseInt(params.get('coinId'));
            // Try to get from OS app params
            if (window.__lairAppParams && window.__lairAppParams.coinId) {
                return window.__lairAppParams.coinId;
            }
            return null;
        }

        async function loadCoin(id) {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('content');

            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';

            try {
                const res = await fetch(`${API_URL}/api/coins/${id}`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Not found');

                loading.style.display = 'none';
                content.style.display = 'block';
                renderCoin(data.data);

            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('error-text').textContent = err.message;
            }
        }

        function renderCoin(coin) {
            // Hero
            const statusClass = coin.status === 'minting' ? 'status-minting'
                : coin.status === 'launched' ? 'status-launched' : 'status-failed';
            const statusText = coin.status === 'minting' ? 'üîÑ Minting'
                : coin.status === 'launched' ? 'üöÄ Launched' : '‚ùå Failed';

            document.getElementById('hero-section').innerHTML = `
                <div class="coin-hero-avatar">
                    ${coin.image_url
                        ? `<img src="${coin.image_url}" alt="${coin.name}" onerror="this.style.display='none';this.parentElement.textContent='${coin.ticker.charAt(0)}'">`
                        : coin.ticker.charAt(0)}
                </div>
                <h1>${coin.name}</h1>
                <div class="ticker-text">$${coin.ticker}</div>
                <div class="coin-status ${statusClass}">${statusText}</div>
            `;

            // Stats
            document.getElementById('stats-section').innerHTML = `
                <div class="stat-card">
                    <div class="stat-val">${Math.round(coin.progress_percentage)}%</div>
                    <div class="stat-label">Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val">${coin.current_engagement}</div>
                    <div class="stat-label">Engagement</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val">${coin.replies_count || 0}</div>
                    <div class="stat-label">Replies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val">${coin.forwards_count || 0}</div>
                    <div class="stat-label">Forwards</div>
                </div>
            `;

            // Progress
            document.getElementById('progress-section').innerHTML = `
                <h2>Launch Progress</h2>
                <div class="progress-header">
                    <span>${coin.current_engagement} / ${coin.launch_threshold}</span>
                    <span>${Math.round(coin.progress_percentage)}%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" style="width:${coin.progress_percentage}%"></div>
                </div>
            `;

            // Reactions
            const reactions = Object.entries(coin.reactions || {}).sort(([,a],[,b]) => b - a);
            if (reactions.length > 0) {
                document.getElementById('reactions-section').innerHTML = `
                    <h2>Reactions</h2>
                    <div class="reactions-wrap">
                        ${reactions.map(([emoji, count]) =>
                            `<div class="reaction-chip">${emoji} <span>${count}</span></div>`
                        ).join('')}
                    </div>
                `;
                document.getElementById('reactions-section').style.display = '';
            } else {
                document.getElementById('reactions-section').style.display = 'none';
            }

            // Contract
            if (coin.contract_address) {
                const section = document.getElementById('contract-section');
                section.style.display = '';
                section.innerHTML = `
                    <h2>Contract Address</h2>
                    <div class="contract-row">
                        <div class="contract-addr">${coin.contract_address}</div>
                        <button class="contract-copy" id="copy-btn" onclick="copyAddress('${coin.contract_address}')">üìã Copy</button>
                    </div>
                    <a class="explorer-link" href="https://blockscan.com/address/${coin.contract_address}" target="_blank" rel="noopener">
                        View on Explorer ‚Üí
                    </a>
                `;
            }

            // Details
            let detailsHtml = `<h2>Details</h2><div class="details-grid">`;
            detailsHtml += `
                <div class="detail-item">
                    <div class="detail-label">Creator</div>
                    <div class="detail-val">${coin.creator_username || 'Anonymous'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Created</div>
                    <div class="detail-val">${new Date(coin.created_at).toLocaleDateString()}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Launch Threshold</div>
                    <div class="detail-val">${coin.launch_threshold}</div>
                </div>
            `;
            if (coin.launched_at) {
                detailsHtml += `
                <div class="detail-item">
                    <div class="detail-label">Launched</div>
                    <div class="detail-val">${new Date(coin.launched_at).toLocaleDateString()}</div>
                </div>`;
            }
            detailsHtml += `</div>`;
            document.getElementById('details-section').innerHTML = detailsHtml;
        }

        function copyAddress(addr) {
            navigator.clipboard.writeText(addr);
            const btn = document.getElementById('copy-btn');
            btn.textContent = '‚úì Copied';
            setTimeout(() => btn.innerHTML = 'üìã Copy', 1500);
        }

        function goBack() {
            if (window.parent && window.parent.openApp) {
                window.parent.openApp('lairlaunch');
            } else {
                history.back();
            }
        }

        // Init
        coinId = getCoinId();
        if (coinId) {
            loadCoin(coinId);
        } else {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-text').textContent = 'No coin selected. Open from Pump Launch or Trending.';
        }
    </script>
</body>
</html>
