<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trending Tokens</title>
    <meta name="lair-icon" content="<svg width='232' height='232' viewBox='0 0 232 232' fill='none' xmlns='http://www.w3.org/2000/svg'><rect width='232' height='232' rx='40' fill='%23ec4899'/><path d='M40 170l40-30 40 10 40-60 40-30 30-20' stroke='white' stroke-width='10' stroke-linecap='round' stroke-linejoin='round'/><path d='M190 40l20 0 0 20' stroke='white' stroke-width='8' stroke-linecap='round' stroke-linejoin='round'/><circle cx='40' cy='170' r='8' fill='white'/><circle cx='80' cy='140' r='8' fill='white'/><circle cx='120' cy='150' r='8' fill='white'/><circle cx='160' cy='90' r='8' fill='white'/><circle cx='200' cy='60' r='8' fill='white'/><path d='M40 170l40-30 40 10 40-60 40-30 40-20' stroke='white' stroke-width='4' stroke-linecap='round' opacity='0.3' stroke-dasharray='8 4'/></svg>">
    <meta name="lair-include" content="lair.css material-symbols-rounded">
    <meta name="permissions" content="appStorage, network">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            height:100vh; overflow-y:auto;
            background:var(--col-bg1,#101010);
            color:var(--col-txt1,#fff);
            font-family:'Poppins',-apple-system,BlinkMacSystemFont,sans-serif;
        }
        body::-webkit-scrollbar { width:5px; }
        body::-webkit-scrollbar-thumb { background:var(--col-bg3,#333); border-radius:3px; }

        /* â”€â”€ Header â”€â”€ */
        .header {
            padding:20px 16px 12px;
            border-bottom:1px solid var(--col-bg3,#262626);
        }
        .header h1 { font-size:18px; font-weight:700; display:flex; align-items:center; gap:8px; }
        .header p { font-size:12px; color:#888; margin-top:4px; }

        /* â”€â”€ Podium (top 3) â”€â”€ */
        .podium {
            display:grid; grid-template-columns:repeat(3,1fr);
            gap:10px; padding:16px;
        }
        .podium-card {
            position:relative;
            background:var(--col-bg2,#171717);
            border:1px solid var(--col-bg3,#262626);
            border-radius:12px; overflow:hidden;
            transition:border-color 0.2s;
            cursor:pointer;
        }
        .podium-card:hover { border-color:rgba(124,58,237,0.4); }
        .podium-card .rank-badge {
            position:absolute; top:8px; left:8px; z-index:2;
            width:26px; height:26px; border-radius:50%;
            background:linear-gradient(135deg,#7C3AED,#3B82F6);
            display:flex; align-items:center; justify-content:center;
            font-size:11px; font-weight:700; color:#fff;
            box-shadow:0 2px 8px rgba(0,0,0,0.3);
        }
        .podium-header {
            height:80px;
            background:linear-gradient(135deg,#7C3AED,#3B82F6,#06B6D4);
            display:flex; align-items:center; justify-content:center;
        }
        .podium-avatar {
            width:44px; height:44px; border-radius:50%;
            border:2px solid rgba(255,255,255,0.3);
            background:rgba(255,255,255,0.15);
            display:flex; align-items:center; justify-content:center;
            font-size:18px; font-weight:700; color:#fff;
            overflow:hidden;
        }
        .podium-avatar img { width:100%; height:100%; object-fit:cover; }
        .podium-body { padding:8px 10px; }
        .podium-ticker { font-size:13px; font-weight:700; }
        .podium-name { font-size:10px; color:#888; }
        .podium-engagement {
            font-size:10px; color:var(--colors-accent,#6179ff);
            margin-top:4px; font-weight:600;
        }
        .podium-progress {
            height:3px; background:var(--col-bg3,#262626);
            border-radius:2px; margin-top:6px; overflow:hidden;
        }
        .podium-progress-fill {
            height:100%; background:linear-gradient(90deg,#06B6D4,#7C3AED);
            transition:width 0.5s ease;
        }

        /* â”€â”€ Grid â”€â”€ */
        .section-label {
            font-size:12px; font-weight:600; color:#666;
            padding:12px 16px 6px;
            text-transform:uppercase; letter-spacing:0.5px;
        }
        .coins-list {
            display:flex; flex-direction:column; gap:6px;
            padding:6px 16px 20px;
        }
        .coin-row {
            display:grid; grid-template-columns:28px 40px 1fr 80px 60px;
            align-items:center; gap:10px;
            padding:10px 12px; border-radius:8px;
            background:var(--col-bg2,#171717);
            border:1px solid var(--col-bg3,#262626);
            cursor:pointer; transition:border-color 0.2s;
        }
        .coin-row:hover { border-color:rgba(124,58,237,0.3); }
        .coin-rank {
            font-size:12px; font-weight:600; color:#666; text-align:center;
        }
        .row-avatar {
            width:32px; height:32px; border-radius:50%;
            background:linear-gradient(135deg,#7C3AED,#3B82F6);
            display:flex; align-items:center; justify-content:center;
            font-size:13px; font-weight:700; color:#fff;
            overflow:hidden;
        }
        .row-avatar img { width:100%; height:100%; object-fit:cover; }
        .row-info .row-ticker { font-size:12px; font-weight:600; }
        .row-info .row-name { font-size:10px; color:#888; }
        .row-engagement {
            font-size:11px; color:var(--colors-accent,#6179ff);
            text-align:right; font-weight:600;
        }
        .row-badge {
            font-size:9px; padding:2px 6px; border-radius:10px;
            text-align:center; font-weight:500;
        }
        .badge-minting { background:rgba(234,179,8,0.15); color:#eab308; }
        .badge-launched { background:rgba(34,197,94,0.15); color:#22c55e; }
        .badge-failed { background:rgba(239,68,68,0.15); color:#ef4444; }

        /* â”€â”€ State messages â”€â”€ */
        .state-msg { text-align:center; padding:40px 20px; }
        .state-msg .icon { font-size:48px; margin-bottom:8px; }
        .state-msg p { font-size:13px; color:#888; }
        .state-msg .retry-btn {
            margin-top:12px; padding:8px 20px; border:none; border-radius:8px;
            background:#7C3AED; color:#fff; font-size:12px;
            cursor:pointer; font-family:inherit;
        }
        .state-msg .retry-btn:hover { opacity:0.8; }
        .spinner {
            width:32px; height:32px; border:3px solid var(--col-bg3,#333);
            border-top-color:#7C3AED; border-radius:50%;
            animation:spin 0.8s linear infinite; margin:0 auto 12px;
        }
        @keyframes spin { to { transform:rotate(360deg); } }
    </style>
</head>
<body>

    <div class="header">
        <h1>ðŸ”¥ Trending Tokens</h1>
        <p>Hot tokens ranked by community engagement</p>
    </div>

    <div id="loading" class="state-msg">
        <div class="spinner"></div>
        <p>Loading trending...</p>
    </div>
    <div id="error" class="state-msg" style="display:none">
        <div class="icon">ðŸ˜•</div>
        <p id="error-text">Failed to connect</p>
        <button class="retry-btn" onclick="loadTrending()">Retry</button>
    </div>
    <div id="empty" class="state-msg" style="display:none">
        <div class="icon">ðŸ“Š</div>
        <p>No trending tokens yet.</p>
    </div>

    <div id="content" style="display:none">
        <div id="podium-container" class="podium"></div>
        <div class="section-label" id="rest-label"></div>
        <div id="list-container" class="coins-list"></div>
    </div>

    <script>
        const LAIR_HOST = (window.location.ancestorOrigins?.[0] || '').replace(/\/$/, '') || location.origin;
        const API_URL = localStorage.getItem('lair_api_url') || LAIR_HOST;

        async function loadTrending() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const empty = document.getElementById('empty');
            const content = document.getElementById('content');

            loading.style.display = 'block';
            error.style.display = 'none';
            empty.style.display = 'none';
            content.style.display = 'none';

            try {
                const res = await fetch(`${API_URL}/api/coins?sort=engagement`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed');

                const coins = data.data || [];
                loading.style.display = 'none';

                if (coins.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                content.style.display = 'block';
                renderPodium(coins.slice(0, 3));
                renderList(coins.slice(3), 4);

            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('error-text').textContent = err.message;
            }
        }

        function renderPodium(top3) {
            const container = document.getElementById('podium-container');
            if (top3.length < 3) {
                container.style.display = 'none';
                return;
            }
            container.innerHTML = top3.map((coin, i) => `
                <div class="podium-card" onclick="openCoin(${coin.id})">
                    <div class="rank-badge">#${i + 1}</div>
                    <div class="podium-header">
                        <div class="podium-avatar">
                            ${coin.image_url
                                ? `<img src="${coin.image_url}" alt="${coin.name}" onerror="this.style.display='none';this.parentElement.textContent='${coin.ticker.charAt(0)}'">`
                                : coin.ticker.charAt(0)}
                        </div>
                    </div>
                    <div class="podium-body">
                        <div class="podium-ticker">${coin.ticker}</div>
                        <div class="podium-name">${coin.name}</div>
                        <div class="podium-engagement">âš¡ ${coin.current_engagement} engagement</div>
                        <div class="podium-progress">
                            <div class="podium-progress-fill" style="width:${coin.progress_percentage}%"></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderList(coins, startRank) {
            const container = document.getElementById('list-container');
            const label = document.getElementById('rest-label');

            if (coins.length === 0) {
                container.innerHTML = '';
                label.textContent = '';
                return;
            }

            label.textContent = `All Tokens (${coins.length + startRank - 1} total)`;

            container.innerHTML = coins.map((coin, i) => {
                const rank = startRank + i;
                const badgeClass = coin.status === 'minting' ? 'badge-minting'
                    : coin.status === 'launched' ? 'badge-launched' : 'badge-failed';
                const badgeText = coin.status === 'minting' ? 'Minting'
                    : coin.status === 'launched' ? 'Launched' : 'Failed';
                return `
                <div class="coin-row" onclick="openCoin(${coin.id})">
                    <div class="coin-rank">${rank}</div>
                    <div class="row-avatar">
                        ${coin.image_url
                            ? `<img src="${coin.image_url}" alt="${coin.name}" onerror="this.style.display='none';this.parentElement.textContent='${coin.ticker.charAt(0)}'">`
                            : coin.ticker.charAt(0)}
                    </div>
                    <div class="row-info">
                        <div class="row-ticker">${coin.ticker}</div>
                        <div class="row-name">${coin.name}</div>
                    </div>
                    <div class="row-engagement">âš¡ ${coin.current_engagement}</div>
                    <div class="row-badge ${badgeClass}">${badgeText}</div>
                </div>`;
            }).join('');
        }

        function openCoin(id) {
            if (window.parent && window.parent.openApp) {
                window.parent.openApp('laircoin', { coinId: id });
            }
        }

        loadTrending();
    </script>
</body>
</html>
