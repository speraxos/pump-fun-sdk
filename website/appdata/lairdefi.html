<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lair DeFi</title>
    <meta name="lair-icon" content="<svg width='232' height='232' viewBox='0 0 232 232' fill='none' xmlns='http://www.w3.org/2000/svg'><rect width='232' height='232' rx='40' fill='#0066ff'/><path d='M116 30L40 80v72l76 50 76-50V80L116 30z' fill='white' opacity='0.15'/><path d='M116 50L56 90v52l60 40 60-40V90L116 50z' fill='white' opacity='0.25'/><path d='M116 70L72 100v32l44 30 44-30V100L116 70z' fill='white' opacity='0.9'/><circle cx='116' cy='116' r='16' fill='#0066ff'/></svg>">
    <meta name="lair-include" content="lair.css material-symbols-rounded">
    <meta name="permissions" content="appStorage, network">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            height: 100vh; overflow: hidden;
            background: var(--col-bg1, #101010);
            color: var(--col-txt1, #fff);
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex; flex-direction: column;
        }
        a { color: var(--colors-accent, #6179ff); text-decoration: none; }

        /* â”€â”€ Tab bar â”€â”€ */
        .tab-bar {
            display: flex; gap: 2px;
            background: var(--col-bg2, #171717);
            border-bottom: 1px solid var(--col-bg3, #262626);
            padding: 0 8px; flex-shrink: 0;
        }
        .tab {
            display: flex; align-items: center; gap: 6px;
            padding: 10px 14px; cursor: pointer;
            color: var(--col-txt1, #aaa); opacity: 0.5;
            font-size: 12px; font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s; user-select: none;
        }
        .tab:hover { opacity: 0.7; }
        .tab.active { opacity: 1; color: var(--colors-accent, #6179ff); border-bottom-color: var(--colors-accent, #6179ff); }
        .tab .material-symbols-rounded { font-size: 16px; }

        /* â”€â”€ Stats bar â”€â”€ */
        .stats-bar {
            display: flex; gap: 16px; padding: 8px 14px;
            background: var(--col-bg2, #171717);
            border-bottom: 1px solid var(--col-bg3, #262626);
            overflow-x: auto; flex-shrink: 0; font-size: 11px;
            scrollbar-width: none;
        }
        .stats-bar::-webkit-scrollbar { display: none; }
        .si { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .sl { color: #666; }
        .sv { font-weight: 600; }

        /* Colors */
        .up { color: #5be45b; }
        .dn { color: #ef4444; }
        .muted { color: #888; }

        /* â”€â”€ Panels â”€â”€ */
        .panel { display: none; flex: 1; overflow-y: auto; }
        .panel.active { display: flex; flex-direction: column; }
        .panel::-webkit-scrollbar { width: 5px; }
        .panel::-webkit-scrollbar-track { background: transparent; }
        .panel::-webkit-scrollbar-thumb { background: var(--col-bg3, #333); border-radius: 3px; }

        /* â”€â”€ Search â”€â”€ */
        .search-bar {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 14px; flex-shrink: 0;
        }
        .search-bar input {
            flex: 1; background: var(--col-bg2, #171717);
            border: 1px solid var(--col-bg3, #262626);
            border-radius: 8px; padding: 7px 12px;
            color: var(--col-txt1, #fff); font-size: 12px;
            outline: none; font-family: inherit;
        }
        .search-bar input:focus { border-color: var(--colors-accent, #6179ff); }
        .search-bar input::placeholder { color: #555; }

        /* â”€â”€ Table â”€â”€ */
        .t-head {
            display: grid;
            grid-template-columns: 36px 2fr 100px 80px 100px 72px;
            padding: 6px 14px; font-size: 10px;
            color: #555; text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 1px solid var(--col-bg3, #222);
            position: sticky; top: 0; background: var(--col-bg1, #101010); z-index: 5;
            flex-shrink: 0;
        }
        .t-row {
            display: grid;
            grid-template-columns: 36px 2fr 100px 80px 100px 72px;
            padding: 10px 14px; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            cursor: pointer; transition: background 0.12s;
        }
        .t-row:hover { background: var(--col-bg2, #171717); }
        .t-body { flex: 1; overflow-y: auto; }
        .t-body::-webkit-scrollbar { width: 5px; }
        .t-body::-webkit-scrollbar-track { background: transparent; }
        .t-body::-webkit-scrollbar-thumb { background: var(--col-bg3, #333); border-radius: 3px; }
        .rank { color: #555; font-size: 11px; }
        .ci { display: flex; align-items: center; gap: 8px; min-width: 0; }
        .ci-icon {
            width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700;
            background: var(--col-bg3, #262626); color: var(--colors-accent, #6179ff);
            overflow: hidden;
        }
        .ci-icon img { width: 100%; height: 100%; object-fit: cover; }
        .ci-name { font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ci-sym { color: #666; font-size: 10px; text-transform: uppercase; }
        .text-r { text-align: right; font-size: 12px; }
        .text-r.fw { font-weight: 600; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { color: #aaa; }
        canvas.spark { width: 64px; height: 24px; display: block; margin-left: auto; }

        /* â”€â”€ Trending grid â”€â”€ */
        .t-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 10px; padding: 14px; }
        .t-card {
            background: var(--col-bg2, #171717);
            border: 1px solid var(--col-bg3, #262626);
            border-radius: 10px; padding: 14px;
            cursor: pointer; transition: all 0.15s;
        }
        .t-card:hover { border-color: var(--colors-accent, #6179ff); transform: translateY(-1px); }
        .t-rank { font-size: 10px; font-weight: 700; color: var(--colors-accent, #6179ff); margin-bottom: 6px; }
        .t-stats { display: flex; justify-content: space-between; gap: 8px; margin-top: 10px; }
        .ts-l { font-size: 10px; color: #555; }
        .ts-v { font-size: 13px; font-weight: 600; }

        /* â”€â”€ Gas grid â”€â”€ */
        .g-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; padding: 14px; }
        .g-card {
            background: var(--col-bg2, #171717);
            border: 1px solid var(--col-bg3, #262626);
            border-radius: 10px; padding: 14px;
        }
        .g-head { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .g-dot { width: 7px; height: 7px; border-radius: 50%; }
        .g-name { font-weight: 600; font-size: 13px; }
        .g-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; }
        .g-label { color: #888; }
        .g-val { font-weight: 600; }

        /* â”€â”€ Fear/Greed gauge â”€â”€ */
        .fg-wrap { display: flex; flex-direction: column; align-items: center; padding: 24px; }
        .fg-gauge { position: relative; width: 200px; height: 120px; }
        .fg-gauge svg { width: 200px; height: 120px; overflow: visible; }
        .fg-center { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); text-align: center; }
        .fg-value { font-size: 36px; font-weight: 700; }
        .fg-class { font-size: 12px; color: #888; }

        /* â”€â”€ Whale alerts â”€â”€ */
        .w-list { padding: 14px; display: flex; flex-direction: column; gap: 8px; }
        .w-alert {
            background: var(--col-bg2, #171717);
            border: 1px solid var(--col-bg3, #262626);
            border-radius: 10px; padding: 12px 14px;
            display: flex; align-items: flex-start; gap: 10px;
        }
        .w-alert.massive { border-left: 3px solid #f59e0b; }
        .w-alert.notable { border-left: 3px solid #3b82f6; }
        .w-icon { font-size: 20px; flex-shrink: 0; margin-top: 2px; }
        .w-body { flex: 1; min-width: 0; }
        .w-headline { font-size: 12px; font-weight: 600; }
        .w-detail { font-size: 11px; color: #888; margin-top: 2px; }
        .w-time { font-size: 10px; color: #555; flex-shrink: 0; }

        /* â”€â”€ Portfolio â”€â”€ */
        .p-header {
            padding: 20px 14px; text-align: center;
            background: linear-gradient(135deg, rgba(97,121,255,0.08) 0%, rgba(91,228,91,0.04) 100%);
            border-bottom: 1px solid var(--col-bg3, #262626);
        }
        .p-total { font-size: 28px; font-weight: 700; }
        .p-sub { font-size: 13px; color: #888; margin-top: 2px; }
        .p-input-row { display: flex; gap: 8px; padding: 14px; }
        .p-input-row input {
            flex: 1; background: var(--col-bg2, #171717); border: 1px solid var(--col-bg3, #262626);
            border-radius: 8px; padding: 9px 12px; color: var(--col-txt1, #fff);
            font-size: 12px; outline: none; font-family: inherit;
        }
        .p-input-row input:focus { border-color: var(--colors-accent, #6179ff); }
        .p-input-row button {
            padding: 9px 18px; background: var(--colors-accent, #6179ff);
            color: #fff; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; font-size: 12px; font-family: inherit;
        }
        .h-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .h-left { display: flex; align-items: center; gap: 10px; }
        .h-right { text-align: right; }
        .h-val { font-weight: 600; font-size: 13px; }
        .h-amt { font-size: 11px; color: #666; }

        /* â”€â”€ Detail overlay â”€â”€ */
        .detail {
            position: fixed; inset: 0; background: var(--col-bg1, #101010);
            z-index: 100; display: none; flex-direction: column;
        }
        .detail.show { display: flex; }
        .d-header {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; background: var(--col-bg2, #171717);
            border-bottom: 1px solid var(--col-bg3, #262626);
            flex-shrink: 0;
        }
        .d-back { background: none; border: none; color: var(--col-txt1, #fff); cursor: pointer; display: flex; padding: 4px; }
        .d-body { flex: 1; overflow-y: auto; padding: 14px; }
        .d-body::-webkit-scrollbar { width: 5px; }
        .d-body::-webkit-scrollbar-thumb { background: var(--col-bg3, #333); border-radius: 3px; }
        .d-price { font-size: 26px; font-weight: 700; }
        .d-change { font-size: 14px; font-weight: 600; margin-left: 10px; }
        .d-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 16px 0; }
        .d-stat { background: var(--col-bg2, #171717); border-radius: 8px; padding: 12px; border: 1px solid var(--col-bg3, #262626); }
        .d-stat-l { font-size: 10px; color: #666; margin-bottom: 3px; }
        .d-stat-v { font-size: 14px; font-weight: 600; }

        /* â”€â”€ Badges â”€â”€ */
        .badge {
            display: inline-flex; align-items: center; gap: 3px;
            padding: 2px 7px; border-radius: 5px;
            font-size: 10px; font-weight: 600;
        }
        .badge-up { background: rgba(91,228,91,0.12); color: #5be45b; }
        .badge-dn { background: rgba(239,68,68,0.12); color: #ef4444; }
        .badge-blue { background: rgba(97,121,255,0.12); color: #6179ff; }

        /* â”€â”€ Section headers â”€â”€ */
        .sec-h { padding: 14px 14px 6px; font-size: 12px; color: #555; display: flex; align-items: center; gap: 6px; }
        .sec-h .material-symbols-rounded { font-size: 15px; }

        /* â”€â”€ Loading / Empty / Error â”€â”€ */
        .state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px 20px; text-align: center; flex: 1; }
        .state .material-symbols-rounded { font-size: 40px; color: #333; margin-bottom: 10px; }
        .state p { color: #666; font-size: 13px; }
        .state .sub { font-size: 11px; color: #444; margin-top: 4px; }
        .spinner { width: 30px; height: 30px; border: 3px solid var(--col-bg3, #262626); border-top-color: var(--colors-accent, #6179ff); border-radius: 50%; animation: spin 0.7s linear infinite; margin-bottom: 14px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .retry { margin-top: 10px; padding: 7px 18px; background: var(--colors-accent, #6179ff); color: #fff; border: none; border-radius: 7px; cursor: pointer; font-size: 12px; font-weight: 600; font-family: inherit; }

        /* â”€â”€ Launch cards â”€â”€ */
        .lc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 10px; padding-top: 10px; }
        .lc-card {
            background: var(--col-bg2, #171717);
            border: 1px solid var(--col-bg3, #262626);
            border-radius: 12px; overflow: hidden;
            cursor: pointer; transition: all 0.15s;
        }
        .lc-card:hover { border-color: var(--colors-accent, #6179ff); transform: translateY(-1px); }
        .lc-hero {
            height: 100px; background: linear-gradient(135deg, #6179ff33 0%, #a855f733 100%);
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .lc-hero img {
            width: 64px; height: 64px; border-radius: 50%; object-fit: cover;
            border: 3px solid var(--col-bg2, #171717); box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .lc-hero .lc-avatar {
            width: 64px; height: 64px; border-radius: 50%;
            background: var(--col-bg3, #262626); color: var(--colors-accent, #6179ff);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 700;
            border: 3px solid var(--col-bg2, #171717);
        }
        .lc-status {
            position: absolute; top: 8px; right: 8px;
            padding: 2px 8px; border-radius: 5px;
            font-size: 10px; font-weight: 600;
        }
        .lc-status.minting { background: rgba(234,179,8,0.15); color: #eab308; }
        .lc-status.launched { background: rgba(91,228,91,0.15); color: #5be45b; }
        .lc-status.failed { background: rgba(239,68,68,0.15); color: #ef4444; }
        .lc-body { padding: 12px; }
        .lc-title { font-size: 15px; font-weight: 700; }
        .lc-ticker { font-size: 11px; color: var(--colors-accent, #6179ff); font-weight: 600; }
        .lc-creator { font-size: 11px; color: #666; margin-top: 4px; display: flex; align-items: center; gap: 4px; }
        .lc-creator-dot {
            width: 16px; height: 16px; border-radius: 50%; background: var(--col-bg3, #262626);
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 600; color: #888;
        }
        .lc-metrics { display: flex; gap: 10px; margin-top: 8px; font-size: 11px; color: #888; }
        .lc-reactions { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
        .lc-rx {
            display: flex; align-items: center; gap: 2px;
            background: var(--col-bg1, #101010); border-radius: 12px;
            padding: 2px 7px; font-size: 11px;
        }
        .lc-rx-count { color: #888; font-size: 10px; }
        .lc-progress { margin-top: 10px; }
        .lc-progress-header { display: flex; justify-content: space-between; font-size: 10px; color: #555; margin-bottom: 4px; }
        .lc-bar { height: 6px; background: var(--col-bg3, #262626); border-radius: 3px; overflow: hidden; }
        .lc-bar-fill {
            height: 100%; border-radius: 3px;
            background: linear-gradient(90deg, #38bdf8, #6179ff, #a855f7);
            transition: width 0.5s ease;
        }
        .lc-contract {
            margin-top: 8px; padding: 6px 8px;
            background: var(--col-bg1, #101010); border-radius: 6px;
            font-size: 10px; font-family: monospace; color: #888;
            display: flex; align-items: center; justify-content: space-between;
        }
        .lc-copy {
            background: none; border: none; color: var(--colors-accent, #6179ff);
            cursor: pointer; font-size: 14px; font-family: 'Material Symbols Rounded';
        }

        /* â”€â”€ Lair Coin Detail overlay â”€â”€ */
        .lcd-stats { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin: 16px 0; }
        .lcd-stat {
            background: var(--col-bg2, #171717); border: 1px solid var(--col-bg3, #262626);
            border-radius: 8px; padding: 12px; text-align: center;
        }
        .lcd-stat-v { font-size: 20px; font-weight: 700; }
        .lcd-stat-l { font-size: 10px; color: #666; margin-top: 2px; }
        .lcd-bar-lg { height: 10px; background: var(--col-bg3, #262626); border-radius: 5px; overflow: hidden; }
        .lcd-bar-lg-fill {
            height: 100%; border-radius: 5px;
            background: linear-gradient(90deg, #38bdf8, #6179ff, #a855f7);
            transition: width 0.5s ease;
        }
        .lcd-reactions { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
        .lcd-rx {
            display: flex; align-items: center; gap: 4px;
            background: var(--col-bg2, #171717); border: 1px solid var(--col-bg3, #262626);
            border-radius: 12px; padding: 6px 12px; font-size: 14px;
        }
        .lcd-rx .count { color: #888; font-weight: 600; font-size: 13px; }
        .lcd-contract {
            margin-top: 16px; padding: 12px;
            background: var(--col-bg2, #171717); border: 1px solid var(--col-bg3, #262626);
            border-radius: 8px; display: flex; align-items: center; gap: 10px;
        }
        .lcd-addr { flex: 1; font-family: monospace; font-size: 12px; color: #aaa; word-break: break-all; }
        .lcd-copy-btn {
            padding: 6px 14px; background: var(--colors-accent, #6179ff);
            color: #fff; border: none; border-radius: 6px; cursor: pointer;
            font-size: 12px; font-weight: 600; font-family: inherit; white-space: nowrap;
        }
        .lcd-meta { margin-top: 16px; }
        .lcd-meta-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 12px; }
        .lcd-meta-l { color: #666; }
        .lcd-meta-v { font-weight: 600; }

        /* â”€â”€ Connection dot â”€â”€ */
        .cdot { width: 5px; height: 5px; border-radius: 50%; display: inline-block; }
        .cdot.on { background: #5be45b; animation: pulse 2s infinite; }
        .cdot.off { background: #ef4444; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 540px) {
            .t-head, .t-row { grid-template-columns: 28px 2fr 80px 64px; }
            .t-head > :nth-child(5), .t-head > :nth-child(6),
            .t-row > :nth-child(5), .t-row > :nth-child(6) { display: none; }
            .t-grid { grid-template-columns: 1fr; }
            .g-grid { grid-template-columns: 1fr 1fr; }
            .d-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="tab-bar">
        <div class="tab active" data-t="markets" onclick="go('markets')"><span class="material-symbols-rounded">monitoring</span>Markets</div>
        <div class="tab" data-t="launches" onclick="go('launches')"><span class="material-symbols-rounded">rocket_launch</span>Launches</div>
        <div class="tab" data-t="trending" onclick="go('trending')"><span class="material-symbols-rounded">trending_up</span>Trending</div>
        <div class="tab" data-t="gas" onclick="go('gas')"><span class="material-symbols-rounded">local_gas_station</span>Gas</div>
        <div class="tab" data-t="whales" onclick="go('whales')"><span class="material-symbols-rounded">water</span>Whales</div>
        <div class="tab" data-t="portfolio" onclick="go('portfolio')"><span class="material-symbols-rounded">account_balance_wallet</span>Portfolio</div>
    </div>

    <div class="stats-bar" id="sbar">
        <div class="si"><span class="sl">Mkt Cap</span><span class="sv" id="sMcap">â€”</span></div>
        <div class="si"><span class="sl">24h Vol</span><span class="sv" id="sVol">â€”</span></div>
        <div class="si"><span class="sl">BTC</span><span class="sv" id="sBtc">â€”</span></div>
        <div class="si"><span class="sl">ETH</span><span class="sv" id="sEth">â€”</span></div>
        <div class="si"><span class="sl">Fear&amp;Greed</span><span class="sv" id="sFG">â€”</span></div>
        <div class="si"><span class="cdot off" id="cDot"></span><span class="sv" id="cSt" style="font-size:10px;">Connecting</span></div>
    </div>

    <!-- LAUNCHES -->
    <div class="panel" id="p-launches">
        <div class="search-bar">
            <span class="material-symbols-rounded" style="color:#555;font-size:18px;">search</span>
            <input type="text" placeholder="Search launched coinsâ€¦" id="lcSearch" oninput="filterLaunches()">
            <select id="lcFilter" onchange="filterLaunches()" style="background:var(--col-bg2,#171717);border:1px solid var(--col-bg3,#262626);border-radius:8px;padding:7px 10px;color:var(--col-txt1,#fff);font-size:12px;outline:none;font-family:inherit;cursor:pointer;">
                <option value="all">All</option>
                <option value="minting">ğŸ”„ Minting</option>
                <option value="launched">ğŸš€ Launched</option>
                <option value="failed">âŒ Failed</option>
            </select>
        </div>
        <div id="lcGrid" style="flex:1;overflow-y:auto;padding:0 14px 14px;"><div class="state"><div class="spinner"></div><p>Loading launchesâ€¦</p></div></div>
    </div>

    <!-- MARKETS -->
    <div class="panel active" id="p-markets">
        <div class="search-bar">
            <span class="material-symbols-rounded" style="color:#555;font-size:18px;">search</span>
            <input type="text" placeholder="Search coinsâ€¦" id="qInput" oninput="filterCoins()">
        </div>
        <div class="t-head">
            <div class="sortable" onclick="sort('rank')">#</div>
            <div class="sortable" onclick="sort('name')">Name</div>
            <div class="sortable text-r" onclick="sort('price')">Price</div>
            <div class="sortable text-r" onclick="sort('change')">24h</div>
            <div class="sortable text-r" onclick="sort('mcap')">Mkt Cap</div>
            <div class="text-r">7d</div>
        </div>
        <div class="t-body" id="mBody">
            <div class="state"><div class="spinner"></div><p>Loading marketsâ€¦</p></div>
        </div>
    </div>

    <!-- TRENDING -->
    <div class="panel" id="p-trending">
        <div id="trContent"><div class="state"><div class="spinner"></div><p>Loading trendingâ€¦</p></div></div>
    </div>

    <!-- GAS -->
    <div class="panel" id="p-gas">
        <div id="gasContent"><div class="state"><div class="spinner"></div><p>Loading gasâ€¦</p></div></div>
    </div>

    <!-- WHALES -->
    <div class="panel" id="p-whales">
        <div id="whaleContent"><div class="state"><div class="spinner"></div><p>Loading whale alertsâ€¦</p></div></div>
    </div>

    <!-- PORTFOLIO -->
    <div class="panel" id="p-portfolio">
        <div class="p-header">
            <div class="p-total" id="pTotal">Portfolio</div>
            <div class="p-sub" id="pSub">Enter a wallet address to view holdings</div>
        </div>
        <div class="p-input-row">
            <input type="text" id="wAddr" placeholder="0xâ€¦ or ENS name" onkeydown="if(event.key==='Enter')loadPortfolio()">
            <button onclick="loadPortfolio()">View</button>
        </div>
        <div id="pList"></div>
    </div>

    <!-- DETAIL OVERLAY -->
    <div class="detail" id="det">
        <div class="d-header">
            <button class="d-back" onclick="closeDet()"><span class="material-symbols-rounded">arrow_back</span></button>
            <div id="dInfo" class="ci"></div>
        </div>
        <div class="d-body" id="dBody"></div>
    </div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â• Config â•â•â•â•â•â•â•â•â•â•â• */
const LAIR_HOST = window.LAIR_HOST || (window.location.ancestorOrigins?.[0] || '').replace(/\/$/, '') || location.origin;
const API = (location.hostname==='localhost'||location.hostname==='127.0.0.1')
    ? 'http://localhost:3001' : (window.LAIR_API_URL || LAIR_HOST);
const CG = 'https://api.coingecko.com/api/v3';
const FNG_API = 'https://api.alternative.me/fng';

/* CORS-safe fetch: blob: iframes have origin=null which some APIs reject.
   Route external URLs directly through our Vercel CORS proxy. */
if (!window.cfetch) {
  window.cfetch = async function cfetch(url, opts) {
    try {
        var u = new URL(url, LAIR_HOST);
        if (u.origin === LAIR_HOST) return fetch(url, opts);
    } catch(_) {}
    var proxyUrl = LAIR_HOST + '/api/proxy?url=' + encodeURIComponent(url);
    if (opts && opts.method && opts.method.toUpperCase() === 'POST') {
        return fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: opts.body });
    }
    return fetch(proxyUrl, opts);
  };
}

let coins = [], sortKey = 'rank', sortAsc = true, ws = null;
let lairCoins = [], lcLoaded = false;

/* â•â•â•â•â•â•â•â•â•â•â• Helpers â•â•â•â•â•â•â•â•â•â•â• */
function fmtNum(n) {
    if (n==null||isNaN(n)) return 'â€”';
    if (Math.abs(n)>=1e12) return (n/1e12).toFixed(2)+'T';
    if (Math.abs(n)>=1e9) return (n/1e9).toFixed(2)+'B';
    if (Math.abs(n)>=1e6) return (n/1e6).toFixed(2)+'M';
    if (Math.abs(n)>=1e3) return (n/1e3).toFixed(2)+'K';
    return n.toFixed(2);
}
function fmtP(n) {
    if (n==null||isNaN(n)) return '$â€”';
    if (n>=1e3) return '$'+n.toLocaleString('en',{maximumFractionDigits:0});
    if (n>=1) return '$'+n.toFixed(2);
    if (n>=0.01) return '$'+n.toFixed(4);
    return '$'+n.toFixed(6);
}
function pct(n) {
    if (n==null||isNaN(n)) return '<span class="muted">â€”</span>';
    return `<span class="${n>=0?'up':'dn'}">${n>=0?'â–²':'â–¼'} ${Math.abs(n).toFixed(2)}%</span>`;
}
function fgColor(v) {
    if (v<=25) return '#ef4444';
    if (v<=45) return '#f97316';
    if (v<=55) return '#eab308';
    if (v<=75) return '#84cc16';
    return '#5be45b';
}
function shortAddr(a) { return a ? a.slice(0,6)+'â€¦'+a.slice(-4) : ''; }
function timeAgo(ts) {
    const d = Date.now() - (typeof ts==='number'&&ts<1e12 ? ts*1000 : ts);
    const m = Math.floor(d/60000), h = Math.floor(m/60);
    if (h>0) return h+'h ago';
    if (m>0) return m+'m ago';
    return Math.floor(d/1000)+'s ago';
}

/* â•â•â•â•â•â•â•â•â•â•â• Tab switching â•â•â•â•â•â•â•â•â•â•â• */
function go(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.t===tab));
    document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id==='p-'+tab));
    if (tab==='launches') loadLaunches();
    if (tab==='trending') loadTrending();
    if (tab==='gas') loadGas();
    if (tab==='whales') loadWhales();
}

/* â•â•â•â•â•â•â•â•â•â•â• Sparkline â•â•â•â•â•â•â•â•â•â•â• */
function spark(canvas, data, color) {
    if (!data||data.length<2) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width = 64, h = canvas.height = 24;
    ctx.clearRect(0,0,w,h);
    const min = Math.min(...data), max = Math.max(...data), r = max-min||1;
    ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 1.2;
    data.forEach((v,i) => {
        const x = (i/(data.length-1))*w, y = h-((v-min)/r)*(h-4)-2;
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    });
    ctx.stroke();
}

/* â•â•â•â•â•â•â•â•â•â•â• Markets â•â•â•â•â•â•â•â•â•â•â• */
async function loadMarkets() {
    try {
        const r = await cfetch(`${CG}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=true&price_change_percentage=24h,7d`);
        if (!r.ok) throw new Error('CoinGecko '+r.status);
        coins = await r.json();
        renderCoins(coins);
    } catch(e) {
        document.getElementById('mBody').innerHTML = `<div class="state"><span class="material-symbols-rounded">cloud_off</span><p>Failed to load markets</p><p class="sub">${e.message}</p><button class="retry" onclick="loadMarkets()">Retry</button></div>`;
    }
}

function renderCoins(list) {
    const el = document.getElementById('mBody');
    if (!list.length) { el.innerHTML = '<div class="state"><span class="material-symbols-rounded">search_off</span><p>No coins found</p></div>'; return; }
    el.innerHTML = list.map((c,i) => `
        <div class="t-row" onclick="showDet('${c.id}')">
            <div class="rank">${c.market_cap_rank||i+1}</div>
            <div class="ci">
                <div class="ci-icon">${c.image ? `<img src="${c.image}" alt="${c.symbol}" loading="lazy">` : (c.symbol||'?').charAt(0).toUpperCase()}</div>
                <div><div class="ci-name">${c.name}</div><div class="ci-sym">${c.symbol}</div></div>
            </div>
            <div class="text-r fw">${fmtP(c.current_price)}</div>
            <div class="text-r">${pct(c.price_change_percentage_24h)}</div>
            <div class="text-r muted" style="font-size:11px;">$${fmtNum(c.market_cap)}</div>
            <div class="text-r"><canvas class="spark" id="sk-${c.id}"></canvas></div>
        </div>`).join('');
    requestAnimationFrame(() => {
        list.forEach(c => {
            const cv = document.getElementById('sk-'+c.id);
            if (cv && c.sparkline_in_7d?.price) {
                spark(cv, c.sparkline_in_7d.price, (c.price_change_percentage_7d_in_currency||0)>=0 ? '#5be45b':'#ef4444');
            }
        });
    });
}

function filterCoins() {
    const q = document.getElementById('qInput').value.toLowerCase();
    renderCoins(coins.filter(c => c.name.toLowerCase().includes(q)||c.symbol.toLowerCase().includes(q)));
}

function sort(key) {
    if (sortKey===key) sortAsc=!sortAsc; else { sortKey=key; sortAsc=true; }
    const s = [...coins].sort((a,b) => {
        let va,vb;
        switch(key) {
            case 'rank': va=a.market_cap_rank||999; vb=b.market_cap_rank||999; break;
            case 'name': va=a.name.toLowerCase(); vb=b.name.toLowerCase(); break;
            case 'price': va=a.current_price||0; vb=b.current_price||0; break;
            case 'change': va=a.price_change_percentage_24h||0; vb=b.price_change_percentage_24h||0; break;
            case 'mcap': va=a.market_cap||0; vb=b.market_cap||0; break;
            default: return 0;
        }
        if (typeof va==='string') return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
        return sortAsc ? va-vb : vb-va;
    });
    renderCoins(s);
}

/* â•â•â•â•â•â•â•â•â•â•â• Global stats â•â•â•â•â•â•â•â•â•â•â• */
async function loadStats() {
    try {
        const r = await cfetch(`${CG}/global`);
        const {data} = await r.json();
        document.getElementById('sMcap').textContent = '$'+fmtNum(data.total_market_cap?.usd);
        document.getElementById('sVol').textContent = '$'+fmtNum(data.total_volume?.usd);
        document.getElementById('sBtc').innerHTML = `${(data.market_cap_percentage?.btc||0).toFixed(1)}% <span style="font-size:9px;" class="${(data.market_cap_change_percentage_24h_usd||0)>=0?'up':'dn'}">${(data.market_cap_change_percentage_24h_usd||0)>=0?'â–²':'â–¼'}${Math.abs(data.market_cap_change_percentage_24h_usd||0).toFixed(1)}%</span>`;
        document.getElementById('sEth').textContent = (data.market_cap_percentage?.eth||0).toFixed(1)+'%';
    } catch(_) {}
    // Fear & Greed
    try {
        const r = await cfetch(`${FNG_API}/?limit=1`);
        const {data} = await r.json();
        if (data?.[0]) {
            const v = parseInt(data[0].value);
            document.getElementById('sFG').innerHTML = `<span style="color:${fgColor(v)};font-weight:700;">${v}</span> <span style="font-size:9px;color:#888;">${data[0].value_classification}</span>`;
        }
    } catch(_) {}
}

/* â•â•â•â•â•â•â•â•â•â•â• Trending â•â•â•â•â•â•â•â•â•â•â• */
let trLoaded = false;
async function loadTrending() {
    if (trLoaded) return;
    const el = document.getElementById('trContent');
    try {
        // Try Lair API first
        let tokens = [];
        try {
            const r = await fetch(`${API}/api/market/trending?limit=20`);
            if (r.ok) { const d = await r.json(); tokens = d.tokens||[]; }
        } catch(_) {}

        // Fallback CoinGecko
        if (!tokens.length) {
            const r = await cfetch(`${CG}/search/trending`);
            const d = await r.json();
            // Get price data for trending coins
            const ids = (d.coins||[]).map(c => c.item.id).join(',');
            let priceMap = {};
            if (ids) {
                try {
                    const pr = await cfetch(`${CG}/coins/markets?vs_currency=usd&ids=${ids}&sparkline=false&price_change_percentage=24h`);
                    const pd = await pr.json();
                    pd.forEach(p => priceMap[p.id] = p);
                } catch(_) {}
            }
            tokens = (d.coins||[]).map((c,i) => {
                const pm = priceMap[c.item.id] || {};
                return { id: c.item.id, name: c.item.name, symbol: c.item.symbol, image: c.item.small, rank: i+1,
                    market_cap_rank: pm.market_cap_rank||c.item.market_cap_rank,
                    current_price: pm.current_price, price_change_percentage_24h: pm.price_change_percentage_24h,
                    market_cap: pm.market_cap };
            });
        }

        if (!tokens.length) { el.innerHTML = '<div class="state"><span class="material-symbols-rounded">trending_flat</span><p>No trending data</p></div>'; return; }
        trLoaded = true;

        // Split into gainers and losers
        const withPrice = tokens.filter(t => t.price_change_percentage_24h != null);
        const gainers = [...withPrice].sort((a,b) => (b.price_change_percentage_24h||0)-(a.price_change_percentage_24h||0)).slice(0,5);
        const losers = [...withPrice].sort((a,b) => (a.price_change_percentage_24h||0)-(b.price_change_percentage_24h||0)).slice(0,5);

        el.innerHTML = `
            <div class="sec-h"><span class="material-symbols-rounded">whatshot</span>Trending coins</div>
            <div class="t-grid">${tokens.slice(0,12).map((t,i) => `
                <div class="t-card" onclick="${t.id?`showDet('${t.id}')`:''}">
                    <div class="t-rank">#${t.rank||i+1} Trending</div>
                    <div class="ci" style="margin-bottom:8px;">
                        <div class="ci-icon"><img src="${t.image||''}" alt="${t.symbol||''}" onerror="this.replaceWith(document.createTextNode('${(t.symbol||'?').charAt(0).toUpperCase()}'))"></div>
                        <div><div class="ci-name">${t.name||'?'}</div><div class="ci-sym">${t.symbol||''}</div></div>
                    </div>
                    <div class="t-stats">
                        ${t.current_price!=null ? `<div><div class="ts-l">Price</div><div class="ts-v">${fmtP(t.current_price)}</div></div>` : ''}
                        ${t.price_change_percentage_24h!=null ? `<div><div class="ts-l">24h</div><div class="ts-v">${pct(t.price_change_percentage_24h)}</div></div>` : ''}
                        ${t.market_cap ? `<div><div class="ts-l">Mkt Cap</div><div class="ts-v">$${fmtNum(t.market_cap)}</div></div>` : ''}
                    </div>
                </div>`).join('')}
            </div>
            ${gainers.length ? `
                <div class="sec-h" style="margin-top:8px;"><span class="material-symbols-rounded">rocket_launch</span>Top Gainers</div>
                <div style="padding:0 14px 8px;">${gainers.map(t => `
                    <div class="h-row" style="cursor:pointer;" onclick="${t.id?`showDet('${t.id}')`:''}">
                        <div class="h-left">
                            <div class="ci-icon"><img src="${t.image||''}" alt="${t.symbol||''}" onerror="this.parentElement.textContent='${(t.symbol||'?').charAt(0)}'"></div>
                            <div><div class="ci-name">${t.name}</div><div class="ci-sym">${t.symbol}</div></div>
                        </div>
                        <div class="h-right">${pct(t.price_change_percentage_24h)}</div>
                    </div>`).join('')}
                </div>` : ''}
            ${losers.length ? `
                <div class="sec-h"><span class="material-symbols-rounded">trending_down</span>Top Losers</div>
                <div style="padding:0 14px 14px;">${losers.map(t => `
                    <div class="h-row" style="cursor:pointer;" onclick="${t.id?`showDet('${t.id}')`:''}">
                        <div class="h-left">
                            <div class="ci-icon"><img src="${t.image||''}" alt="${t.symbol||''}" onerror="this.parentElement.textContent='${(t.symbol||'?').charAt(0)}'"></div>
                            <div><div class="ci-name">${t.name}</div><div class="ci-sym">${t.symbol}</div></div>
                        </div>
                        <div class="h-right">${pct(t.price_change_percentage_24h)}</div>
                    </div>`).join('')}
                </div>` : ''}
        `;
    } catch(e) {
        el.innerHTML = `<div class="state"><span class="material-symbols-rounded">error</span><p>Failed to load trending</p><button class="retry" onclick="trLoaded=false;loadTrending()">Retry</button></div>`;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â• Gas Tracker â•â•â•â•â•â•â•â•â•â•â• */
async function loadGas() {
    const el = document.getElementById('gasContent');
    const chains = [
        { name:'Ethereum', color:'#627eea', unit:'gwei' },
        { name:'BSC', color:'#f3ba2f', unit:'gwei' },
        { name:'Polygon', color:'#8247e5', unit:'gwei' },
        { name:'Arbitrum', color:'#28a0f0', unit:'gwei' },
        { name:'Base', color:'#0052ff', unit:'gwei' },
        { name:'Avalanche', color:'#e84142', unit:'nAVAX' },
        { name:'Optimism', color:'#ff0420', unit:'gwei' },
        { name:'Monad', color:'#a855f7', unit:'gwei' },
        { name:'Solana', color:'#14f195', unit:'lamports' },
    ];

    // Try to get real ETH gas from Etherscan v2 (free, no key needed)
    let ethGas = null;
    try {
        const r = await cfetch('https://api.etherscan.io/api?module=gastracker&action=gasoracle');
        if (r.ok) {
            const d = await r.json();
            if (d.result) {
                ethGas = {
                    slow: parseFloat(d.result.SafeGasPrice)||15,
                    standard: parseFloat(d.result.ProposeGasPrice)||25,
                    fast: parseFloat(d.result.FastGasPrice)||40,
                    baseFee: parseFloat(d.result.suggestBaseFee)||20,
                    block: d.result.LastBlock
                };
            }
        }
    } catch(_){}

    // Get ETH price for cost estimates
    let ethPrice = 0;
    try {
        const r = await cfetch(`${CG}/simple/price?ids=ethereum&vs_currencies=usd`);
        const d = await r.json();
        ethPrice = d?.ethereum?.usd || 0;
    } catch(_){}

    const gasData = chains.map(c => {
        if (c.name==='Ethereum' && ethGas) return { ...c, slow: ethGas.slow, standard: ethGas.standard, fast: ethGas.fast, baseFee: ethGas.baseFee, block: ethGas.block };
        // Estimates for other chains (static fallbacks â€” labeled as estimated in the UI)
        const est = { BSC:[3,5,7], Polygon:[30,50,80], Arbitrum:[0.1,0.1,0.25], Base:[0.005,0.01,0.05],
            Avalanche:[25,30,40], Optimism:[0.005,0.01,0.05], Monad:[0.5,1,2], Solana:[5000,5000,10000] };
        const v = est[c.name]||[1,2,5];
        return { ...c, slow: v[0], standard: v[1], fast: v[2], estimated: true };
    });

    const txTypes = [
        { label: 'Transfer', gas: 21000 },
        { label: 'Swap', gas: 150000 },
        { label: 'NFT Mint', gas: 85000 },
        { label: 'Contract', gas: 200000 }
    ];

    el.innerHTML = `
        <div class="sec-h"><span class="material-symbols-rounded">local_gas_station</span>Gas prices across chains</div>
        <div class="g-grid">${gasData.map(c => `
            <div class="g-card">
                <div class="g-head"><div class="g-dot" style="background:${c.color}"></div><div class="g-name">${c.name}${c.estimated ? ' <span style="font-size:9px;opacity:0.35;font-weight:400;">est.</span>' : ''}</div></div>
                <div class="g-row"><span class="g-label">ğŸ¢ Slow</span><span class="g-val">${c.slow} ${c.unit}</span></div>
                <div class="g-row"><span class="g-label">ğŸš— Standard</span><span class="g-val">${c.standard} ${c.unit}</span></div>
                <div class="g-row"><span class="g-label">âš¡ Fast</span><span class="g-val">${c.fast} ${c.unit}</span></div>
                ${c.baseFee ? `<div class="g-row" style="margin-top:4px;border-top:1px solid rgba(255,255,255,0.05);padding-top:6px;"><span class="g-label">Base Fee</span><span class="g-val">${c.baseFee.toFixed(2)} gwei</span></div>` : ''}
            </div>`).join('')}
        </div>
        ${ethGas && ethPrice ? `
            <div class="sec-h"><span class="material-symbols-rounded">receipt_long</span>Estimated ETH TX costs (at ${ethGas.standard} gwei)</div>
            <div class="g-grid">${txTypes.map(t => {
                const cost = (ethGas.standard * t.gas / 1e9) * ethPrice;
                return `<div class="g-card">
                    <div class="g-name" style="margin-bottom:6px;">${t.label}</div>
                    <div class="g-row"><span class="g-label">Gas Limit</span><span class="g-val">${(t.gas/1000).toFixed(0)}K</span></div>
                    <div class="g-row"><span class="g-label">Cost</span><span class="g-val up">$${cost.toFixed(2)}</span></div>
                </div>`;
            }).join('')}</div>
            <div style="padding:4px 14px 14px;font-size:10px;color:#444;">
                Block #${ethGas.block||'?'} Â· ETH $${ethPrice.toLocaleString()} Â· Updates every fetch
            </div>
        ` : ''}
    `;
}

/* â•â•â•â•â•â•â•â•â•â•â• Whale Alerts â•â•â•â•â•â•â•â•â•â•â• */
async function loadWhales() {
    const el = document.getElementById('whaleContent');
    try {
        // Try Lair API
        let alerts = [];
        try {
            const r = await fetch(`${API}/api/market/overview`);
            if (r.ok) {
                const d = await r.json();
                if (d.whaleAlerts) alerts = d.whaleAlerts;
            }
        } catch(_) {}

        // Show empty state if no real data available
        if (!alerts.length) {
            el.innerHTML = `<div class="state"><span class="material-symbols-rounded">water</span><p>No whale alerts available</p><p style="font-size:11px;color:#555;">Waiting for real-time data from Lair API</p><button class="retry" onclick="loadWhales()">Retry</button></div>`;
            return;
        }

        const icons = { exchange_deposit:'â†“', exchange_withdrawal:'â†‘', whale_transfer:'â†”' };
        const colors = { exchange_deposit:'#ef4444', exchange_withdrawal:'#5be45b', whale_transfer:'#6179ff' };

        const totalVal = alerts.reduce((s,a) => s+(a.amountUsd||0), 0);
        const deps = alerts.filter(a => a.transactionType==='exchange_deposit').length;
        const withs = alerts.filter(a => a.transactionType==='exchange_withdrawal').length;

        el.innerHTML = `
            <div class="sec-h"><span class="material-symbols-rounded">water</span>Whale Alerts Â· <span class="cdot on"></span> Live</div>
            <div class="g-grid" style="padding-bottom:8px;">
                <div class="g-card"><div class="g-label" style="font-size:10px;color:#555;">Transactions</div><div class="g-name" style="margin-top:4px;">${alerts.length}</div></div>
                <div class="g-card"><div class="g-label" style="font-size:10px;color:#555;">Total Value</div><div class="g-name" style="margin-top:4px;">$${fmtNum(totalVal)}</div></div>
                <div class="g-card"><div class="g-label" style="font-size:10px;color:#555;">Deposits</div><div class="g-name dn" style="margin-top:4px;">${deps}</div></div>
                <div class="g-card"><div class="g-label" style="font-size:10px;color:#555;">Withdrawals</div><div class="g-name up" style="margin-top:4px;">${withs}</div></div>
            </div>
            <div class="w-list">${alerts.map(a => `
                <div class="w-alert ${a.significance||''}">
                    <div class="w-icon" style="color:${colors[a.transactionType]||'#6179ff'}">${icons[a.transactionType]||'Â·'}</div>
                    <div class="w-body">
                        <div class="w-headline">${a.amount?.toLocaleString()||'?'} ${a.symbol} <span class="muted" style="font-size:11px;">($${fmtNum(a.amountUsd)})</span></div>
                        <div class="w-detail">${a.from?.owner||'Unknown'} â†’ ${a.to?.owner||'Unknown'} Â· ${a.blockchain||'?'}</div>
                    </div>
                    <div class="w-time">${a.timestamp ? timeAgo(a.timestamp) : ''}</div>
                </div>`).join('')}
            </div>
        `;
    } catch(e) {
        el.innerHTML = `<div class="state"><span class="material-symbols-rounded">error</span><p>Failed to load whale alerts</p><button class="retry" onclick="loadWhales()">Retry</button></div>`;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â• Portfolio â•â•â•â•â•â•â•â•â•â•â• */
async function loadPortfolio() {
    const addr = document.getElementById('wAddr').value.trim();
    if (!addr) return;
    const list = document.getElementById('pList');
    list.innerHTML = '<div class="state" style="padding:20px;"><div class="spinner"></div></div>';
    try {
        const r = await fetch(`${API}/api/portfolio/summary/${addr}`);
        if (!r.ok) throw new Error('API '+r.status);
        const {data} = await r.json();
        document.getElementById('pTotal').textContent = '$'+(data.totalValueUsd||0).toLocaleString('en',{maximumFractionDigits:2});
        document.getElementById('pSub').innerHTML = pct(data.change24h||0);
        if (data.balances?.length) {
            list.innerHTML = data.balances.map(b => `
                <div class="h-row">
                    <div class="h-left">
                        <div class="ci-icon" style="width:32px;height:32px;">${(b.symbol||'?').charAt(0)}</div>
                        <div><div class="ci-name">${b.symbol||'Unknown'}</div><div class="ci-sym">${b.chain||''}</div></div>
                    </div>
                    <div class="h-right">
                        <div class="h-val">${fmtP(b.valueUsd||0)}</div>
                        <div class="h-amt">${b.balance||0} ${b.symbol||''}</div>
                    </div>
                </div>`).join('');
        } else {
            list.innerHTML = '<div class="state" style="padding:30px;"><span class="material-symbols-rounded">account_balance_wallet</span><p>No holdings found</p></div>';
        }
    } catch(e) {
        document.getElementById('pTotal').textContent = 'Portfolio';
        document.getElementById('pSub').textContent = 'Could not fetch portfolio data';
        list.innerHTML = `<div class="state" style="padding:30px;"><span class="material-symbols-rounded">account_balance_wallet</span><p>Enter a valid EVM address or ENS name</p><p class="sub">Portfolio data requires the Lair API server</p></div>`;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â• Coin Detail â•â•â•â•â•â•â•â•â•â•â• */
async function showDet(id) {
    const overlay = document.getElementById('det');
    const info = document.getElementById('dInfo');
    const body = document.getElementById('dBody');
    overlay.classList.add('show');
    body.innerHTML = '<div class="state"><div class="spinner"></div></div>';
    try {
        const r = await cfetch(`${CG}/coins/${id}?localization=false&tickers=false&community_data=false&developer_data=false&sparkline=true`);
        if (!r.ok) throw new Error('Not found');
        const c = await r.json();
        const md = c.market_data||{};

        info.innerHTML = `
            <div class="ci-icon" style="width:32px;height:32px;">${c.image?.small ? `<img src="${c.image.small}" alt="${c.symbol}">` : (c.symbol||'?').charAt(0).toUpperCase()}</div>
            <div><div class="ci-name">${c.name}</div><div class="ci-sym">${c.symbol?.toUpperCase()} Â· #${c.market_cap_rank||'â€”'}</div></div>`;

        body.innerHTML = `
            <div style="margin-bottom:16px;">
                <span class="d-price">${fmtP(md.current_price?.usd)}</span>
                <span class="d-change ${(md.price_change_percentage_24h||0)>=0?'up':'dn'}">${(md.price_change_percentage_24h||0)>=0?'â–²':'â–¼'} ${Math.abs(md.price_change_percentage_24h||0).toFixed(2)}%</span>
            </div>
            <div class="d-grid">
                <div class="d-stat"><div class="d-stat-l">Market Cap</div><div class="d-stat-v">$${fmtNum(md.market_cap?.usd)}</div></div>
                <div class="d-stat"><div class="d-stat-l">24h Volume</div><div class="d-stat-v">$${fmtNum(md.total_volume?.usd)}</div></div>
                <div class="d-stat"><div class="d-stat-l">24h High</div><div class="d-stat-v">${fmtP(md.high_24h?.usd)}</div></div>
                <div class="d-stat"><div class="d-stat-l">24h Low</div><div class="d-stat-v">${fmtP(md.low_24h?.usd)}</div></div>
                <div class="d-stat"><div class="d-stat-l">Circulating</div><div class="d-stat-v">${md.circulating_supply ? fmtNum(md.circulating_supply) : 'â€”'}</div></div>
                <div class="d-stat"><div class="d-stat-l">All-Time High</div><div class="d-stat-v">${fmtP(md.ath?.usd)}</div></div>
                <div class="d-stat"><div class="d-stat-l">ATH Change</div><div class="d-stat-v">${pct(md.ath_change_percentage?.usd)}</div></div>
                <div class="d-stat"><div class="d-stat-l">7d Change</div><div class="d-stat-v">${pct(md.price_change_percentage_7d)}</div></div>
                <div class="d-stat"><div class="d-stat-l">30d Change</div><div class="d-stat-v">${pct(md.price_change_percentage_30d)}</div></div>
                <div class="d-stat"><div class="d-stat-l">1y Change</div><div class="d-stat-v">${pct(md.price_change_percentage_1y)}</div></div>
            </div>
            ${c.sparkline_in_7d?.price ? `
                <div style="margin:8px 0 16px;"><canvas id="detSpark" style="width:100%;height:80px;"></canvas></div>
            ` : ''}
            ${c.description?.en ? `<div style="margin-top:12px;">
                <div style="font-size:13px;font-weight:600;margin-bottom:6px;">About ${c.name}</div>
                <p style="font-size:11px;color:#aaa;line-height:1.6;">${c.description.en.replace(/<[^>]+>/g,'').slice(0,600)}${c.description.en.length>600?'â€¦':''}</p>
            </div>` : ''}
            ${c.links?.homepage?.[0] ? `<div style="margin-top:12px;display:flex;gap:6px;flex-wrap:wrap;">
                <a href="${c.links.homepage[0]}" target="_blank" class="badge badge-blue"><span class="material-symbols-rounded" style="font-size:13px;">language</span> Website</a>
                ${c.links?.blockchain_site?.[0] ? `<a href="${c.links.blockchain_site[0]}" target="_blank" class="badge badge-up"><span class="material-symbols-rounded" style="font-size:13px;">open_in_new</span> Explorer</a>` : ''}
            </div>` : ''}
        `;
        // Draw detail sparkline
        requestAnimationFrame(() => {
            const cv = document.getElementById('detSpark');
            if (cv && c.sparkline_in_7d?.price) {
                const w = cv.parentElement.offsetWidth;
                cv.width = w; cv.height = 80;
                const data = c.sparkline_in_7d.price;
                const ctx = cv.getContext('2d');
                const min = Math.min(...data), max = Math.max(...data), range = max-min||1;
                // Gradient fill
                const grad = ctx.createLinearGradient(0,0,0,80);
                const clr = (md.price_change_percentage_7d||0)>=0 ? [91,228,91] : [239,68,68];
                grad.addColorStop(0, `rgba(${clr},0.2)`);
                grad.addColorStop(1, `rgba(${clr},0)`);
                ctx.beginPath();
                data.forEach((v,i) => {
                    const x=(i/(data.length-1))*w, y=80-((v-min)/range)*72-4;
                    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
                });
                ctx.lineTo(w,80); ctx.lineTo(0,80); ctx.closePath();
                ctx.fillStyle = grad; ctx.fill();
                // Line
                ctx.beginPath(); ctx.strokeStyle = `rgb(${clr})`; ctx.lineWidth = 1.5;
                data.forEach((v,i) => {
                    const x=(i/(data.length-1))*w, y=80-((v-min)/range)*72-4;
                    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
                }); ctx.stroke();
            }
        });
    } catch(e) {
        body.innerHTML = `<div class="state"><span class="material-symbols-rounded">error</span><p>Could not load coin details</p><button class="retry" onclick="showDet('${id}')">Retry</button></div>`;
    }
}
function closeDet() { document.getElementById('det').classList.remove('show'); }

/* â•â•â•â•â•â•â•â•â•â•â• Lair Launches â•â•â•â•â•â•â•â•â•â•â• */
async function loadLaunches() {
    if (lcLoaded) return;
    const el = document.getElementById('lcGrid');
    try {
        const r = await fetch(`${API}/api/coins`);
        if (!r.ok) throw new Error('API '+r.status);
        const d = await r.json();
        lairCoins = d.success ? (d.data||[]) : (Array.isArray(d) ? d : []);
        lcLoaded = true;
        renderLaunches();
    } catch(e) {
        el.innerHTML = `<div class="state"><span class="material-symbols-rounded">rocket</span><p>Could not load launches</p><p class="sub">${e.message} â€” Is the Lair API running?</p><button class="retry" onclick="lcLoaded=false;loadLaunches()">Retry</button></div>`;
    }
}

function renderLaunches() {
    const el = document.getElementById('lcGrid');
    const q = (document.getElementById('lcSearch')?.value||'').toLowerCase();
    const f = document.getElementById('lcFilter')?.value||'all';
    let list = lairCoins;
    if (q) list = list.filter(c => (c.name||'').toLowerCase().includes(q)||(c.ticker||'').toLowerCase().includes(q));
    if (f!=='all') list = list.filter(c => c.status===f);
    if (!list.length) {
        el.innerHTML = `<div class="state"><span class="material-symbols-rounded">rocket_launch</span><p>${lairCoins.length?'No coins match filter':'No coins launched yet'}</p><p class="sub">Launch a coin via @LairCopilotBot on Telegram</p></div>`;
        return;
    }
    el.innerHTML = `<div class="lc-grid">${list.map(c => {
        const rxEntries = Object.entries(c.reactions||{}).sort(([,a],[,b])=>b-a).slice(0,6);
        const statusLabel = c.status==='minting'?'ğŸ”„ Minting':c.status==='launched'?'ğŸš€ Launched':'âŒ Failed';
        return `
        <div class="lc-card" data-cid="${c.id}" onclick="showLairCoin(${c.id})">
            <div class="lc-hero">
                ${c.image_url ? `<img src="${c.image_url}" alt="${c.name}" onerror="this.outerHTML='<div class=lc-avatar>${(c.ticker||'?').charAt(0)}</div>'">`
                    : `<div class="lc-avatar">${(c.ticker||'?').charAt(0)}</div>`}
                <div class="lc-status ${c.status}">${statusLabel}</div>
            </div>
            <div class="lc-body">
                <div style="display:flex;align-items:baseline;gap:6px;">
                    <span class="lc-title">${c.ticker||'?'}</span>
                    <span class="lc-ticker">${c.name||''}</span>
                </div>
                <div class="lc-creator">
                    <span class="lc-creator-dot">${(c.creator_username||'?').charAt(0).toUpperCase()}</span>
                    ${c.creator_username||'Anonymous'}
                </div>
                <div class="lc-metrics">
                    <span>ğŸ’¬ ${c.replies_count||0}</span>
                    <span>â†—ï¸ ${c.forwards_count||0}</span>
                    <span>âš¡ ${c.current_engagement||0}</span>
                </div>
                ${rxEntries.length ? `<div class="lc-reactions">${rxEntries.map(([e,n])=>`<div class="lc-rx"><span>${e}</span><span class="lc-rx-count">${n}</span></div>`).join('')}</div>` : ''}
                <div class="lc-progress">
                    <div class="lc-progress-header"><span>Progress</span><span>${Math.round(c.progress_percentage||0)}%</span></div>
                    <div class="lc-bar"><div class="lc-bar-fill" style="width:${c.progress_percentage||0}%"></div></div>
                </div>
                ${c.contract_address ? `<div class="lc-contract"><span>${shortAddr(c.contract_address)}</span><button class="lc-copy" onclick="event.stopPropagation();navigator.clipboard.writeText('${c.contract_address}')">content_copy</button></div>` : ''}
            </div>
        </div>`;
    }).join('')}</div>`;
}

function filterLaunches() { renderLaunches(); }

function showLairCoin(id) {
    const c = lairCoins.find(x => x.id===id);
    if (!c) return;
    const overlay = document.getElementById('det');
    const info = document.getElementById('dInfo');
    const body = document.getElementById('dBody');
    overlay.classList.add('show');
    const statusLabel = c.status==='minting'?'ğŸ”„ Minting':c.status==='launched'?'ğŸš€ Launched':'âŒ Failed';
    const statusCls = c.status;
    info.innerHTML = `
        <div class="ci-icon" style="width:32px;height:32px;">
            ${c.image_url ? `<img src="${c.image_url}" alt="${c.name}">` : (c.ticker||'?').charAt(0).toUpperCase()}
        </div>
        <div><div class="ci-name">${c.name||c.ticker}</div><div class="ci-sym">${c.ticker} Â· <span class="lc-status ${statusCls}" style="position:static;">${statusLabel}</span></div></div>`;

    const rxEntries = Object.entries(c.reactions||{}).sort(([,a],[,b])=>b-a);
    body.innerHTML = `
        <div class="lcd-stats">
            <div class="lcd-stat"><div class="lcd-stat-v">${Math.round(c.progress_percentage||0)}%</div><div class="lcd-stat-l">Progress</div></div>
            <div class="lcd-stat"><div class="lcd-stat-v">${c.current_engagement||0}</div><div class="lcd-stat-l">Engagement</div></div>
            <div class="lcd-stat"><div class="lcd-stat-v">${c.replies_count||0}</div><div class="lcd-stat-l">Replies</div></div>
            <div class="lcd-stat"><div class="lcd-stat-v">${c.forwards_count||0}</div><div class="lcd-stat-l">Forwards</div></div>
        </div>
        <div style="margin:16px 0;">
            <div style="display:flex;justify-content:space-between;font-size:12px;color:#888;margin-bottom:6px;">
                <span>${c.current_engagement||0} / ${c.launch_threshold||'?'}</span>
                <span>${Math.round(c.progress_percentage||0)}%</span>
            </div>
            <div class="lcd-bar-lg"><div class="lcd-bar-lg-fill" style="width:${c.progress_percentage||0}%"></div></div>
        </div>
        ${rxEntries.length ? `
            <div style="font-size:13px;font-weight:600;margin-bottom:8px;">Reactions</div>
            <div class="lcd-reactions">${rxEntries.map(([emoji,count])=>`<div class="lcd-rx"><span>${emoji}</span><span class="count">${count}</span></div>`).join('')}</div>
        ` : ''}
        ${c.contract_address ? `
            <div style="font-size:13px;font-weight:600;margin-top:16px;margin-bottom:8px;">Contract Address</div>
            <div class="lcd-contract">
                <div class="lcd-addr">${c.contract_address}</div>
                <button class="lcd-copy-btn" onclick="navigator.clipboard.writeText('${c.contract_address}');this.textContent='Copied!';setTimeout(()=>this.textContent='ğŸ“‹ Copy',2000)">ğŸ“‹ Copy</button>
            </div>
            <div style="margin-top:8px;"><a href="https://blockscan.com/address/${c.contract_address}" target="_blank" style="font-size:12px;">View on Explorer â†’</a></div>
        ` : ''}
        <div class="lcd-meta">
            <div style="font-size:13px;font-weight:600;margin-bottom:6px;margin-top:16px;">Details</div>
            <div class="lcd-meta-row"><span class="lcd-meta-l">Creator</span><span class="lcd-meta-v">${c.creator_username||'Anonymous'}</span></div>
            <div class="lcd-meta-row"><span class="lcd-meta-l">Created</span><span class="lcd-meta-v">${c.created_at ? new Date(c.created_at).toLocaleDateString() : 'â€”'}</span></div>
            <div class="lcd-meta-row"><span class="lcd-meta-l">Launch Threshold</span><span class="lcd-meta-v">${c.launch_threshold||'â€”'}</span></div>
            ${c.launched_at ? `<div class="lcd-meta-row"><span class="lcd-meta-l">Launched</span><span class="lcd-meta-v">${new Date(c.launched_at).toLocaleDateString()}</span></div>` : ''}
            <div class="lcd-meta-row"><span class="lcd-meta-l">Telegram Chat</span><span class="lcd-meta-v">${c.telegram_chat_id||'â€”'}</span></div>
        </div>
    `;
}

/* â•â•â•â•â•â•â•â•â•â•â• WebSocket â•â•â•â•â•â•â•â•â•â•â• */
function handleEngagementUpdate(data) {
    // Update lairCoins array
    const idx = lairCoins.findIndex(c => c.id === data.coin_id);
    if (idx !== -1) {
        lairCoins[idx].current_engagement = data.current_engagement;
        lairCoins[idx].progress_percentage = data.progress_percentage;
        lairCoins[idx].reactions = data.reactions;
        lairCoins[idx].forwards_count = data.forwards_count;
        lairCoins[idx].replies_count = data.replies_count;
    }
    // If launches tab is active, re-render
    const launchPanel = document.getElementById('p-launches');
    if (launchPanel && launchPanel.classList.contains('active')) {
        // Targeted DOM update for performance
        const card = document.querySelector(`.lc-card[data-cid="${data.coin_id}"]`);
        if (card) {
            const metrics = card.querySelector('.lc-metrics');
            if (metrics) metrics.innerHTML = `<span>ğŸ’¬ ${data.replies_count||0}</span><span>â†—ï¸ ${data.forwards_count||0}</span><span>âš¡ ${data.current_engagement||0}</span>`;
            const barFill = card.querySelector('.lc-bar-fill');
            if (barFill) barFill.style.width = (data.progress_percentage||0)+'%';
            const progHeader = card.querySelector('.lc-progress-header');
            if (progHeader) progHeader.innerHTML = `<span>Progress</span><span>${Math.round(data.progress_percentage||0)}%</span>`;
            // Update reactions
            const rxEntries = Object.entries(data.reactions||{}).sort(([,a],[,b])=>b-a).slice(0,6);
            const rxContainer = card.querySelector('.lc-reactions');
            if (rxContainer) rxContainer.innerHTML = rxEntries.map(([e,n])=>`<div class="lc-rx"><span>${e}</span><span class="lc-rx-count">${n}</span></div>`).join('');
        }
    }
}

function handleCoinCreated(data) {
    // Add new coin to list and re-render if on launches tab
    if (data && data.id) {
        lairCoins.unshift(data);
        const launchPanel = document.getElementById('p-launches');
        if (launchPanel && launchPanel.classList.contains('active')) renderLaunches();
    }
}

let wsRetries = 0;
const WS_MAX_RETRIES = 5;
function connectWS() {
    const dot = document.getElementById('cDot');
    const st = document.getElementById('cSt');
    if (!dot || !st) return;
    // Don't attempt WS if API is the default placeholder and not reachable
    if (!API || API.includes('vercel.app')) {
        dot.className='cdot off'; st.textContent='No WS';
        return;
    }
    if (wsRetries >= WS_MAX_RETRIES) {
        dot.className='cdot off'; st.textContent='Offline';
        console.warn('[WS] Max retries reached, giving up');
        return;
    }
    try {
        ws = new WebSocket(API.replace('http','ws')+'/ws');
        ws.onopen = () => { wsRetries=0; dot.className='cdot on'; st.textContent='Live'; };
        ws.onmessage = (ev) => {
            try {
                const m = JSON.parse(ev.data);
                if (m.type==='engagement_update') handleEngagementUpdate(m.data);
                else if (m.type==='coin_created') handleCoinCreated(m.data);
                else if (m.type==='deployment_status') { /* deployment status received */ }
            } catch(_) {}
        };
        ws.onclose = () => { wsRetries++; dot.className='cdot off'; st.textContent='Offline'; setTimeout(connectWS, Math.min(5000*Math.pow(2,wsRetries),60000)); };
        ws.onerror = () => { dot.className='cdot off'; st.textContent='Offline'; };
    } catch(_) { dot.className='cdot off'; st.textContent='Offline'; }
}

/* â•â•â•â•â•â•â•â•â•â•â• Init â•â•â•â•â•â•â•â•â•â•â• */
async function greenflag() {
    loadMarkets(); loadStats(); connectWS();
    setInterval(() => { loadMarkets(); loadStats(); }, 60000);
}
if (!window.myWindow) document.addEventListener('DOMContentLoaded', greenflag);
</script>
</body>
</html>
