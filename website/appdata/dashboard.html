<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="lair-include" content="lair.css">
    <meta name="lair-icon" content="<svg width='232' height='232' viewBox='0 0 232 232' fill='none' xmlns='http://www.w3.org/2000/svg'><rect width='232' height='232' rx='40' fill='#6366f1'/><rect x='24' y='24' width='86' height='86' rx='14' fill='white' opacity='0.9'/><rect x='122' y='24' width='86' height='40' rx='14' fill='white' opacity='0.7'/><rect x='122' y='76' width='86' height='34' rx='14' fill='#00d4aa' opacity='0.8'/><rect x='24' y='122' width='40' height='86' rx='14' fill='white' opacity='0.7'/><rect x='76' y='122' width='34' height='86' rx='14' fill='#fbbf24' opacity='0.8'/><rect x='122' y='122' width='86' height='86' rx='14' fill='white' opacity='0.9'/></svg>">
    <title>Lair Dashboard</title>
    <link rel="stylesheet" href="../libs/lair-components.css">
    <script src="../libs/lair-components.js"></script>
    <style>
        :root {
            color-scheme: dark;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at 20% 0%, rgba(99, 102, 241, 0.18), transparent 48%), #05060a;
            color: #f5f7ff;
            min-height: 100vh;
            overflow: auto;
        }

        .container {
            width: min(1400px, 100% - 24px);
            margin: 12px auto;
            padding: 4px;
        }

        .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .subtitle {
            color: #9ea4bb;
            font-size: 12px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            gap: 10px;
            grid-template-areas:
                "portfolio portfolio portfolio portfolio market market market market fear fear fear fear"
                "ticker ticker ticker ticker ticker ticker ticker ticker ticker ticker ticker ticker"
                "trending trending trending trending trending trending whales whales whales whales whales whales"
                "gas gas gas gas gas gas yields yields yields yields yields yields"
                "news news news news news news news news news news news news";
        }

        .card {
            background: linear-gradient(180deg, rgba(20, 23, 36, 0.95), rgba(11, 13, 22, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 14px;
            min-height: 112px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        }

        .card h3 {
            font-size: 13px;
            color: #b6bcce;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .updated {
            font-size: 11px;
            color: #7f879c;
            font-weight: 500;
        }

        .value {
            font-size: clamp(22px, 2vw, 30px);
            font-weight: 700;
            margin-bottom: 4px;
        }

        .muted {
            color: #9ea4bb;
            font-size: 12px;
        }

        .pill-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .pill {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            padding: 4px 9px;
            font-size: 11px;
            color: #c7ccdd;
            white-space: nowrap;
        }

        .loading,
        .error {
            min-height: 68px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            text-align: center;
            padding: 8px;
        }

        .loading {
            color: #9ea4bb;
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed rgba(255, 255, 255, 0.11);
        }

        .error {
            color: #fecaca;
            background: rgba(220, 38, 38, 0.12);
            border: 1px solid rgba(220, 38, 38, 0.32);
        }

        .positive {
            color: #22c55e;
        }

        .negative {
            color: #ef4444;
        }

        .ticker-track {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: thin;
        }

        .ticker-item {
            flex: 0 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.04);
            border-radius: 10px;
            padding: 7px 10px;
            min-width: 132px;
        }

        .ticker-item .symbol {
            font-size: 11px;
            color: #b9bfd2;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .ticker-item .price {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .list {
            display: grid;
            gap: 8px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 8px 10px;
        }

        .row-title {
            font-size: 12px;
            font-weight: 600;
        }

        .row-sub {
            margin-top: 2px;
            font-size: 11px;
            color: #9ea4bb;
        }

        .row-right {
            font-size: 12px;
            font-weight: 600;
            text-align: right;
        }

        .news-list {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .news-item {
            display: block;
            text-decoration: none;
            color: inherit;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 10px;
            transition: border-color 0.2s ease;
        }

        .news-item:hover {
            border-color: rgba(99, 102, 241, 0.7);
        }

        .news-source {
            font-size: 11px;
            color: #9ea4bb;
            margin-bottom: 4px;
        }

        .news-title {
            font-size: 12px;
            line-height: 1.35;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .news-time {
            font-size: 11px;
            color: #7f879c;
        }

        .portfolio { grid-area: portfolio; }
        .market { grid-area: market; }
        .fear { grid-area: fear; }
        .ticker { grid-area: ticker; }
        .trending { grid-area: trending; }
        .whales { grid-area: whales; }
        .gas { grid-area: gas; }
        .yields { grid-area: yields; }
        .news { grid-area: news; }

        @media (max-width: 1160px) {
            .grid {
                grid-template-areas:
                    "portfolio portfolio portfolio portfolio market market market market fear fear fear fear"
                    "ticker ticker ticker ticker ticker ticker ticker ticker ticker ticker ticker ticker"
                    "trending trending trending trending trending trending trending trending trending trending trending trending"
                    "whales whales whales whales whales whales whales whales whales whales whales whales"
                    "gas gas gas gas gas gas yields yields yields yields yields yields"
                    "news news news news news news news news news news news news";
            }
        }

        @media (max-width: 860px) {
            .container {
                width: 100%;
                margin: 0;
                padding: 8px;
            }

            .title {
                font-size: 16px;
            }

            .subtitle {
                display: none;
            }

            .grid {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "portfolio"
                    "market"
                    "fear"
                    "ticker"
                    "trending"
                    "whales"
                    "gas"
                    "yields"
                    "news";
            }

            .news-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title-row">
            <div>
                <div class="title">LairOS Flagship Dashboard</div>
                <div class="subtitle">Real-time crypto intelligence across market, whale, gas, DeFi yield, and news feeds</div>
            </div>
            <div class="subtitle" id="global-updated">Last update: --</div>
        </div>

        <div class="grid">
            <section class="card portfolio">
                <h3>Portfolio — Total + PnL <span class="updated" id="portfolio-updated">--</span></h3>
                <div id="portfolio-content" class="loading">Loading portfolio...</div>
            </section>

            <section class="card market">
                <h3>Market Cap + BTC Dominance <span class="updated" id="market-updated">--</span></h3>
                <div id="market-content" class="loading">Loading global market data...</div>
            </section>

            <section class="card fear">
                <h3>Fear &amp; Greed Index <span class="updated" id="fear-updated">--</span></h3>
                <div id="fear-content" class="loading">Loading Fear &amp; Greed data...</div>
            </section>

            <section class="card ticker">
                <h3>Price Ticker (BTC, ETH, SOL + movers) <span class="updated" id="ticker-updated">--</span></h3>
                <div id="ticker-content" class="loading">Loading prices...</div>
            </section>

            <section class="card trending">
                <h3>Trending Tokens <span class="updated" id="trending-updated">--</span></h3>
                <div id="trending-content" class="loading">Loading trending tokens...</div>
            </section>

            <section class="card whales">
                <h3>Recent Whale Moves <span class="updated" id="whales-updated">--</span></h3>
                <div id="whales-content" class="loading">Loading whale transfers...</div>
            </section>

            <section class="card gas">
                <h3>Gas Prices (ETH / Base / Arbitrum) <span class="updated" id="gas-updated">--</span></h3>
                <div id="gas-content" class="loading">Loading gas prices...</div>
            </section>

            <section class="card yields">
                <h3>Top DeFi Yields <span class="updated" id="yields-updated">--</span></h3>
                <div id="yields-content" class="loading">Loading DeFi yields...</div>
            </section>

            <section class="card news">
                <h3>News Headlines (RSS + fallback parser) <span class="updated" id="news-updated">--</span></h3>
                <div id="news-content" class="loading">Loading news headlines...</div>
            </section>
        </div>
    </div>

    <script>
        (function () {
            if (typeof window.__lairDashboardCleanup === 'function') {
                window.__lairDashboardCleanup();
            }

            const state = {
                intervals: []
            };

            const FEEDS = [
                { source: 'CoinTelegraph', url: 'https://cointelegraph.com/rss' },
                { source: 'CoinDesk', url: 'https://www.coindesk.com/arc/outboundfeeds/rss/' },
                { source: 'Decrypt', url: 'https://decrypt.co/feed' }
            ];

            const fetchFn = window.cfetch || window.fetch.bind(window);
            const lairFetch = window.LairFetch;
            const lairUI = window.LairUI;
            const lairTheme = window.LairTheme;
            if (lairTheme) lairTheme.apply(document.body);

            function setUpdated(id) {
                const now = new Date();
                const stamp = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const node = document.getElementById(id);
                if (node) {
                    node.textContent = stamp;
                }
                const globalNode = document.getElementById('global-updated');
                if (globalNode) {
                    globalNode.textContent = `Last update: ${stamp}`;
                }
            }

            function escapeHtml(input) {
                return String(input || '')
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#39;');
            }

            function money(value) {
                const num = Number(value || 0);
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    notation: num >= 1_000_000_000 ? 'compact' : 'standard',
                    maximumFractionDigits: num >= 1 ? 2 : 6
                }).format(num);
            }

            function compact(value) {
                return new Intl.NumberFormat('en-US', {
                    notation: 'compact',
                    maximumFractionDigits: 2
                }).format(Number(value || 0));
            }

            function pct(value) {
                const num = Number(value || 0);
                const sign = num >= 0 ? '+' : '';
                return `${sign}${num.toFixed(2)}%`;
            }

            function relativeTime(dateInput) {
                const date = new Date(dateInput);
                if (Number.isNaN(date.getTime())) {
                    return 'just now';
                }
                const deltaSec = Math.max(0, Math.floor((Date.now() - date.getTime()) / 1000));
                if (deltaSec < 60) {
                    return `${deltaSec}s ago`;
                }
                const mins = Math.floor(deltaSec / 60);
                if (mins < 60) {
                    return `${mins}m ago`;
                }
                const hours = Math.floor(mins / 60);
                if (hours < 24) {
                    return `${hours}h ago`;
                }
                return `${Math.floor(hours / 24)}d ago`;
            }

            async function fetchJson(url, timeoutMs = 15000, options = {}) {
                if (lairFetch && (!options.method || options.method === 'GET')) {
                    return lairFetch.getJSON(url, {
                        cache: true,
                        ttl: 30000,
                        retries: 2,
                        fallback: true,
                        timeoutMs,
                        fetchOptions: options
                    });
                }

                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), timeoutMs);
                try {
                    const response = await fetchFn(url, {
                        ...options,
                        signal: controller.signal,
                        headers: {
                            Accept: 'application/json',
                            ...(options.headers || {})
                        }
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return await response.json();
                } finally {
                    clearTimeout(timeout);
                }
            }

            function setLoading(id, message) {
                const node = document.getElementById(id);
                if (!node) {
                    return;
                }
                if (lairUI && typeof lairUI.spinner === 'function') {
                    lairUI.spinner(node);
                    return;
                }
                node.className = 'loading';
                node.textContent = message;
            }

            function setError(id, error, label) {
                const node = document.getElementById(id);
                if (!node) {
                    return;
                }
                if (lairUI && typeof lairUI.error === 'function') {
                    lairUI.error(node, `${label}: ${error instanceof Error ? error.message : String(error)}`);
                    return;
                }
                node.className = 'error';
                node.textContent = `${label}: ${error instanceof Error ? error.message : String(error)}`;
            }

            function render(id, html) {
                const node = document.getElementById(id);
                if (!node) {
                    return;
                }
                node.className = '';
                node.innerHTML = html;
            }

            async function loadPortfolio() {
                const contentId = 'portfolio-content';
                try {
                    const rawAddress = localStorage.getItem('lair_dash_wallet') || localStorage.getItem('lair_wallet_address') || '';
                    const address = /^0x[a-fA-F0-9]{40}$/.test(rawAddress) ? rawAddress : '';

                    if (address) {
                        const data = await fetchJson(`https://api.ethplorer.io/getAddressInfo/${address}?apiKey=freekey`);
                        const ethBalance = Number(data?.ETH?.balance || 0);
                        const ethPrice = Number(data?.ETH?.price?.rate || 0);
                        const tokenUsd = Array.isArray(data?.tokens)
                            ? data.tokens.reduce((sum, token) => {
                                const balance = Number(token?.balance || 0) / Math.pow(10, Number(token?.tokenInfo?.decimals || 0));
                                const rate = Number(token?.tokenInfo?.price?.rate || 0);
                                return sum + (balance * rate);
                            }, 0)
                            : 0;
                        const totalValue = ethBalance * ethPrice + tokenUsd;
                        const ethDaily = Number(data?.ETH?.price?.diff || 0);

                        render(contentId, `
                            <div class="value">${money(totalValue)}</div>
                            <div class="muted">Wallet ${escapeHtml(address.slice(0, 6))}...${escapeHtml(address.slice(-4))}</div>
                            <div class="pill-row">
                                <span class="pill">ETH ${ethBalance.toFixed(4)}</span>
                                <span class="pill ${ethDaily >= 0 ? 'positive' : 'negative'}">ETH 24h ${pct(ethDaily)}</span>
                                <span class="pill">Assets tracked: ${Array.isArray(data?.tokens) ? data.tokens.length : 0}</span>
                            </div>
                        `);
                    } else {
                        const basket = await fetchJson('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,binancecoin,chainlink&vs_currencies=usd&include_24hr_change=true');
                        const entries = [
                            ['bitcoin', 0.12],
                            ['ethereum', 1.2],
                            ['solana', 8],
                            ['binancecoin', 1.5],
                            ['chainlink', 24]
                        ];
                        let total = 0;
                        let dayPnlPct = 0;

                        entries.forEach(([id, units]) => {
                            const price = Number(basket[id]?.usd || 0);
                            const change = Number(basket[id]?.usd_24h_change || 0);
                            const value = price * units;
                            total += value;
                            dayPnlPct += change;
                        });

                        const avgChange = dayPnlPct / entries.length;
                        render(contentId, `
                            <div class="value">${money(total)}</div>
                            <div class="muted">Market basket snapshot (set localStorage.lair_dash_wallet for wallet mode)</div>
                            <div class="pill-row">
                                <span class="pill ${avgChange >= 0 ? 'positive' : 'negative'}">24h PnL ${pct(avgChange)}</span>
                                <span class="pill">Holdings: BTC, ETH, SOL, BNB, LINK</span>
                            </div>
                        `);
                    }
                    setUpdated('portfolio-updated');
                } catch (error) {
                    setError(contentId, error, 'Portfolio feed unavailable');
                }
            }

            async function loadGlobalMarket() {
                const contentId = 'market-content';
                try {
                    const data = await fetchJson('https://api.coingecko.com/api/v3/global');
                    const market = data?.data || {};
                    const marketCap = Number(market?.total_market_cap?.usd || 0);
                    const volume = Number(market?.total_volume?.usd || 0);
                    const btcDom = Number(market?.market_cap_percentage?.btc || 0);

                    render(contentId, `
                        <div class="value">${money(marketCap)}</div>
                        <div class="pill-row">
                            <span class="pill">BTC Dominance: ${btcDom.toFixed(2)}%</span>
                            <span class="pill">24h Volume: ${money(volume)}</span>
                            <span class="pill">Active Coins: ${compact(market?.active_cryptocurrencies)}</span>
                        </div>
                    `);
                    setUpdated('market-updated');
                } catch (error) {
                    setError(contentId, error, 'Market cap feed unavailable');
                }
            }

            async function loadFearGreed() {
                const contentId = 'fear-content';
                try {
                    const data = await fetchJson('https://api.alternative.me/fng/?limit=1');
                    const item = Array.isArray(data?.data) ? data.data[0] : null;
                    if (!item) {
                        throw new Error('No index data');
                    }
                    const value = Number(item.value || 0);
                    const cls = value >= 60 ? 'positive' : value <= 40 ? 'negative' : '';

                    render(contentId, `
                        <div class="value ${cls}">${value}</div>
                        <div class="muted">${escapeHtml(item.value_classification || 'Unknown')}</div>
                        <div class="pill-row">
                            <span class="pill">Timestamp: ${relativeTime(Number(item.timestamp) * 1000)}</span>
                        </div>
                    `);
                    setUpdated('fear-updated');
                } catch (error) {
                    setError(contentId, error, 'Fear & Greed feed unavailable');
                }
            }

            async function loadTicker() {
                const contentId = 'ticker-content';
                try {
                    const markets = await fetchJson('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=20&page=1&sparkline=false&price_change_percentage=24h');
                    const majors = ['bitcoin', 'ethereum', 'solana'];
                    const majorItems = markets.filter((item) => majors.includes(item.id));
                    const movers = markets
                        .filter((item) => !majors.includes(item.id))
                        .sort((a, b) => Math.abs(Number(b.price_change_percentage_24h || 0)) - Math.abs(Number(a.price_change_percentage_24h || 0)))
                        .slice(0, 7);

                    const merged = [...majorItems, ...movers];
                    render(contentId, `
                        <div class="ticker-track">
                            ${merged.map((item) => {
                                const change = Number(item.price_change_percentage_24h || 0);
                                const renderedPrice = lairUI
                                    ? lairUI.price(Number(item.current_price || 0), change, { symbol: '$', decimals: Number(item.current_price || 0) >= 1 ? 2 : 6 })
                                    : money(item.current_price);
                                return `
                                    <div class="ticker-item">
                                        <div class="symbol">${escapeHtml(item.symbol)}</div>
                                        <div class="price">${renderedPrice}</div>
                                        <div class="${change >= 0 ? 'positive' : 'negative'}">${pct(change)}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `);
                    setUpdated('ticker-updated');
                } catch (error) {
                    setError(contentId, error, 'Ticker feed unavailable');
                }
            }

            async function loadTrending() {
                const contentId = 'trending-content';
                try {
                    const data = await fetchJson('https://api.coingecko.com/api/v3/search/trending');
                    const coins = (data?.coins || []).slice(0, 8);
                    if (!coins.length) {
                        throw new Error('No trending results');
                    }

                    if (lairUI && typeof lairUI.table === 'function') {
                        const ids = coins.map(({ item }) => item?.id).filter(Boolean);
                        const marketData = await fetchJson(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${encodeURIComponent(ids.join(','))}&order=market_cap_desc&sparkline=true&price_change_percentage=24h`);
                        const marketById = Array.isArray(marketData)
                            ? marketData.reduce((acc, item) => {
                                acc[item.id] = item;
                                return acc;
                            }, {})
                            : {};

                        const rows = coins.map(({ item }) => {
                            const market = marketById[item?.id] || {};
                            return {
                                symbol: item?.symbol || '',
                                icon: item?.small || '',
                                rank: item?.market_cap_rank || 0,
                                score: item?.score ?? '-',
                                price: Number(market?.current_price || 0),
                                change24h: Number(market?.price_change_percentage_24h || 0),
                                sparkline: market?.sparkline_in_7d?.price || [],
                                sparklineId: `trend-spark-${String(item?.id || '').replace(/[^a-zA-Z0-9_-]/g, '')}`
                            };
                        });

                        const node = document.getElementById(contentId);
                        lairUI.table(node, {
                            sortable: true,
                            columns: [
                                {
                                    key: 'symbol',
                                    label: 'Token',
                                    render: (_, row) => lairUI.tokenBadge(row.symbol, row.icon, 'cg')
                                },
                                {
                                    key: 'price',
                                    label: 'Price',
                                    render: (value, row) => lairUI.price(value, row.change24h, { symbol: '$', decimals: value >= 1 ? 2 : 6 })
                                },
                                { key: 'rank', label: 'Rank' },
                                { key: 'score', label: 'Score' },
                                {
                                    key: 'sparkline',
                                    label: '7d',
                                    sortable: false,
                                    render: (_, row) => `<div id="${row.sparklineId}"></div>`
                                }
                            ],
                            data: rows
                        });

                        rows.forEach((row) => {
                            const sparkHost = document.getElementById(row.sparklineId);
                            if (sparkHost && Array.isArray(row.sparkline) && row.sparkline.length > 1) {
                                lairUI.sparkline(sparkHost, row.sparkline, { width: 100, height: 24 });
                            }
                        });
                    } else {
                        render(contentId, `
                            <div class="list">
                                ${coins.map(({ item }) => `
                                    <div class="row">
                                        <div>
                                            <div class="row-title">${escapeHtml(item?.name)} (${escapeHtml(item?.symbol)})</div>
                                            <div class="row-sub">Rank #${item?.market_cap_rank || 'N/A'} • Score ${item?.score ?? 'N/A'}</div>
                                        </div>
                                        <div class="row-right">${item?.price_btc ? `${Number(item.price_btc).toFixed(8)} BTC` : '-'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `);
                    }
                    setUpdated('trending-updated');
                } catch (error) {
                    setError(contentId, error, 'Trending feed unavailable');
                }
            }

            async function loadWhales() {
                const contentId = 'whales-content';
                try {
                    let items = [];
                    try {
                        const primary = await fetchJson('https://api.blockchair.com/ethereum/transactions?q=value(100000000000000000000..)&s=time(desc)&limit=8');
                        items = Array.isArray(primary?.data)
                            ? primary.data.map((tx) => ({
                                hash: tx.hash,
                                amountEth: Number(tx.value || 0) / 1e18,
                                time: tx.time,
                                chain: 'Ethereum'
                            }))
                            : [];
                    } catch (_error) {
                        const fallback = await fetchJson('https://blockchain.info/unconfirmed-transactions?format=json');
                        items = Array.isArray(fallback?.txs)
                            ? fallback.txs
                                .map((tx) => {
                                    const satoshis = Array.isArray(tx.out) ? tx.out.reduce((sum, out) => sum + Number(out.value || 0), 0) : 0;
                                    return {
                                        hash: tx.hash,
                                        amountEth: satoshis / 100000000,
                                        time: (tx.time || 0) * 1000,
                                        chain: 'Bitcoin'
                                    };
                                })
                                .filter((tx) => tx.amountEth >= 100)
                                .sort((a, b) => b.amountEth - a.amountEth)
                                .slice(0, 8)
                            : [];
                    }

                    if (!items.length) {
                        throw new Error('No whale transactions found');
                    }

                    render(contentId, `
                        <div class="list">
                            ${items.map((tx) => `
                                <div class="row">
                                    <div>
                                        <div class="row-title">${escapeHtml(tx.chain)} transfer</div>
                                        <div class="row-sub">${escapeHtml(String(tx.hash).slice(0, 10))}... • ${relativeTime(tx.time)}</div>
                                    </div>
                                    <div class="row-right">${compact(tx.amountEth)} ${tx.chain === 'Ethereum' ? 'ETH' : 'BTC'}</div>
                                </div>
                            `).join('')}
                        </div>
                    `);
                    setUpdated('whales-updated');
                } catch (error) {
                    setError(contentId, error, 'Whale feed unavailable');
                }
            }

            async function fetchRpcGas(chainName, rpcUrl) {
                const payload = {
                    jsonrpc: '2.0',
                    id: 1,
                    method: 'eth_gasPrice',
                    params: []
                };
                const data = await fetchJson(rpcUrl, 15000, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const weiHex = String(data?.result || '0x0');
                const gwei = parseInt(weiHex, 16) / 1e9;
                return {
                    chain: chainName,
                    safe: gwei,
                    proposed: gwei,
                    fast: gwei * 1.2
                };
            }

            async function loadGas() {
                const contentId = 'gas-content';
                const chainConfigs = [
                    { label: 'Ethereum', chainid: 1, rpc: 'https://cloudflare-eth.com' },
                    { label: 'Base', chainid: 8453, rpc: 'https://mainnet.base.org' },
                    { label: 'Arbitrum', chainid: 42161, rpc: 'https://arb1.arbitrum.io/rpc' }
                ];

                try {
                    const rows = await Promise.all(chainConfigs.map(async (cfg) => {
                        try {
                            const data = await fetchJson(`https://api.etherscan.io/v2/api?chainid=${cfg.chainid}&module=gastracker&action=gasoracle&apikey=YourApiKeyToken`);
                            if (data?.status === '1' && data?.result) {
                                return {
                                    chain: cfg.label,
                                    safe: Number(data.result.SafeGasPrice || 0),
                                    proposed: Number(data.result.ProposeGasPrice || 0),
                                    fast: Number(data.result.FastGasPrice || 0)
                                };
                            }
                            throw new Error(data?.message || 'Etherscan unavailable');
                        } catch (_error) {
                            return fetchRpcGas(cfg.label, cfg.rpc);
                        }
                    }));

                    render(contentId, `
                        <div class="list">
                            ${rows.map((row) => `
                                <div class="row">
                                    <div>
                                        <div class="row-title">${escapeHtml(row.chain)}</div>
                                        <div class="row-sub">Safe ${row.safe.toFixed(2)} • Fast ${row.fast.toFixed(2)} gwei</div>
                                    </div>
                                    <div class="row-right">${row.proposed.toFixed(2)} gwei</div>
                                </div>
                            `).join('')}
                        </div>
                    `);
                    setUpdated('gas-updated');
                } catch (error) {
                    setError(contentId, error, 'Gas feed unavailable');
                }
            }

            async function loadYields() {
                const contentId = 'yields-content';
                try {
                    const data = await fetchJson('https://yields.llama.fi/pools');
                    const pools = Array.isArray(data?.data)
                        ? data.data
                            .filter((pool) => Number(pool?.tvlUsd || 0) > 5000000 && Number(pool?.apy || pool?.apyBase || 0) > 0)
                            .sort((a, b) => Number(b?.apy || b?.apyBase || 0) - Number(a?.apy || a?.apyBase || 0))
                            .slice(0, 8)
                        : [];

                    if (!pools.length) {
                        throw new Error('No pool data');
                    }

                    render(contentId, `
                        <div class="list">
                            ${pools.map((pool) => {
                                const apy = Number(pool?.apy || pool?.apyBase || 0);
                                return `
                                    <div class="row">
                                        <div>
                                            <div class="row-title">${escapeHtml(pool.project)} • ${escapeHtml(pool.symbol)}</div>
                                            <div class="row-sub">${escapeHtml(pool.chain)} • TVL ${money(pool.tvlUsd)}</div>
                                        </div>
                                        <div class="row-right positive">${apy.toFixed(2)}%</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `);
                    setUpdated('yields-updated');
                } catch (error) {
                    setError(contentId, error, 'DeFi yield feed unavailable');
                }
            }

            async function loadNews() {
                const contentId = 'news-content';
                try {
                    const parser = new DOMParser();
                    const feeds = await Promise.all(FEEDS.map(async (feed) => {
                        const wrapped = await fetchJson(`https://api.allorigins.win/get?url=${encodeURIComponent(feed.url)}`);
                        const xml = parser.parseFromString(String(wrapped?.contents || ''), 'application/xml');
                        const itemNodes = Array.from(xml.querySelectorAll('item')).slice(0, 4);
                        return itemNodes.map((node) => ({
                            source: feed.source,
                            title: node.querySelector('title')?.textContent || 'Untitled',
                            link: node.querySelector('link')?.textContent || '#',
                            pubDate: node.querySelector('pubDate')?.textContent || new Date().toISOString()
                        }));
                    }));

                    const articles = feeds
                        .flat()
                        .filter((item) => item.link && item.link !== '#')
                        .sort((a, b) => new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime())
                        .slice(0, 10);

                    if (!articles.length) {
                        throw new Error('No news headlines');
                    }

                    render(contentId, `
                        <div class="news-list">
                            ${articles.map((article) => `
                                <a class="news-item" href="${escapeHtml(article.link)}" target="_blank" rel="noopener noreferrer">
                                    <div class="news-source">${escapeHtml(article.source)}</div>
                                    <div class="news-title">${escapeHtml(article.title)}</div>
                                    <div class="news-time">${relativeTime(article.pubDate)}</div>
                                </a>
                            `).join('')}
                        </div>
                    `);
                    setUpdated('news-updated');
                } catch (error) {
                    setError(contentId, error, 'News feed unavailable');
                }
            }

            function every(ms, fn) {
                const id = window.setInterval(fn, ms);
                state.intervals.push(id);
            }

            function cleanup() {
                state.intervals.forEach((id) => window.clearInterval(id));
                state.intervals.length = 0;
            }

            window.__lairDashboardCleanup = cleanup;
            window.addEventListener('beforeunload', cleanup);
            window.addEventListener('pagehide', cleanup);

            setLoading('portfolio-content', 'Loading portfolio...');
            setLoading('market-content', 'Loading global market data...');
            setLoading('fear-content', 'Loading Fear & Greed data...');
            setLoading('ticker-content', 'Loading prices...');
            setLoading('trending-content', 'Loading trending tokens...');
            setLoading('whales-content', 'Loading whale transfers...');
            setLoading('gas-content', 'Loading gas prices...');
            setLoading('yields-content', 'Loading DeFi yields...');
            setLoading('news-content', 'Loading news headlines...');

            loadPortfolio();
            loadGlobalMarket();
            loadFearGreed();
            loadTicker();
            loadTrending();
            loadWhales();
            loadGas();
            loadYields();
            loadNews();

            every(60000, loadPortfolio);
            every(45000, loadGlobalMarket);
            every(45000, loadFearGreed);
            every(30000, loadTicker);
            every(45000, loadTrending);
            every(30000, loadWhales);
            every(30000, loadGas);
            every(60000, loadYields);
            every(60000, loadNews);
        })();
    </script>
</body>
</html>