<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lair Launch</title>
    <meta name="lair-icon" content="<svg width='232' height='232' viewBox='0 0 232 232' fill='none' xmlns='http://www.w3.org/2000/svg'><rect width='232' height='232' rx='40' fill='#2563eb'/><path d='M116 30c-20 0-36 60-36 100s16 50 36 50 36-10 36-50S136 30 116 30z' fill='white' opacity='0.9'/><path d='M80 130l-24 40c-4 6 0 14 8 14h20' fill='white' opacity='0.6'/><path d='M152 130l24 40c4 6 0 14-8 14h-20' fill='white' opacity='0.6'/><ellipse cx='116' cy='180' rx='20' ry='10' fill='#ff6b6b'/><ellipse cx='116' cy='190' rx='14' ry='20' fill='#fbbf24' opacity='0.8'/><ellipse cx='116' cy='198' rx='8' ry='14' fill='#ff6b6b' opacity='0.6'/><circle cx='116' cy='90' r='12' fill='#2563eb'/></svg>">
    <meta name="lair-include" content="lair.css material-symbols-rounded">
    <meta name="permissions" content="appStorage, network">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            height:100vh; overflow-y:auto;
            background:var(--col-bg1,#101010);
            color:var(--col-txt1,#fff);
            font-family:'Poppins',-apple-system,BlinkMacSystemFont,sans-serif;
        }
        body::-webkit-scrollbar { width:5px; }
        body::-webkit-scrollbar-thumb { background:var(--col-bg3,#333); border-radius:3px; }

        /* ‚îÄ‚îÄ Hero ‚îÄ‚îÄ */
        .hero {
            text-align:center; padding:32px 20px 24px;
            background:linear-gradient(135deg, rgba(124,58,237,0.15) 0%, rgba(59,130,246,0.1) 50%, transparent 100%);
        }
        .hero-icon {
            width:72px; height:72px; border-radius:18px;
            background:linear-gradient(135deg,#7C3AED,#3B82F6);
            display:inline-flex; align-items:center; justify-content:center;
            margin-bottom:12px;
        }
        .hero-icon .material-symbols-rounded { font-size:36px; color:#fff; }
        .hero h1 { font-size:22px; font-weight:700; margin-bottom:4px; }
        .hero p { font-size:13px; color:#888; max-width:420px; margin:0 auto 16px; line-height:1.5; }

        .hero-stats {
            display:flex; justify-content:center; gap:32px; margin-top:16px;
        }
        .hero-stat { text-align:center; }
        .hero-stat-icon { font-size:24px; margin-bottom:2px; }
        .hero-stat-label { font-size:10px; color:#666; text-transform:uppercase; letter-spacing:0.5px; }

        /* ‚îÄ‚îÄ Section headers ‚îÄ‚îÄ */
        .section { padding:20px 16px; }
        .section-title {
            font-size:14px; font-weight:600; margin-bottom:12px;
            display:flex; align-items:center; gap:6px;
            color:var(--colors-accent,#6179ff);
        }
        .section-title .material-symbols-rounded { font-size:18px; }
        .section-sub { font-size:12px; color:#666; margin-bottom:16px; }

        /* ‚îÄ‚îÄ How It Works ‚îÄ‚îÄ */
        .steps { display:flex; flex-direction:column; gap:10px; }
        .step {
            display:flex; align-items:flex-start; gap:12px;
            padding:12px; border-radius:10px;
            background:var(--col-bg2,#171717);
            border:1px solid var(--col-bg3,#262626);
            transition:border-color 0.2s;
        }
        .step:hover { border-color:rgba(124,58,237,0.3); }
        .step-num {
            width:28px; height:28px; border-radius:50%; flex-shrink:0;
            background:linear-gradient(135deg,#7C3AED,#3B82F6);
            display:flex; align-items:center; justify-content:center;
            font-size:12px; font-weight:700; color:#fff;
        }
        .step-content h3 { font-size:13px; font-weight:600; margin-bottom:2px; }
        .step-content p { font-size:11px; color:#888; line-height:1.4; }
        .step-note {
            font-size:10px; color:#ca8a04; background:rgba(202,138,4,0.1);
            padding:4px 8px; border-radius:4px; margin-top:4px;
        }
        .step-code {
            font-size:11px; color:#7C3AED; background:var(--col-bg3,#262626);
            padding:4px 8px; border-radius:4px; margin-top:4px;
            font-family:monospace;
        }

        /* ‚îÄ‚îÄ Coins Grid ‚îÄ‚îÄ */
        .status-bar {
            display:flex; align-items:center; justify-content:space-between;
            padding:0 16px 8px;
        }
        .ws-status {
            display:flex; align-items:center; gap:4px;
            font-size:11px;
        }
        .ws-dot {
            width:6px; height:6px; border-radius:50%;
        }
        .ws-dot.connected { background:#22c55e; }
        .ws-dot.disconnected { background:#eab308; animation:pulse 1.5s infinite; }

        .coins-grid {
            display:grid;
            grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));
            gap:12px; padding:0 16px 20px;
        }

        .coin-card {
            background:var(--col-bg2,#171717);
            border:1px solid var(--col-bg3,#262626);
            border-radius:12px; overflow:hidden;
            transition:border-color 0.2s, transform 0.15s;
            cursor:pointer;
        }
        .coin-card:hover { border-color:rgba(124,58,237,0.4); transform:translateY(-2px); }

        .coin-header {
            height:100px;
            background:linear-gradient(135deg,#7C3AED,#3B82F6,#06B6D4);
            display:flex; align-items:center; justify-content:center;
            position:relative;
        }
        .coin-avatar {
            width:56px; height:56px; border-radius:50%;
            border:3px solid rgba(255,255,255,0.3);
            object-fit:cover; background:rgba(255,255,255,0.15);
            display:flex; align-items:center; justify-content:center;
            font-size:22px; font-weight:700; color:#fff;
        }
        .coin-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }

        .coin-progress-bar {
            position:absolute; bottom:0; left:0; right:0; height:3px;
            background:rgba(255,255,255,0.15);
        }
        .coin-progress-fill {
            height:100%; background:linear-gradient(90deg,#06B6D4,#7C3AED);
            transition:width 0.5s ease;
        }

        .coin-body { padding:10px 12px; }
        .coin-info { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
        .coin-ticker { font-size:14px; font-weight:700; }
        .coin-name { font-size:11px; color:#888; }
        .coin-badge {
            font-size:10px; padding:2px 8px; border-radius:20px; font-weight:500;
        }
        .badge-minting { background:rgba(234,179,8,0.15); color:#eab308; }
        .badge-launched { background:rgba(34,197,94,0.15); color:#22c55e; }
        .badge-failed { background:rgba(239,68,68,0.15); color:#ef4444; }

        .coin-creator {
            display:flex; align-items:center; gap:4px;
            font-size:11px; color:#666; margin-bottom:8px;
        }
        .creator-avatar {
            width:16px; height:16px; border-radius:50%;
            background:var(--col-bg3,#333);
            display:flex; align-items:center; justify-content:center;
            font-size:8px; color:#888;
        }

        .coin-engagement {
            display:flex; gap:12px; font-size:11px; color:#888; margin-bottom:8px;
        }
        .coin-reactions {
            display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px;
        }
        .reaction-pill {
            display:flex; align-items:center; gap:2px;
            background:var(--col-bg3,#262626); border-radius:10px;
            padding:2px 6px; font-size:11px;
        }

        .progress-section { margin-bottom:6px; }
        .progress-labels {
            display:flex; justify-content:space-between;
            font-size:10px; color:#666; margin-bottom:3px;
        }
        .progress-track {
            height:6px; background:var(--col-bg3,#262626);
            border-radius:3px; overflow:hidden;
        }
        .progress-fill {
            height:100%;
            background:linear-gradient(90deg,#06B6D4,#3B82F6,#7C3AED);
            transition:width 0.5s ease;
        }

        .copy-btn {
            width:100%; padding:6px; border:none; border-radius:6px;
            background:var(--col-bg3,#262626); color:#888;
            font-size:11px; cursor:pointer; font-family:inherit;
            transition:background 0.15s;
        }
        .copy-btn:hover { background:rgba(124,58,237,0.2); color:#fff; }

        /* ‚îÄ‚îÄ Loading / Error / Empty ‚îÄ‚îÄ */
        .state-msg {
            text-align:center; padding:40px 20px;
        }
        .state-msg .icon { font-size:48px; margin-bottom:8px; }
        .state-msg p { font-size:13px; color:#888; }
        .state-msg .retry-btn {
            margin-top:12px; padding:8px 20px; border:none; border-radius:8px;
            background:#7C3AED; color:#fff; font-size:12px;
            cursor:pointer; font-family:inherit; transition:opacity 0.15s;
        }
        .state-msg .retry-btn:hover { opacity:0.8; }

        .spinner {
            width:32px; height:32px; border:3px solid var(--col-bg3,#333);
            border-top-color:#7C3AED; border-radius:50%;
            animation:spin 0.8s linear infinite; margin:0 auto 12px;
        }

        /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
        .tabs {
            display:flex; gap:2px; padding:0 16px;
            border-bottom:1px solid var(--col-bg3,#262626);
        }
        .tab {
            padding:8px 16px; font-size:12px; font-weight:500;
            color:#666; cursor:pointer; border-bottom:2px solid transparent;
            transition:all 0.15s;
        }
        .tab.active { color:var(--colors-accent,#6179ff); border-bottom-color:var(--colors-accent,#6179ff); }
        .tab:hover { color:#fff; }

        .tab-content { display:none; }
        .tab-content.active { display:block; }

        @keyframes spin { to { transform:rotate(360deg); } }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
        @keyframes shimmer {
            0% { transform:translateX(-100%); }
            100% { transform:translateX(100%); }
        }
    </style>
</head>
<body>

    <!-- Hero -->
    <div class="hero">
        <div class="hero-icon">
            <span class="material-symbols-rounded">rocket_launch</span>
        </div>
        <h1>Lair Launch</h1>
        <p>Engagement-powered token launches via Telegram. Create coins, build community momentum, launch automatically on-chain.</p>
        <div class="hero-stats">
            <div class="hero-stat">
                <div class="hero-stat-icon">üî•</div>
                <div class="hero-stat-label">Engagement-Powered</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-icon">‚ö°</div>
                <div class="hero-stat-label">Instant Deploy</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-icon">üåê</div>
                <div class="hero-stat-label">Multi-Chain</div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="coins">Minting</div>
        <div class="tab" data-tab="howto">How It Works</div>
    </div>

    <!-- Coins Tab -->
    <div class="tab-content active" id="tab-coins">
        <div class="status-bar" style="padding-top:12px">
            <span style="font-size:12px;color:#888" id="coin-count"></span>
            <div class="ws-status">
                <div class="ws-dot disconnected" id="ws-dot"></div>
                <span id="ws-label" style="color:#888">Connecting...</span>
            </div>
        </div>
        <div id="coins-container" class="coins-grid"></div>
        <div id="coins-loading" class="state-msg">
            <div class="spinner"></div>
            <p>Loading coins...</p>
        </div>
        <div id="coins-error" class="state-msg" style="display:none">
            <div class="icon">üòï</div>
            <p id="error-text">Failed to connect</p>
            <button class="retry-btn" onclick="loadCoins()">Retry</button>
        </div>
        <div id="coins-empty" class="state-msg" style="display:none">
            <div class="icon">üöÄ</div>
            <p>No coins minting yet.</p>
            <p style="color:#555;font-size:11px;margin-top:4px">Be the first to launch a coin on Lair!</p>
        </div>
    </div>

    <!-- How It Works Tab -->
    <div class="tab-content" id="tab-howto">
        <div class="section">
            <div class="section-title">
                <span class="material-symbols-rounded">school</span>
                How It Works
            </div>
            <div class="steps">
                <div class="step">
                    <div class="step-num">1</div>
                    <div class="step-content">
                        <h3>ü§ñ Add the bot to your Telegram chat</h3>
                        <p>Invite @LairBot to your Telegram group and provide it admin permissions.</p>
                        <div class="step-note">‚ö†Ô∏è Without admin permissions, reactions within the chat won't count towards the engagement score.</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-num">2</div>
                    <div class="step-content">
                        <h3>üöÄ Launch a coin</h3>
                        <p>Launch a coin by writing <strong>@LairBot !ticker +name</strong> with a picture attached.</p>
                        <div class="step-code">@LairBot !MOON +MoonCoin</div>
                    </div>
                </div>
                <div class="step">
                    <div class="step-num">3</div>
                    <div class="step-content">
                        <h3>üí¨ Build Engagement</h3>
                        <p>Once your launch message reaches enough reacts and replies, the coin will automatically launch on-chain. Forward it to as many chats with the bot as you can.</p>
                    </div>
                </div>
                <div class="step">
                    <div class="step-num">4</div>
                    <div class="step-content">
                        <h3>üìä See Launch Progress</h3>
                        <p>Track the progress of your coin by watching the progress bar. When it reaches 100%, your coin will launch.</p>
                    </div>
                </div>
                <div class="step">
                    <div class="step-num">5</div>
                    <div class="step-content">
                        <h3>üí∞ Trade on Any DEX</h3>
                        <p>Once launched, your token is live on-chain! The contract address will be displayed and you can trade on any compatible DEX.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LAIR_HOST = (window.location.ancestorOrigins?.[0] || '').replace(/\/$/, '') || location.origin;
        const API_URL = localStorage.getItem('lair_api_url') || LAIR_HOST;
        let coins = [];
        let ws = null;
        let wsReconnectTimer = null;
        let wsRetries = 0;
        const WS_MAX_RETRIES = 3;

        // ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // ‚îÄ‚îÄ Render coins ‚îÄ‚îÄ
        function renderCoins() {
            const container = document.getElementById('coins-container');
            const loading = document.getElementById('coins-loading');
            const error = document.getElementById('coins-error');
            const empty = document.getElementById('coins-empty');
            const count = document.getElementById('coin-count');

            loading.style.display = 'none';
            error.style.display = 'none';
            empty.style.display = 'none';

            if (coins.length === 0) {
                empty.style.display = 'block';
                container.innerHTML = '';
                count.textContent = '';
                return;
            }

            count.textContent = `${coins.length} coin${coins.length !== 1 ? 's' : ''}`;

            container.innerHTML = coins.map(coin => {
                const sortedReactions = Object.entries(coin.reactions || {})
                    .sort(([,a],[,b]) => b - a).slice(0, 6);
                const badgeClass = coin.status === 'minting' ? 'badge-minting'
                    : coin.status === 'launched' ? 'badge-launched' : 'badge-failed';
                const badgeText = coin.status === 'minting' ? 'üîÑ Minting'
                    : coin.status === 'launched' ? 'üöÄ Launched' : '‚ùå Failed';

                return `
                <div class="coin-card" onclick="openCoinDetail(${coin.id})">
                    <div class="coin-header">
                        <div class="coin-avatar">
                            ${coin.image_url
                                ? `<img src="${coin.image_url}" alt="${coin.name}" onerror="this.style.display='none';this.parentElement.textContent='${coin.ticker.charAt(0)}'">`
                                : coin.ticker.charAt(0)}
                        </div>
                        <div class="coin-progress-bar">
                            <div class="coin-progress-fill" style="width:${coin.progress_percentage}%"></div>
                        </div>
                    </div>
                    <div class="coin-body">
                        <div class="coin-info">
                            <div>
                                <div class="coin-ticker">${coin.ticker}</div>
                                <div class="coin-name">${coin.name}</div>
                            </div>
                            <span class="coin-badge ${badgeClass}">${badgeText}</span>
                        </div>
                        <div class="coin-creator">
                            <div class="creator-avatar">${(coin.creator_username || '?').charAt(0).toUpperCase()}</div>
                            ${coin.creator_username || 'Anonymous'}
                        </div>
                        <div class="coin-engagement">
                            <span>üí¨ ${coin.replies_count || 0}</span>
                            <span>‚ÜóÔ∏è ${coin.forwards_count || 0} forwards</span>
                        </div>
                        ${sortedReactions.length > 0 ? `
                        <div class="coin-reactions">
                            ${sortedReactions.map(([emoji, count]) =>
                                `<div class="reaction-pill">${emoji} <span>${count}</span></div>`
                            ).join('')}
                        </div>` : ''}
                        <div class="progress-section">
                            <div class="progress-labels">
                                <span>Progress</span>
                                <span>${Math.round(coin.progress_percentage)}%</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill" style="width:${coin.progress_percentage}%"></div>
                            </div>
                        </div>
                        ${coin.contract_address ? `
                        <button class="copy-btn" onclick="event.stopPropagation();copyAddress('${coin.contract_address}',this)">
                            üìã Copy contract address
                        </button>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        // ‚îÄ‚îÄ Load coins from API ‚îÄ‚îÄ
        async function loadCoins() {
            const loading = document.getElementById('coins-loading');
            const error = document.getElementById('coins-error');
            loading.style.display = 'block';
            error.style.display = 'none';

            try {
                const res = await fetch(`${API_URL}/api/coins`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                if (data.success) {
                    coins = data.data || [];
                    renderCoins();
                } else {
                    throw new Error(data.error || 'Failed');
                }
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('error-text').textContent = err.message;
            }
        }

        // ‚îÄ‚îÄ WebSocket for live updates ‚îÄ‚îÄ
        function connectWebSocket() {
            const dot = document.getElementById('ws-dot');
            const label = document.getElementById('ws-label');

            // Skip WS on Vercel serverless ‚Äî it doesn't support WebSocket
            if (API_URL.includes('vercel.app')) {
                dot.className = 'ws-dot disconnected';
                label.textContent = 'Polling';
                label.style.color = '#888';
                // Poll for updates every 30s instead
                setInterval(() => loadCoins(), 30000);
                return;
            }

            if (wsRetries >= WS_MAX_RETRIES) {
                dot.className = 'ws-dot disconnected';
                label.textContent = 'Offline';
                label.style.color = '#888';
                // Fall back to polling
                setInterval(() => loadCoins(), 30000);
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) return;
            try {
                const proto = API_URL.startsWith('https') ? 'wss' : 'ws';
                const wsUrl = API_URL.replace(/^https?/, proto) + '/ws';
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    wsRetries = 0;
                    dot.className = 'ws-dot connected';
                    label.textContent = 'Live';
                    label.style.color = '#22c55e';
                };

                ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        if (msg.type === 'engagement_update') {
                            const u = msg.data;
                            coins = coins.map(c => c.id === u.coin_id ? {
                                ...c,
                                current_engagement: u.current_engagement,
                                progress_percentage: u.progress_percentage,
                                reactions: u.reactions,
                                forwards_count: u.forwards_count,
                                replies_count: u.replies_count,
                            } : c);
                            renderCoins();
                        }
                    } catch (err) { console.error('WS parse error', err); }
                };

                ws.onclose = () => {
                    wsRetries++;
                    dot.className = 'ws-dot disconnected';
                    label.textContent = 'Reconnecting...';
                    label.style.color = '#888';
                    const delay = Math.min(3000 * Math.pow(2, wsRetries), 30000);
                    wsReconnectTimer = setTimeout(connectWebSocket, delay);
                };

                ws.onerror = () => ws.close();
            } catch (err) {
                console.error('WS error', err);
            }
        }

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
        function copyAddress(addr, btn) {
            navigator.clipboard.writeText(addr);
            const orig = btn.innerHTML;
            btn.innerHTML = '‚úì Copied!';
            setTimeout(() => btn.innerHTML = orig, 1500);
        }

        function openCoinDetail(id) {
            // Open coin detail in a new OS window if available, otherwise navigate
            if (window.parent && window.parent.openApp) {
                window.parent.openApp('laircoin', { coinId: id });
            }
        }

        // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
        loadCoins();
        connectWebSocket();
    </script>
</body>
</html>
