<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fear & Greed Index</title>
    <meta name="lair-icon" content="<svg width='232' height='232' viewBox='0 0 232 232' fill='none' xmlns='http://www.w3.org/2000/svg'><rect width='232' height='232' rx='40' fill='#059669'/><path d='M36 146a80 80 0 01160 0' stroke='white' stroke-width='14' stroke-linecap='round' fill='none'/><path d='M56 146a60 60 0 01120 0' stroke='#00d4aa' stroke-width='10' stroke-linecap='round' fill='none' opacity='0.5'/><line x1='116' y1='146' x2='146' y2='90' stroke='white' stroke-width='8' stroke-linecap='round'/><circle cx='116' cy='146' r='10' fill='white'/><text x='48' y='180' font-size='20' fill='white' opacity='0.7' font-family='sans-serif'>Fear</text><text x='148' y='180' font-size='20' fill='white' opacity='0.7' font-family='sans-serif'>Greed</text></svg>">
    <meta name="lair-include" content="lair.css material-symbols-rounded">
    <meta name="permissions" content="appStorage, network">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            height: 100vh; overflow-y: auto;
            background: var(--col-bg1, #101010);
            color: var(--col-txt1, #fff);
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex; flex-direction: column;
        }
        body::-webkit-scrollbar { width: 5px; }
        body::-webkit-scrollbar-thumb { background: var(--col-bg3, #333); border-radius: 3px; }

        .header {
            padding: 16px 20px 12px;
            background: var(--col-bg2, #171717);
            border-bottom: 1px solid var(--col-bg3, #262626);
            flex-shrink: 0;
        }
        .header h1 { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .header p { font-size: 11px; color: #666; margin-top: 4px; }

        /* Gauge */
        .gauge-section {
            display: flex; flex-direction: column; align-items: center;
            padding: 30px 20px; gap: 16px;
        }
        .gauge-wrap { position: relative; width: 240px; height: 130px; }
        .gauge-svg { width: 240px; height: 130px; }
        .gauge-val {
            position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%);
            text-align: center;
        }
        .gauge-num { font-size: 48px; font-weight: 800; line-height: 1; }
        .gauge-label { font-size: 14px; font-weight: 600; margin-top: 2px; }
        .gauge-time { font-size: 10px; color: #666; margin-top: 2px; }

        /* Historical cards */
        .hist-section {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px; padding: 0 20px 16px;
        }
        .hist-card {
            background: var(--col-bg2, #171717);
            border: 1px solid var(--col-bg3, #262626);
            border-radius: 10px; padding: 12px; text-align: center;
        }
        .hist-period { font-size: 10px; color: #666; margin-bottom: 4px; }
        .hist-val { font-size: 22px; font-weight: 700; }
        .hist-label { font-size: 10px; font-weight: 500; margin-top: 2px; }

        /* Chart section */
        .chart-section {
            padding: 0 20px 20px; flex: 1;
        }
        .chart-title {
            font-size: 12px; font-weight: 600; margin-bottom: 10px;
            display: flex; align-items: center; gap: 6px;
        }
        .chart-wrap {
            background: var(--col-bg2, #171717);
            border: 1px solid var(--col-bg3, #262626);
            border-radius: 10px; padding: 16px; position: relative;
            height: 200px;
        }
        .chart-canvas { width: 100%; height: 100%; }
        .chart-labels {
            display: flex; justify-content: space-between;
            font-size: 9px; color: #555; margin-top: 6px;
        }

        /* Color helpers */
        .extreme-fear { color: #ef4444; }
        .fear { color: #f97316; }
        .neutral { color: #eab308; }
        .greed { color: #84cc16; }
        .extreme-greed { color: #22c55e; }

        .loading { display: flex; align-items: center; justify-content: center; height: 100%; }
        .spinner { width: 24px; height: 24px; border: 3px solid var(--col-bg3, #333); border-top-color: var(--colors-accent, #6179ff); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-state { text-align: center; padding: 40px; }
        .error-state .material-symbols-rounded { font-size: 40px; color: #ef4444; }
        .retry-btn {
            margin-top: 12px; padding: 8px 16px;
            background: var(--colors-accent, #6179ff); color: #fff;
            border: none; border-radius: 6px; cursor: pointer; font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><span class="material-symbols-rounded" style="font-size:20px">speed</span> Fear & Greed Index</h1>
        <p>Crypto market sentiment from Alternative.me â€” updated daily</p>
    </div>

    <div id="content">
        <div class="loading" style="min-height:300px"><div class="spinner"></div></div>
    </div>

    <script>
        const fetchFn = typeof cfetch === 'function' ? cfetch : fetch;

        function getSentiment(val) {
            if (val <= 24) return { label: 'Extreme Fear', cls: 'extreme-fear' };
            if (val <= 44) return { label: 'Fear', cls: 'fear' };
            if (val <= 55) return { label: 'Neutral', cls: 'neutral' };
            if (val <= 74) return { label: 'Greed', cls: 'greed' };
            return { label: 'Extreme Greed', cls: 'extreme-greed' };
        }

        function getColor(val) {
            if (val <= 24) return '#ef4444';
            if (val <= 44) return '#f97316';
            if (val <= 55) return '#eab308';
            if (val <= 74) return '#84cc16';
            return '#22c55e';
        }

        function drawGauge(value) {
            const angle = (value / 100) * 180;
            const rad = angle * Math.PI / 180;
            const cx = 120, cy = 120, r = 100;
            const x = cx + r * Math.cos(Math.PI - rad);
            const y = cy - r * Math.sin(Math.PI - rad);
            const largeArc = angle > 180 ? 1 : 0;
            const color = getColor(value);

            // Background arc
            const bgArc = `M ${cx - r} ${cy} A ${r} ${r} 0 1 1 ${cx + r} ${cy}`;
            // Value arc
            const valArc = `M ${cx - r} ${cy} A ${r} ${r} 0 ${angle > 90 ? 1 : 0} 1 ${x} ${y}`;

            return `<svg class="gauge-svg" viewBox="0 0 240 130">
                <path d="${bgArc}" fill="none" stroke="#222" stroke-width="18" stroke-linecap="round"/>
                <path d="${valArc}" fill="none" stroke="${color}" stroke-width="18" stroke-linecap="round"/>
                <!-- Needle -->
                <line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                <circle cx="${cx}" cy="${cy}" r="6" fill="#fff"/>
                <!-- Labels -->
                <text x="20" y="128" fill="#666" font-size="8" font-family="inherit">0</text>
                <text x="${cx}" y="14" fill="#666" font-size="8" font-family="inherit" text-anchor="middle">50</text>
                <text x="218" y="128" fill="#666" font-size="8" font-family="inherit" text-anchor="end">100</text>
            </svg>`;
        }

        function drawChart(data) {
            if (!data || data.length < 2) return '';
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            const wrap = document.querySelector('.chart-wrap');
            if (!wrap) return;
            wrap.innerHTML = '';
            wrap.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = wrap.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const w = rect.width, h = rect.height;
            const pad = { t: 10, r: 10, b: 20, l: 30 };
            const plotW = w - pad.l - pad.r;
            const plotH = h - pad.t - pad.b;

            const vals = data.map(d => parseInt(d.value));
            const min = Math.min(...vals) - 5;
            const max = Math.max(...vals) + 5;

            // Grid lines
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 4; i++) {
                const y = pad.t + (i / 4) * plotH;
                ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(w - pad.r, y); ctx.stroke();
                const val = Math.round(max - (i / 4) * (max - min));
                ctx.fillStyle = '#555'; ctx.font = '9px sans-serif'; ctx.textAlign = 'right';
                ctx.fillText(val, pad.l - 4, y + 3);
            }

            // Area + line
            const gradient = ctx.createLinearGradient(0, pad.t, 0, h - pad.b);
            gradient.addColorStop(0, 'rgba(97,121,255,0.3)');
            gradient.addColorStop(1, 'rgba(97,121,255,0)');

            ctx.beginPath();
            ctx.moveTo(pad.l, h - pad.b);
            vals.forEach((v, i) => {
                const x = pad.l + (i / (vals.length - 1)) * plotW;
                const y = pad.t + ((max - v) / (max - min)) * plotH;
                ctx.lineTo(x, y);
            });
            ctx.lineTo(pad.l + plotW, h - pad.b);
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();

            ctx.beginPath();
            vals.forEach((v, i) => {
                const x = pad.l + (i / (vals.length - 1)) * plotW;
                const y = pad.t + ((max - v) / (max - min)) * plotH;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.strokeStyle = '#6179ff';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Color dots for latest
            const lastX = pad.l + plotW;
            const lastY = pad.t + ((max - vals[vals.length - 1]) / (max - min)) * plotH;
            ctx.beginPath(); ctx.arc(lastX, lastY, 4, 0, Math.PI * 2);
            ctx.fillStyle = getColor(vals[vals.length - 1]); ctx.fill();

            // X-axis labels
            const labelCount = Math.min(6, data.length);
            ctx.fillStyle = '#555'; ctx.font = '8px sans-serif'; ctx.textAlign = 'center';
            for (let i = 0; i < labelCount; i++) {
                const idx = Math.floor(i * (data.length - 1) / (labelCount - 1));
                const x = pad.l + (idx / (data.length - 1)) * plotW;
                const ts = parseInt(data[idx].timestamp) * 1000;
                const d = new Date(ts);
                ctx.fillText(`${d.getMonth()+1}/${d.getDate()}`, x, h - 4);
            }
        }

        async function loadData() {
            try {
                // Fetch 30 days of data from Alternative.me
                const res = await fetchFn('https://api.alternative.me/fng/?limit=31&format=json');
                const json = await res.json();

                if (!json.data || json.data.length === 0) throw new Error('No data');

                const current = json.data[0];
                const yesterday = json.data[1];
                const weekAgo = json.data[6] || json.data[json.data.length - 1];
                const monthAgo = json.data[29] || json.data[json.data.length - 1];
                const sent = getSentiment(parseInt(current.value));

                const content = document.getElementById('content');

                content.innerHTML = `
                    <div class="gauge-section">
                        <div class="gauge-wrap">
                            ${drawGauge(parseInt(current.value))}
                            <div class="gauge-val">
                                <div class="gauge-num ${sent.cls}">${current.value}</div>
                                <div class="gauge-label ${sent.cls}">${sent.label}</div>
                                <div class="gauge-time">Updated ${new Date(parseInt(current.timestamp) * 1000).toLocaleDateString()}</div>
                            </div>
                        </div>
                    </div>

                    <div class="hist-section">
                        <div class="hist-card">
                            <div class="hist-period">Now</div>
                            <div class="hist-val ${getSentiment(parseInt(current.value)).cls}">${current.value}</div>
                            <div class="hist-label ${getSentiment(parseInt(current.value)).cls}">${current.value_classification}</div>
                        </div>
                        <div class="hist-card">
                            <div class="hist-period">Yesterday</div>
                            <div class="hist-val ${getSentiment(parseInt(yesterday.value)).cls}">${yesterday.value}</div>
                            <div class="hist-label ${getSentiment(parseInt(yesterday.value)).cls}">${yesterday.value_classification}</div>
                        </div>
                        <div class="hist-card">
                            <div class="hist-period">Last Week</div>
                            <div class="hist-val ${getSentiment(parseInt(weekAgo.value)).cls}">${weekAgo.value}</div>
                            <div class="hist-label ${getSentiment(parseInt(weekAgo.value)).cls}">${weekAgo.value_classification}</div>
                        </div>
                        <div class="hist-card">
                            <div class="hist-period">Last Month</div>
                            <div class="hist-val ${getSentiment(parseInt(monthAgo.value)).cls}">${monthAgo.value}</div>
                            <div class="hist-label ${getSentiment(parseInt(monthAgo.value)).cls}">${monthAgo.value_classification}</div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <div class="chart-title"><span class="material-symbols-rounded" style="font-size:16px">show_chart</span> 30-Day Trend</div>
                        <div class="chart-wrap"></div>
                    </div>
                `;

                // Draw chart with reversed data (oldest first)
                drawChart([...json.data].reverse());

            } catch (error) {
                console.error('Fear & Greed error:', error);
                document.getElementById('content').innerHTML = `
                    <div class="error-state">
                        <span class="material-symbols-rounded">error</span>
                        <p style="margin-top:8px">Failed to load data</p>
                        <p style="font-size:11px;color:#666">${error.message}</p>
                        <button class="retry-btn" onclick="loadData()">Retry</button>
                    </div>
                `;
            }
        }

        function greenflag() { loadData(); }
        loadData();

        // Auto-refresh every 5 minutes
        setInterval(loadData, 300000);
    </script>
</body>
</html>
