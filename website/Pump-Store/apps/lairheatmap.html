<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="lair-include" content="lair.css material-symbols-rounded" />
  <meta name="lair-icon" content="grid_view" />
  <meta name="lair-perms" content="network" />
  <meta name="capabilities" content="market_heatmap" />
  <title>Lair Market Heatmap</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:#0a0a0a;color:#fff;font-family:Inter,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
    .app{height:100%;display:grid;grid-template-rows:auto 1fr}
    .top{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);background:var(--col-bg2,#171717);flex-wrap:wrap}
    .title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px}
    .title .material-symbols-rounded{font-size:18px;color:var(--colors-accent,rgb(97,121,255))}
    .btn{background:transparent;border:1px solid rgba(255,255,255,.2);color:#94a3b8;padding:5px 9px;border-radius:8px;font-size:11px;cursor:pointer}
    .btn.active{border-color:var(--colors-accent,rgb(97,121,255));background:rgba(97,121,255,.12);color:#fff}
    .slider{display:flex;align-items:center;gap:6px;color:#94a3b8;font-size:11px}
    .slider input{accent-color:var(--colors-accent,rgb(97,121,255))}
    .canvas-wrap{position:relative}
    canvas{width:100%;height:100%;display:block}
    .tooltip{position:fixed;z-index:20;pointer-events:none;display:none;min-width:220px;background:var(--col-bg2,#171717);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;box-shadow:0 10px 28px rgba(0,0,0,.45)}
    .tooltip.show{display:block}
    .tip-h{font-size:13px;font-weight:700}
    .tip-s{font-size:11px;color:#9ca3af;margin-bottom:6px}
    .tip-kv{display:grid;grid-template-columns:1fr auto;gap:4px;font-size:11px}
    .panel{position:absolute;right:10px;bottom:10px;width:340px;background:rgba(10,10,10,.94);border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:10px;display:none}
    .panel.open{display:block}
    .panel h3{font-size:13px;margin-bottom:6px}
    .spark{width:100%;height:110px;border:1px solid rgba(255,255,255,.16);border-radius:8px;background:#111}
    .links a{display:block;color:var(--colors-accent,rgb(97,121,255));font-size:11px;margin-top:5px;text-decoration:none}
    .state{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#94a3b8;background:rgba(0,0,0,.35)}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="title"><span class="material-symbols-rounded">grid_view</span>Lair Market Heatmap</div>
      <button class="btn" data-tf="1h">1H</button>
      <button class="btn active" data-tf="24h">24H</button>
      <button class="btn" data-tf="7d">7D</button>
      <div class="slider">Top <input id="limit" type="range" min="20" max="100" step="30" value="100" /><span id="limitv">100</span></div>
      <div style="margin-left:auto;font-size:11px;color:#94a3b8" id="meta">Loading...</div>
    </div>
    <div class="canvas-wrap">
      <canvas id="map" width="1440" height="900"></canvas>
      <div class="state" id="state">Loading CoinGecko markets...</div>
      <div class="panel" id="panel">
        <h3 id="pt">Coin</h3>
        <canvas class="spark" id="spark" width="320" height="110"></canvas>
        <div style="margin-top:6px;font-size:11px;color:#cbd5e1" id="pv"></div>
        <div class="links" id="links"></div>
      </div>
    </div>
  </div>
  <div class="tooltip" id="tip"></div>

<script>
(() => {
  const fetchFn = window.cfetch || fetch;
  const url = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=true&price_change_percentage=1h,24h,7d';
  const map = document.getElementById('map');
  const ctx = map.getContext('2d');
  const tip = document.getElementById('tip');
  const panel = document.getElementById('panel');
  const state = document.getElementById('state');
  const meta = document.getElementById('meta');
  const limit = document.getElementById('limit');
  const limitv = document.getElementById('limitv');
  const spark = document.getElementById('spark');
  const sctx = spark.getContext('2d');

  let coins = [];
  let rects = [];
  let tf = '24h';
  let selected = null;

  function fmt(v){ if(v==null||Number.isNaN(v)) return '—'; if(v>=1e12) return `$${(v/1e12).toFixed(2)}T`; if(v>=1e9) return `$${(v/1e9).toFixed(2)}B`; if(v>=1e6) return `$${(v/1e6).toFixed(2)}M`; if(v>=1e3) return `$${(v/1e3).toFixed(1)}K`; return `$${v.toFixed(2)}`; }
  function change(c){ return tf==='1h' ? c.price_change_percentage_1h_in_currency : tf==='7d' ? c.price_change_percentage_7d_in_currency : c.price_change_percentage_24h; }
  function color(v){
    if(v==null||Number.isNaN(v)) return '#616161';
    const c = Math.max(-15, Math.min(15, v));
    if(c >= 0){
      const t = c/15;
      const r = Math.round(97 - 70*t);
      const g = Math.round(97 + 64*t);
      const b = Math.round(97 - 65*t);
      return `rgb(${r},${g},${b})`;
    }
    const t = Math.abs(c)/15;
    const r = Math.round(97 + 114*t);
    const g = Math.round(97 - 50*t);
    const b = Math.round(97 - 50*t);
    return `rgb(${r},${g},${b})`;
  }

  function resize(){ const dpr = Math.max(1, window.devicePixelRatio || 1); map.width = Math.floor(map.clientWidth * dpr); map.height = Math.floor(map.clientHeight * dpr); ctx.setTransform(dpr,0,0,dpr,0,0); render(); }

  function worst(row, side){
    if(!row.length) return Infinity;
    const sum = row.reduce((s,i)=>s+i.area,0);
    const max = Math.max(...row.map((i)=>i.area));
    const min = Math.min(...row.map((i)=>i.area));
    const side2 = side * side;
    return Math.max((side2 * max)/(sum*sum), (sum*sum)/(side2 * min));
  }

  function layoutRow(row, x, y, w, h, out){
    const rowArea = row.reduce((s,i)=>s+i.area,0);
    if(w >= h){
      const rowW = rowArea / h;
      let yy = y;
      row.forEach((i) => {
        const hh = i.area / rowW;
        out.push({ x, y: yy, w: rowW, h: hh, coin: i.coin });
        yy += hh;
      });
      return { x: x + rowW, y, w: w - rowW, h };
    }
    const rowH = rowArea / w;
    let xx = x;
    row.forEach((i) => {
      const ww = i.area / rowH;
      out.push({ x: xx, y, w: ww, h: rowH, coin: i.coin });
      xx += ww;
    });
    return { x, y: y + rowH, w, h: h - rowH };
  }

  function squarify(items, x, y, w, h){
    const out = [];
    let row = [];
    let left = [...items];
    let box = { x, y, w, h };
    while(left.length){
      const c = left[0];
      const side = Math.min(box.w, box.h);
      const nrow = [...row, c];
      if(!row.length || worst(nrow, side) <= worst(row, side)){
        row = nrow;
        left.shift();
      } else {
        box = layoutRow(row, box.x, box.y, box.w, box.h, out);
        row = [];
      }
    }
    if(row.length) layoutRow(row, box.x, box.y, box.w, box.h, out);
    return out;
  }

  function render(){
    if(!coins.length) return;
    const cw = map.clientWidth, ch = map.clientHeight;
    ctx.clearRect(0,0,cw,ch);
    const maxCount = Number(limit.value);
    const data = coins.slice(0,maxCount);
    const total = data.reduce((s,c)=>s+c.market_cap,0) || 1;
    const items = data.map((coin)=>({ coin, area: (coin.market_cap/total)*(cw*ch) }));
    rects = squarify(items, 0, 0, cw, ch);

    rects.forEach((r) => {
      const c = r.coin;
      ctx.fillStyle = color(change(c));
      ctx.fillRect(r.x, r.y, r.w, r.h);
      ctx.strokeStyle = 'rgba(0,0,0,.35)';
      ctx.strokeRect(r.x, r.y, r.w, r.h);

      if(r.w > 58 && r.h > 36){
        ctx.fillStyle = '#fff';
        ctx.font = '700 12px Inter';
        ctx.shadowColor = 'rgba(0,0,0,.45)';
        ctx.shadowBlur = 4;
        ctx.fillText(c.symbol.toUpperCase(), r.x + 6, r.y + 16);
        ctx.font = '600 11px Inter';
        const chg = change(c) || 0;
        const sign = chg >= 0 ? '+' : '';
        ctx.fillText(`${sign}${chg.toFixed(2)}%`, r.x + 6, r.y + 30);
        ctx.shadowBlur = 0;
      }
    });
    meta.textContent = `${data.length} coins • ${tf} heat`; 
  }

  function coinAt(x,y){ return rects.find((r)=>x>=r.x&&x<=r.x+r.w&&y>=r.y&&y<=r.y+r.h); }

  function renderTip(c, x, y){
    tip.classList.add('show');
    tip.style.left = `${x + 12}px`;
    tip.style.top = `${y + 12}px`;
    const ch = change(c);
    tip.innerHTML = `<div class="tip-h">${c.name}</div><div class="tip-s">${c.symbol.toUpperCase()}</div>
      <div class="tip-kv"><span>Price</span><strong>${fmt(c.current_price)}</strong>
      <span>Market Cap</span><strong>${fmt(c.market_cap)}</strong>
      <span>Volume (24h)</span><strong>${fmt(c.total_volume)}</strong>
      <span>Circulating</span><strong>${c.circulating_supply ? c.circulating_supply.toLocaleString() : '—'}</strong>
      <span>ATH Distance</span><strong>${(c.ath_change_percentage||0).toFixed(2)}%</strong>
      <span>${tf} Change</span><strong style="color:${ch>=0?'#2e7d32':'#d32f2f'}">${ch>=0?'+':''}${(ch||0).toFixed(2)}%</strong></div>`;
  }

  function drawSpark(coin){
    const points = coin.sparkline_in_7d?.price || [];
    sctx.clearRect(0,0,spark.width,spark.height);
    sctx.fillStyle='#101010'; sctx.fillRect(0,0,spark.width,spark.height);
    if(!points.length){ sctx.fillStyle='#94a3b8'; sctx.fillText('No sparkline data', 10, 55); return; }
    const min = Math.min(...points), max = Math.max(...points);
    sctx.beginPath();
    points.forEach((p,i)=>{
      const x = 10 + (i/(points.length-1||1))*(spark.width-20);
      const y = 10 + (1-((p-min)/((max-min)||1)))*(spark.height-20);
      if(i===0) sctx.moveTo(x,y); else sctx.lineTo(x,y);
    });
    sctx.strokeStyle = '#5be45b';
    sctx.lineWidth = 2;
    sctx.stroke();
  }

  function openPanel(coin){
    selected = coin;
    document.getElementById('pt').textContent = `${coin.name} (${coin.symbol.toUpperCase()})`;
    const ch = change(coin) || 0;
    document.getElementById('pv').innerHTML = `Price ${fmt(coin.current_price)} • ${tf} <span style="color:${ch>=0?'#5be45b':'#d44343'}">${ch>=0?'+':''}${ch.toFixed(2)}%</span>`;
    document.getElementById('links').innerHTML = `
      <a href="https://www.coingecko.com/en/coins/${coin.id}" target="_blank" rel="noopener">Open CoinGecko</a>
      <a href="https://dexscreener.com/search?q=${encodeURIComponent(coin.symbol)}" target="_blank" rel="noopener">Open DexScreener</a>
      <a href="https://etherscan.io" target="_blank" rel="noopener">Open Etherscan</a>
    `;
    drawSpark(coin);
    panel.classList.add('open');
  }

  async function load(){
    try {
      const res = await fetchFn(url);
      if(!res.ok) throw new Error(String(res.status));
      coins = await res.json();
      state.style.display='none';
      render();
    } catch (e) {
      state.textContent = `Market load failed: ${e.message}`;
    }
  }

  window.addEventListener('resize', resize);
  map.addEventListener('mousemove', (e) => {
    const r = map.getBoundingClientRect();
    const hit = coinAt(e.clientX - r.left, e.clientY - r.top);
    if(hit) renderTip(hit.coin, e.clientX, e.clientY); else tip.classList.remove('show');
  });
  map.addEventListener('mouseleave', () => tip.classList.remove('show'));
  map.addEventListener('click', (e) => {
    const r = map.getBoundingClientRect();
    const hit = coinAt(e.clientX - r.left, e.clientY - r.top);
    if(hit) openPanel(hit.coin);
  });

  document.querySelectorAll('.btn[data-tf]').forEach((b) => b.onclick = () => {
    tf = b.dataset.tf;
    document.querySelectorAll('.btn[data-tf]').forEach((x)=>x.classList.toggle('active', x===b));
    render();
    if(selected) openPanel(selected);
  });
  limit.oninput = () => { limitv.textContent = limit.value; render(); };

  resize();
  load();
})();
</script>
</body>
</html>
