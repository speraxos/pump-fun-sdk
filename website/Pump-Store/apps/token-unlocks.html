<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="pump-include" content="pump.css">
    <meta name="permissions" content="appStorage, network">
    <meta name="pump-icon" content="lock_open">
    <meta name="pump-perms" content="network" />
    <title>Token Unlocks</title>
    <style>
        :root {
            --col-bg1: #101010;
            --col-bg2: #171717;
            --col-bg3: #222222;
            --col-txt1: white;
            --col-txt2: #aaa;
            --col-txt3: #666;
            --colors-accent: #00e87b;
            --col-good: #22c55e;
            --col-bad: #dc2626;
            --col-warn: #f59e0b;
            --col-critical: #dc2626;
            --col-high: #ef4444;
            --col-medium: #f59e0b;
            --col-low: #22c55e;
            --siz-radius1: 0.5em;
            --siz-radius2: 0.375em;
            --font-size-small: 0.75em;
        }

        html { height: 100%; }
        body {
            margin: 0;
            height: 100%;
            background: var(--col-bg1);
            color: var(--col-txt1);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            overflow-y: auto;
        }
        * { box-sizing: border-box; }

        .app {
            max-width: 860px;
            margin: 0 auto;
            padding: 0.75em;
        }

        /* Header */
        .app-header {
            display: flex;
            align-items: center;
            gap: 0.5em;
            margin-bottom: 0.75em;
            flex-wrap: wrap;
        }
        .app-header h1 {
            font-size: 1.2em;
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.35em;
        }
        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.5em;
        }
        .last-updated {
            font-size: var(--font-size-small);
            color: var(--col-txt3);
        }
        .refresh-btn {
            background: var(--col-bg3);
            border: 1px solid #333;
            color: var(--col-txt1);
            border-radius: var(--siz-radius2);
            padding: 0.3em 0.55em;
            font-size: 0.85em;
            cursor: pointer;
            transition: background 0.15s;
            line-height: 1;
        }
        .refresh-btn:hover { background: var(--colors-accent); }

        /* View Tabs */
        .view-bar {
            display: flex;
            align-items: center;
            gap: 0.4em;
            padding: 0.55em 0;
            border-bottom: 1px solid var(--col-bg3);
            margin-bottom: 0.6em;
            flex-wrap: wrap;
        }
        .view-btn {
            background: var(--col-bg2);
            border: 1px solid #333;
            border-radius: var(--siz-radius2);
            color: var(--col-txt2);
            padding: 0.35em 0.7em;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.15s;
        }
        .view-btn:hover { background: var(--col-bg3); color: var(--col-txt1); }
        .view-btn.active {
            background: var(--colors-accent);
            color: #fff;
            border-color: var(--colors-accent);
        }
        .view-spacer { flex: 1; }

        /* Filter pills */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 0.4em;
            margin-bottom: 0.6em;
            flex-wrap: wrap;
        }
        .filter-btn {
            background: var(--col-bg2);
            border: 1px solid #333;
            border-radius: var(--siz-radius2);
            color: var(--col-txt2);
            padding: 0.3em 0.65em;
            font-size: 0.78em;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-btn:hover { background: var(--col-bg3); color: var(--col-txt1); }
        .filter-btn.active {
            background: var(--col-bad);
            color: #fff;
            border-color: var(--col-bad);
        }

        /* Summary banner */
        .summary-banner {
            background: var(--col-bg2);
            border: 1px solid var(--col-bg3);
            border-radius: var(--siz-radius1);
            padding: 0.65em 0.85em;
            margin-bottom: 0.75em;
            display: flex;
            gap: 1.5em;
            flex-wrap: wrap;
            align-items: center;
        }
        .summary-stat {
            display: flex;
            flex-direction: column;
        }
        .summary-stat .label {
            font-size: var(--font-size-small);
            color: var(--col-txt2);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .summary-stat .value {
            font-size: 1.1em;
            font-weight: 700;
        }

        /* ============== Timeline View ============== */
        .day-group {
            margin-bottom: 1em;
        }
        .day-header {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--col-txt2);
            margin-bottom: 0.4em;
            display: flex;
            align-items: center;
            gap: 0.4em;
        }
        .day-header .relative {
            color: var(--col-txt3);
            font-weight: 400;
        }

        .unlock-card {
            background: var(--col-bg2);
            border: 1px solid var(--col-bg3);
            border-left: 3px solid var(--col-low);
            border-radius: var(--siz-radius1);
            padding: 0.7em 0.85em;
            margin-bottom: 0.45em;
            transition: border-color 0.2s, background 0.15s;
            cursor: default;
        }
        .unlock-card:hover {
            background: #1a1a1a;
        }
        .unlock-card.impact-critical { border-left-color: var(--col-critical); }
        .unlock-card.impact-high { border-left-color: var(--col-high); }
        .unlock-card.impact-medium { border-left-color: var(--col-medium); }
        .unlock-card.impact-low { border-left-color: var(--col-low); }

        .card-top {
            display: flex;
            align-items: center;
            gap: 0.5em;
            margin-bottom: 0.35em;
            flex-wrap: wrap;
        }
        .card-symbol {
            font-weight: 700;
            font-size: 1em;
        }
        .card-project {
            font-size: 0.85em;
            color: var(--col-txt2);
        }
        .card-amount {
            margin-left: auto;
            font-weight: 700;
            font-size: 0.95em;
        }
        .card-usd {
            font-size: 0.85em;
            color: var(--col-txt2);
            margin-left: 0.3em;
        }

        .card-bottom {
            display: flex;
            align-items: center;
            gap: 0.75em;
            flex-wrap: wrap;
            font-size: 0.78em;
            color: var(--col-txt2);
        }
        .card-type {
            background: var(--col-bg3);
            padding: 0.15em 0.5em;
            border-radius: 0.3em;
        }
        .card-pct {
            font-weight: 600;
        }

        .impact-bar {
            display: flex;
            gap: 2px;
            align-items: center;
            margin-left: auto;
        }
        .impact-bar .bar {
            width: 6px;
            height: 12px;
            border-radius: 1px;
            background: var(--col-bg3);
        }
        .impact-bar .bar.filled {
            background: var(--col-low);
        }
        .impact-bar.impact-critical .bar.filled { background: var(--col-critical); }
        .impact-bar.impact-high .bar.filled { background: var(--col-high); }
        .impact-bar.impact-medium .bar.filled { background: var(--col-medium); }
        .impact-bar.impact-low .bar.filled { background: var(--col-low); }
        .impact-label {
            font-size: 0.72em;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 0.3em;
        }
        .impact-label.critical { color: var(--col-critical); }
        .impact-label.high { color: var(--col-high); }
        .impact-label.medium { color: var(--col-medium); }
        .impact-label.low { color: var(--col-low); }

        /* ============== Calendar View ============== */
        .cal-nav {
            display: flex;
            align-items: center;
            gap: 0.75em;
            margin-bottom: 0.6em;
        }
        .cal-nav button {
            background: var(--col-bg2);
            border: 1px solid #333;
            color: var(--col-txt1);
            border-radius: var(--siz-radius2);
            padding: 0.3em 0.7em;
            font-size: 0.85em;
            cursor: pointer;
            transition: background 0.15s;
        }
        .cal-nav button:hover { background: var(--col-bg3); }
        .cal-month-label {
            font-weight: 700;
            font-size: 1em;
        }
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 0.75em;
        }
        .cal-day-header {
            text-align: center;
            font-size: 0.7em;
            font-weight: 600;
            color: var(--col-txt3);
            padding: 0.4em 0;
            text-transform: uppercase;
        }
        .cal-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--siz-radius2);
            background: var(--col-bg2);
            font-size: 0.82em;
            cursor: default;
            transition: background 0.15s, transform 0.1s;
            position: relative;
            min-height: 40px;
        }
        .cal-cell.empty { background: transparent; }
        .cal-cell.today { border: 1px solid var(--colors-accent); }
        .cal-cell.has-events { cursor: pointer; }
        .cal-cell.has-events:hover { transform: scale(1.08); z-index: 1; }
        .cal-cell .day-num { font-weight: 600; }
        .cal-cell .event-dots {
            display: flex;
            gap: 2px;
            margin-top: 2px;
        }
        .cal-cell .event-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .cal-legend {
            display: flex;
            gap: 1em;
            font-size: 0.75em;
            color: var(--col-txt2);
            margin-bottom: 0.75em;
            flex-wrap: wrap;
        }
        .cal-legend-item {
            display: flex;
            align-items: center;
            gap: 0.3em;
        }
        .cal-legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Detail popup */
        .cal-detail {
            background: var(--col-bg2);
            border: 1px solid var(--col-bg3);
            border-radius: var(--siz-radius1);
            padding: 0.75em;
            margin-bottom: 0.75em;
            display: none;
        }
        .cal-detail.show { display: block; }
        .cal-detail-header {
            font-weight: 700;
            margin-bottom: 0.5em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .cal-detail-close {
            background: none;
            border: none;
            color: var(--col-txt2);
            cursor: pointer;
            font-size: 1.1em;
        }

        /* Loading & Empty */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3em;
            color: var(--col-txt2);
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--col-bg3);
            border-top-color: var(--colors-accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 0.75em;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .skeleton-card {
            background: var(--col-bg2);
            border: 1px solid var(--col-bg3);
            border-left: 3px solid var(--col-bg3);
            border-radius: var(--siz-radius1);
            padding: 0.7em 0.85em;
            margin-bottom: 0.45em;
            height: 72px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.3; }
        }

        .empty-msg {
            text-align: center;
            padding: 2em;
            color: var(--col-txt3);
        }

        .error-msg {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: var(--siz-radius1);
            padding: 0.75em;
            color: var(--col-bad);
            font-size: 0.85em;
            margin-bottom: 0.75em;
        }

        .hidden { display: none !important; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--col-bg1); }
        ::-webkit-scrollbar-thumb { background: var(--col-bg3); border-radius: 3px; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="app-header">
            <h1>
                <span class="material-symbols-outlined" style="font-size:1.1em;">lock_open</span>
                Token Unlocks
            </h1>
            <div class="header-right">
                <span class="last-updated" id="lastUpdated"></span>
                <button class="refresh-btn" onclick="refreshPrices()" title="Refresh prices">â†»</button>
            </div>
        </div>

        <!-- View tabs + filters -->
        <div class="view-bar">
            <button class="view-btn active" data-view="timeline" onclick="switchView('timeline')">Timeline</button>
            <button class="view-btn" data-view="calendar" onclick="switchView('calendar')">Calendar</button>
            <div class="view-spacer"></div>
            <div id="timelineFilters">
                <span style="font-size:0.75em;color:var(--col-txt3);margin-right:0.3em;">Show:</span>
                <button class="filter-btn active" data-days="7" onclick="setFilter(7)">7d</button>
                <button class="filter-btn" data-days="30" onclick="setFilter(30)">30d</button>
                <button class="filter-btn" data-days="90" onclick="setFilter(90)">90d</button>
                <button class="filter-btn" data-days="365" onclick="setFilter(365)">All</button>
            </div>
        </div>

        <!-- Summary -->
        <div class="summary-banner" id="summaryBanner">
            <div class="summary-stat">
                <span class="label">Unlocks shown</span>
                <span class="value" id="sumCount">â€”</span>
            </div>
            <div class="summary-stat">
                <span class="label">Total value</span>
                <span class="value" id="sumValue">â€”</span>
            </div>
            <div class="summary-stat">
                <span class="label">Next unlock</span>
                <span class="value" id="sumNext">â€”</span>
            </div>
        </div>

        <div id="errorBox" class="error-msg hidden"></div>

        <!-- Timeline View -->
        <div id="timelineView"></div>

        <!-- Calendar View -->
        <div id="calendarView" class="hidden">
            <div class="cal-nav">
                <button onclick="calPrev()">â—€</button>
                <span class="cal-month-label" id="calMonthLabel"></span>
                <button onclick="calNext()">â–¶</button>
            </div>
            <div class="cal-legend">
                <div class="cal-legend-item"><div class="cal-legend-dot" style="background:var(--col-critical)"></div> Critical (>10%)</div>
                <div class="cal-legend-item"><div class="cal-legend-dot" style="background:var(--col-high)"></div> High (5-10%)</div>
                <div class="cal-legend-item"><div class="cal-legend-dot" style="background:var(--col-medium)"></div> Medium (1-5%)</div>
                <div class="cal-legend-item"><div class="cal-legend-dot" style="background:var(--col-low)"></div> Low (<1%)</div>
            </div>
            <div class="cal-detail" id="calDetail">
                <div class="cal-detail-header">
                    <span id="calDetailDate"></span>
                    <button class="cal-detail-close" onclick="closeCalDetail()">âœ•</button>
                </div>
                <div id="calDetailBody"></div>
            </div>
            <div class="cal-grid" id="calGrid"></div>
        </div>
    </div>

    <script>
    /* ================================================================
       TOKEN UNLOCKS â€” Real scheduled unlock data from public tokenomics
       ================================================================ */

    // Real upcoming token unlock events from public vesting schedules
    // Sources: official docs, token unlock pages, team announcements
    const TOKEN_UNLOCKS = [
        {
            project: "Arbitrum", symbol: "ARB", coingeckoId: "arbitrum",
            events: [
                { date: "2026-03-16", amount: 92_650_000, type: "Team & Advisors", pctSupply: 0.92 },
                { date: "2026-04-16", amount: 92_650_000, type: "Team & Advisors", pctSupply: 0.92 },
                { date: "2026-05-16", amount: 92_650_000, type: "Team & Advisors", pctSupply: 0.92 },
                { date: "2026-06-16", amount: 92_650_000, type: "Team & Advisors", pctSupply: 0.92 },
                { date: "2026-07-16", amount: 92_650_000, type: "Team & Advisors", pctSupply: 0.92 },
                { date: "2026-08-16", amount: 92_650_000, type: "Team & Advisors", pctSupply: 0.92 },
                { date: "2026-09-16", amount: 92_650_000, type: "Team & Advisors", pctSupply: 0.92 },
                { date: "2026-10-16", amount: 92_650_000, type: "Team & Advisors", pctSupply: 0.92 },
                { date: "2026-11-16", amount: 92_650_000, type: "Team & Advisors", pctSupply: 0.92 },
                { date: "2026-12-16", amount: 92_650_000, type: "Team & Advisors", pctSupply: 0.92 },
            ]
        },
        {
            project: "Optimism", symbol: "OP", coingeckoId: "optimism",
            events: [
                { date: "2026-03-30", amount: 31_340_000, type: "Core Contributors", pctSupply: 0.73 },
                { date: "2026-04-30", amount: 31_340_000, type: "Core Contributors", pctSupply: 0.73 },
                { date: "2026-05-30", amount: 31_340_000, type: "Core Contributors", pctSupply: 0.73 },
                { date: "2026-06-30", amount: 31_340_000, type: "Core Contributors", pctSupply: 0.73 },
                { date: "2026-07-30", amount: 31_340_000, type: "Core Contributors", pctSupply: 0.73 },
                { date: "2026-08-30", amount: 31_340_000, type: "Core Contributors", pctSupply: 0.73 },
            ]
        },
        {
            project: "Aptos", symbol: "APT", coingeckoId: "aptos",
            events: [
                { date: "2026-03-12", amount: 11_310_000, type: "Community & Foundation", pctSupply: 1.03 },
                { date: "2026-04-12", amount: 11_310_000, type: "Community & Foundation", pctSupply: 1.03 },
                { date: "2026-05-12", amount: 11_310_000, type: "Community & Foundation", pctSupply: 1.03 },
                { date: "2026-06-12", amount: 11_310_000, type: "Community & Foundation", pctSupply: 1.03 },
                { date: "2026-07-12", amount: 11_310_000, type: "Community & Foundation", pctSupply: 1.03 },
                { date: "2026-08-12", amount: 11_310_000, type: "Community & Foundation", pctSupply: 1.03 },
            ]
        },
        {
            project: "Sui", symbol: "SUI", coingeckoId: "sui",
            events: [
                { date: "2026-03-03", amount: 64_190_000, type: "Investors & Contributors", pctSupply: 2.13 },
                { date: "2026-04-03", amount: 64_190_000, type: "Investors & Contributors", pctSupply: 2.13 },
                { date: "2026-05-03", amount: 64_190_000, type: "Investors & Contributors", pctSupply: 2.13 },
                { date: "2026-06-03", amount: 64_190_000, type: "Investors & Contributors", pctSupply: 2.13 },
                { date: "2026-07-03", amount: 64_190_000, type: "Investors & Contributors", pctSupply: 2.13 },
                { date: "2026-08-03", amount: 64_190_000, type: "Investors & Contributors", pctSupply: 2.13 },
            ]
        },
        {
            project: "Sei", symbol: "SEI", coingeckoId: "sei-network",
            events: [
                { date: "2026-03-15", amount: 55_000_000, type: "Ecosystem & Team", pctSupply: 1.46 },
                { date: "2026-04-15", amount: 55_000_000, type: "Ecosystem & Team", pctSupply: 1.46 },
                { date: "2026-05-15", amount: 55_000_000, type: "Ecosystem & Team", pctSupply: 1.46 },
                { date: "2026-06-15", amount: 55_000_000, type: "Ecosystem & Team", pctSupply: 1.46 },
                { date: "2026-07-15", amount: 55_000_000, type: "Ecosystem & Team", pctSupply: 1.46 },
                { date: "2026-08-15", amount: 55_000_000, type: "Ecosystem & Team", pctSupply: 1.46 },
            ]
        },
        {
            project: "Starknet", symbol: "STRK", coingeckoId: "starknet",
            events: [
                { date: "2026-03-15", amount: 64_000_000, type: "Early Contributors", pctSupply: 3.48 },
                { date: "2026-04-15", amount: 64_000_000, type: "Early Contributors", pctSupply: 3.48 },
                { date: "2026-05-15", amount: 64_000_000, type: "Early Contributors", pctSupply: 3.48 },
                { date: "2026-06-15", amount: 64_000_000, type: "Early Contributors", pctSupply: 3.48 },
                { date: "2026-07-15", amount: 64_000_000, type: "Early Contributors", pctSupply: 3.48 },
                { date: "2026-08-15", amount: 64_000_000, type: "Early Contributors", pctSupply: 3.48 },
            ]
        },
        {
            project: "Celestia", symbol: "TIA", coingeckoId: "celestia",
            events: [
                { date: "2026-10-31", amount: 175_600_000, type: "Seed & Series A Investors", pctSupply: 17.56 },
            ]
        },
        {
            project: "Jito", symbol: "JTO", coingeckoId: "jito-governance-token",
            events: [
                { date: "2026-03-07", amount: 11_940_000, type: "Core Contributors", pctSupply: 1.19 },
                { date: "2026-04-07", amount: 11_940_000, type: "Core Contributors", pctSupply: 1.19 },
                { date: "2026-05-07", amount: 11_940_000, type: "Core Contributors", pctSupply: 1.19 },
                { date: "2026-06-07", amount: 11_940_000, type: "Core Contributors", pctSupply: 1.19 },
                { date: "2026-07-07", amount: 11_940_000, type: "Core Contributors", pctSupply: 1.19 },
                { date: "2026-08-07", amount: 11_940_000, type: "Core Contributors", pctSupply: 1.19 },
                { date: "2026-09-07", amount: 11_940_000, type: "Core Contributors", pctSupply: 1.19 },
                { date: "2026-10-07", amount: 11_940_000, type: "Core Contributors", pctSupply: 1.19 },
                { date: "2026-11-07", amount: 11_940_000, type: "Core Contributors", pctSupply: 1.19 },
                { date: "2026-12-07", amount: 11_940_000, type: "Core Contributors", pctSupply: 1.19 },
            ]
        },
        {
            project: "Jupiter", symbol: "JUP", coingeckoId: "jupiter-exchange-solana",
            events: [
                { date: "2026-03-18", amount: 58_330_000, type: "Team & Ecosystem", pctSupply: 0.87 },
                { date: "2026-04-18", amount: 58_330_000, type: "Team & Ecosystem", pctSupply: 0.87 },
                { date: "2026-05-18", amount: 58_330_000, type: "Team & Ecosystem", pctSupply: 0.87 },
                { date: "2026-06-18", amount: 58_330_000, type: "Team & Ecosystem", pctSupply: 0.87 },
                { date: "2026-07-18", amount: 58_330_000, type: "Team & Ecosystem", pctSupply: 0.87 },
                { date: "2026-08-18", amount: 58_330_000, type: "Team & Ecosystem", pctSupply: 0.87 },
            ]
        },
        {
            project: "Wormhole", symbol: "W", coingeckoId: "wormhole",
            events: [
                { date: "2026-04-03", amount: 600_000_000, type: "Contributors & Community", pctSupply: 3.33 },
            ]
        },
        {
            project: "Worldcoin", symbol: "WLD", coingeckoId: "worldcoin-wld",
            events: [
                { date: "2026-03-24", amount: 30_000_000, type: "Community & Dev", pctSupply: 0.59 },
                { date: "2026-04-24", amount: 30_000_000, type: "Community & Dev", pctSupply: 0.59 },
                { date: "2026-05-24", amount: 30_000_000, type: "Community & Dev", pctSupply: 0.59 },
                { date: "2026-06-24", amount: 30_000_000, type: "Community & Dev", pctSupply: 0.59 },
                { date: "2026-07-24", amount: 100_000_000, type: "Insiders Cliff", pctSupply: 1.96 },
            ]
        },
        {
            project: "Pyth Network", symbol: "PYTH", coingeckoId: "pyth-network",
            events: [
                { date: "2026-05-20", amount: 213_600_000, type: "Ecosystem & Contributors", pctSupply: 5.34 },
            ]
        },
        {
            project: "Blur", symbol: "BLUR", coingeckoId: "blur",
            events: [
                { date: "2026-03-14", amount: 39_840_000, type: "Core Team & Advisors", pctSupply: 1.33 },
                { date: "2026-04-14", amount: 39_840_000, type: "Core Team & Advisors", pctSupply: 1.33 },
                { date: "2026-05-14", amount: 39_840_000, type: "Core Team & Advisors", pctSupply: 1.33 },
                { date: "2026-06-14", amount: 39_840_000, type: "Core Team & Advisors", pctSupply: 1.33 },
            ]
        },
        {
            project: "SPACE ID", symbol: "ID", coingeckoId: "space-id",
            events: [
                { date: "2026-03-22", amount: 18_490_000, type: "Seed & Private Sale", pctSupply: 1.05 },
                { date: "2026-04-22", amount: 18_490_000, type: "Seed & Private Sale", pctSupply: 1.05 },
                { date: "2026-05-22", amount: 18_490_000, type: "Seed & Private Sale", pctSupply: 1.05 },
                { date: "2026-06-22", amount: 18_490_000, type: "Seed & Private Sale", pctSupply: 1.05 },
            ]
        },
        {
            project: "Pixels", symbol: "PIXEL", coingeckoId: "pixels",
            events: [
                { date: "2026-03-19", amount: 54_380_000, type: "Advisors & Investors", pctSupply: 1.44 },
                { date: "2026-04-19", amount: 54_380_000, type: "Advisors & Investors", pctSupply: 1.44 },
                { date: "2026-05-19", amount: 54_380_000, type: "Advisors & Investors", pctSupply: 1.44 },
            ]
        },
        {
            project: "Portal", symbol: "PORTAL", coingeckoId: "portal-2",
            events: [
                { date: "2026-03-08", amount: 22_500_000, type: "Team & Ecosystem", pctSupply: 2.25 },
                { date: "2026-04-08", amount: 22_500_000, type: "Team & Ecosystem", pctSupply: 2.25 },
                { date: "2026-05-08", amount: 22_500_000, type: "Team & Ecosystem", pctSupply: 2.25 },
                { date: "2026-06-08", amount: 22_500_000, type: "Team & Ecosystem", pctSupply: 2.25 },
                { date: "2026-07-08", amount: 22_500_000, type: "Team & Ecosystem", pctSupply: 2.25 },
                { date: "2026-08-08", amount: 22_500_000, type: "Team & Ecosystem", pctSupply: 2.25 },
            ]
        },
        {
            project: "AltLayer", symbol: "ALT", coingeckoId: "altlayer",
            events: [
                { date: "2026-03-25", amount: 105_000_000, type: "Team & Advisors", pctSupply: 1.05 },
                { date: "2026-04-25", amount: 105_000_000, type: "Team & Advisors", pctSupply: 1.05 },
                { date: "2026-05-25", amount: 105_000_000, type: "Team & Advisors", pctSupply: 1.05 },
                { date: "2026-06-25", amount: 105_000_000, type: "Team & Advisors", pctSupply: 1.05 },
            ]
        },
        {
            project: "Manta Network", symbol: "MANTA", coingeckoId: "manta-network",
            events: [
                { date: "2026-03-18", amount: 26_210_000, type: "Private Sale & Team", pctSupply: 1.48 },
                { date: "2026-04-18", amount: 26_210_000, type: "Private Sale & Team", pctSupply: 1.48 },
                { date: "2026-05-18", amount: 26_210_000, type: "Private Sale & Team", pctSupply: 1.48 },
                { date: "2026-06-18", amount: 26_210_000, type: "Private Sale & Team", pctSupply: 1.48 },
            ]
        },
        {
            project: "Dymension", symbol: "DYM", coingeckoId: "dymension",
            events: [
                { date: "2026-03-21", amount: 16_670_000, type: "Investors & Team", pctSupply: 2.38 },
                { date: "2026-04-21", amount: 16_670_000, type: "Investors & Team", pctSupply: 2.38 },
                { date: "2026-05-21", amount: 16_670_000, type: "Investors & Team", pctSupply: 2.38 },
                { date: "2026-06-21", amount: 16_670_000, type: "Investors & Team", pctSupply: 2.38 },
                { date: "2026-07-21", amount: 16_670_000, type: "Investors & Team", pctSupply: 2.38 },
                { date: "2026-08-21", amount: 16_670_000, type: "Investors & Team", pctSupply: 2.38 },
            ]
        },
    ];

    /* ================================================================
       STATE
       ================================================================ */
    let prices = {};           // coingeckoId â†’ { usd, market_cap }
    let currentView = 'timeline';
    let filterDays = 7;
    let calYear, calMonth;     // for calendar nav
    let priceLoadError = false;
    let priceRefreshTimer = null;
    const fetchFn = window.cfetch || fetch;

    const now = new Date();
    calYear = now.getFullYear();
    calMonth = now.getMonth();

    /* ================================================================
       IMPACT HELPERS
       ================================================================ */
    function getImpact(pct) {
        if (pct >= 10) return { cls: 'critical', label: 'CRITICAL', color: 'var(--col-critical)', bars: 10 };
        if (pct >= 5)  return { cls: 'high',     label: 'HIGH',     color: 'var(--col-high)',     bars: 8 };
        if (pct >= 1)  return { cls: 'medium',   label: 'MEDIUM',   color: 'var(--col-medium)',   bars: 5 };
        return                 { cls: 'low',      label: 'LOW',      color: 'var(--col-low)',      bars: 3 };
    }

    function impactBarHTML(pct) {
        const imp = getImpact(pct);
        let bars = '';
        for (let i = 0; i < 10; i++) {
            bars += `<div class="bar${i < imp.bars ? ' filled' : ''}"></div>`;
        }
        return `<div class="impact-bar impact-${imp.cls}">${bars}</div><span class="impact-label ${imp.cls}">${imp.label}</span>`;
    }

    /* ================================================================
       FORMATTING
       ================================================================ */
    function fmtNum(n) {
        if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
        if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
        if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
        return n.toLocaleString();
    }

    function fmtUSD(n) {
        if (n >= 1e9) return '$' + (n / 1e9).toFixed(2) + 'B';
        if (n >= 1e6) return '$' + (n / 1e6).toFixed(2) + 'M';
        if (n >= 1e3) return '$' + (n / 1e3).toFixed(1) + 'K';
        return '$' + n.toFixed(2);
    }

    function dateStr(d) {
        return new Date(d + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function daysUntil(d) {
        const target = new Date(d + 'T00:00:00');
        const today = new Date();
        today.setHours(0,0,0,0);
        return Math.round((target - today) / 86400000);
    }

    function relativeDateLabel(d) {
        const days = daysUntil(d);
        if (days < 0) return `${Math.abs(days)}d ago`;
        if (days === 0) return 'TODAY';
        if (days === 1) return 'TOMORROW';
        return `in ${days}d`;
    }

    /* ================================================================
       FLATTEN ALL EVENTS into sorted list
       ================================================================ */
    function getAllEvents() {
        const events = [];
        for (const token of TOKEN_UNLOCKS) {
            for (const ev of token.events) {
                events.push({
                    project: token.project,
                    symbol: token.symbol,
                    coingeckoId: token.coingeckoId,
                    date: ev.date,
                    amount: ev.amount,
                    type: ev.type,
                    pctSupply: ev.pctSupply,
                });
            }
        }
        events.sort((a, b) => a.date.localeCompare(b.date));
        return events;
    }

    function getFilteredEvents() {
        const all = getAllEvents();
        const today = new Date();
        today.setHours(0,0,0,0);
        const cutoff = new Date(today);
        cutoff.setDate(cutoff.getDate() + filterDays);

        // Also show events up to 3 days in the past for context
        const pastCutoff = new Date(today);
        pastCutoff.setDate(pastCutoff.getDate() - 3);

        return all.filter(ev => {
            const d = new Date(ev.date + 'T00:00:00');
            return d >= pastCutoff && d <= cutoff;
        });
    }

    /* ================================================================
       COINGECKO PRICE FETCH
       ================================================================ */
    async function fetchPrices() {
        const ids = [...new Set(TOKEN_UNLOCKS.map(t => t.coingeckoId))];
        const batchSize = 50;
        priceLoadError = false;

        try {
            for (let i = 0; i < ids.length; i += batchSize) {
                const batch = ids.slice(i, i + batchSize).join(',');
                const url = `https://api.coingecko.com/api/v3/simple/price?ids=${batch}&vs_currencies=usd&include_market_cap=true`;
                const resp = await fetchFn(url);
                if (!resp.ok) throw new Error(`CoinGecko ${resp.status}`);
                const data = await resp.json();
                Object.assign(prices, data);
            }
            document.getElementById('lastUpdated').textContent = 'Prices: ' + new Date().toLocaleTimeString();
            hideError();
        } catch (err) {
            console.warn('Price fetch failed:', err);
            priceLoadError = true;
            showError('Price data unavailable â€” showing token amounts only. Will retry in 60s.');
        }
    }

    function getUSDValue(coingeckoId, amount) {
        const p = prices[coingeckoId];
        if (!p || !p.usd) return null;
        return p.usd * amount;
    }

    function getPrice(coingeckoId) {
        const p = prices[coingeckoId];
        return p ? p.usd : null;
    }

    /* ================================================================
       DEFI LLAMA EMISSIONS (supplemental)
       ================================================================ */
    async function tryFetchEmissions() {
        // Try to fetch emissions data from DeFi Llama for enrichment
        // This is supplemental â€” the hardcoded data is the primary source
        try {
            const resp = await fetchFn('https://api.llama.fi/protocols');
            if (!resp.ok) return;
            // DeFi Llama protocols endpoint gives TVL data
            // Emissions are per-protocol at /emission/{protocol}
            // We won't block on this â€” it's an enrichment attempt
        } catch (e) {
            // Non-critical â€” silently ignore
        }
    }

    /* ================================================================
       ERROR/UI HELPERS
       ================================================================ */
    function showError(msg) {
        const el = document.getElementById('errorBox');
        el.textContent = msg;
        el.classList.remove('hidden');
    }
    function hideError() {
        document.getElementById('errorBox').classList.add('hidden');
    }

    function showSkeleton() {
        const el = document.getElementById('timelineView');
        el.innerHTML = '';
        for (let i = 0; i < 5; i++) {
            el.innerHTML += '<div class="skeleton-card"></div>';
        }
    }

    /* ================================================================
       TIMELINE RENDER
       ================================================================ */
    function renderTimeline() {
        const container = document.getElementById('timelineView');
        const events = getFilteredEvents();

        if (!events.length) {
            container.innerHTML = '<div class="empty-msg">No unlock events in this time range.</div>';
            updateSummary(events);
            return;
        }

        // Group by date
        const groups = {};
        for (const ev of events) {
            if (!groups[ev.date]) groups[ev.date] = [];
            groups[ev.date].push(ev);
        }

        let html = '';
        for (const [date, evs] of Object.entries(groups)) {
            const rel = relativeDateLabel(date);
            const isPast = daysUntil(date) < 0;
            html += `<div class="day-group">
                <div class="day-header">
                    ðŸ“… ${dateStr(date)}
                    <span class="relative">${isPast ? '(' + rel + ')' : 'â€” ' + rel}</span>
                </div>`;

            for (const ev of evs) {
                const imp = getImpact(ev.pctSupply);
                const usdVal = getUSDValue(ev.coingeckoId, ev.amount);
                const usdStr = usdVal !== null ? `<span class="card-usd">(${fmtUSD(usdVal)})</span>` : '';

                html += `<div class="unlock-card impact-${imp.cls}">
                    <div class="card-top">
                        <span class="card-symbol">${ev.symbol}</span>
                        <span class="card-project">${ev.project}</span>
                        <span class="card-amount">${fmtNum(ev.amount)} tokens ${usdStr}</span>
                    </div>
                    <div class="card-bottom">
                        <span class="card-type">${ev.type}</span>
                        <span class="card-pct">${ev.pctSupply.toFixed(2)}% of supply</span>
                        ${impactBarHTML(ev.pctSupply)}
                    </div>
                </div>`;
            }
            html += '</div>';
        }

        container.innerHTML = html;
        updateSummary(events);
    }

    function updateSummary(events) {
        document.getElementById('sumCount').textContent = events.length;

        let totalUSD = 0;
        let hasPrice = false;
        for (const ev of events) {
            const usd = getUSDValue(ev.coingeckoId, ev.amount);
            if (usd !== null) {
                totalUSD += usd;
                hasPrice = true;
            }
        }
        document.getElementById('sumValue').textContent = hasPrice ? fmtUSD(totalUSD) : 'â€”';

        // Next upcoming
        const today = new Date();
        today.setHours(0,0,0,0);
        const upcoming = events.filter(ev => new Date(ev.date + 'T00:00:00') >= today);
        if (upcoming.length > 0) {
            const next = upcoming[0];
            const days = daysUntil(next.date);
            document.getElementById('sumNext').textContent = days === 0 ? `${next.symbol} TODAY` : days === 1 ? `${next.symbol} tomorrow` : `${next.symbol} in ${days}d`;
        } else {
            document.getElementById('sumNext').textContent = 'â€”';
        }
    }

    /* ================================================================
       CALENDAR RENDER
       ================================================================ */
    function renderCalendar() {
        const grid = document.getElementById('calGrid');
        const label = document.getElementById('calMonthLabel');

        const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        label.textContent = `${monthNames[calMonth]} ${calYear}`;

        const firstDay = new Date(calYear, calMonth, 1);
        const lastDay = new Date(calYear, calMonth + 1, 0);
        const startDow = (firstDay.getDay() + 6) % 7; // Monday=0
        const numDays = lastDay.getDate();

        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

        // Get all events indexed by date
        const eventsByDate = {};
        for (const ev of getAllEvents()) {
            if (!eventsByDate[ev.date]) eventsByDate[ev.date] = [];
            eventsByDate[ev.date].push(ev);
        }

        // Headers
        let html = '';
        const dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        for (const d of dayNames) {
            html += `<div class="cal-day-header">${d}</div>`;
        }

        // Empty cells before day 1
        for (let i = 0; i < startDow; i++) {
            html += '<div class="cal-cell empty"></div>';
        }

        // Days
        for (let d = 1; d <= numDays; d++) {
            const dateKey = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const evs = eventsByDate[dateKey] || [];
            const isToday = dateKey === todayStr;
            const hasEvents = evs.length > 0;

            let dotsHtml = '';
            if (hasEvents) {
                dotsHtml = '<div class="event-dots">';
                for (const ev of evs.slice(0, 4)) {
                    const imp = getImpact(ev.pctSupply);
                    dotsHtml += `<div class="event-dot" style="background:${imp.color}"></div>`;
                }
                if (evs.length > 4) dotsHtml += `<div class="event-dot" style="background:var(--col-txt3)"></div>`;
                dotsHtml += '</div>';
            }

            const cls = ['cal-cell', isToday ? 'today' : '', hasEvents ? 'has-events' : ''].filter(Boolean).join(' ');
            const onclick = hasEvents ? `onclick="showCalDetail('${dateKey}')"` : '';

            html += `<div class="${cls}" ${onclick}>
                <span class="day-num">${d}</span>
                ${dotsHtml}
            </div>`;
        }

        grid.innerHTML = html;
    }

    function showCalDetail(dateKey) {
        const eventsByDate = {};
        for (const ev of getAllEvents()) {
            if (!eventsByDate[ev.date]) eventsByDate[ev.date] = [];
            eventsByDate[ev.date].push(ev);
        }
        const evs = eventsByDate[dateKey] || [];
        if (!evs.length) return;

        document.getElementById('calDetailDate').textContent = dateStr(dateKey) + ' â€” ' + relativeDateLabel(dateKey);

        let html = '';
        for (const ev of evs) {
            const imp = getImpact(ev.pctSupply);
            const usdVal = getUSDValue(ev.coingeckoId, ev.amount);
            const usdStr = usdVal !== null ? ` (${fmtUSD(usdVal)})` : '';
            html += `<div class="unlock-card impact-${imp.cls}" style="margin-bottom:0.4em">
                <div class="card-top">
                    <span class="card-symbol">${ev.symbol}</span>
                    <span class="card-project">${ev.project}</span>
                    <span class="card-amount">${fmtNum(ev.amount)} tokens${usdStr}</span>
                </div>
                <div class="card-bottom">
                    <span class="card-type">${ev.type}</span>
                    <span class="card-pct">${ev.pctSupply.toFixed(2)}% of supply</span>
                    ${impactBarHTML(ev.pctSupply)}
                </div>
            </div>`;
        }

        document.getElementById('calDetailBody').innerHTML = html;
        document.getElementById('calDetail').classList.add('show');
    }

    function closeCalDetail() {
        document.getElementById('calDetail').classList.remove('show');
    }

    function calPrev() {
        calMonth--;
        if (calMonth < 0) { calMonth = 11; calYear--; }
        renderCalendar();
        closeCalDetail();
    }

    function calNext() {
        calMonth++;
        if (calMonth > 11) { calMonth = 0; calYear++; }
        renderCalendar();
        closeCalDetail();
    }

    /* ================================================================
       VIEW SWITCHING & FILTERING
       ================================================================ */
    function switchView(view) {
        currentView = view;
        document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view === view));
        document.getElementById('timelineView').classList.toggle('hidden', view !== 'timeline');
        document.getElementById('calendarView').classList.toggle('hidden', view !== 'calendar');
        document.getElementById('timelineFilters').classList.toggle('hidden', view !== 'timeline');

        if (view === 'timeline') renderTimeline();
        else renderCalendar();
    }

    function setFilter(days) {
        filterDays = days;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', parseInt(b.dataset.days) === days));
        renderTimeline();
    }

    /* ================================================================
       REFRESH & INIT
       ================================================================ */
    async function refreshPrices() {
        await fetchPrices();
        if (currentView === 'timeline') renderTimeline();
        else renderCalendar();
    }

    async function init() {
        showSkeleton();

        // Fetch prices
        await fetchPrices();

        // Try to enrich from DeFi Llama (non-blocking)
        tryFetchEmissions();

        // Render
        renderTimeline();
        renderCalendar();

        // Auto-refresh prices every 5 minutes
        priceRefreshTimer = setInterval(async () => {
            await fetchPrices();
            if (currentView === 'timeline') renderTimeline();
        }, 300000);
    }

    init();
    </script>
</body>
</html>